# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AUTOMAÃ‡Ã•ES: NOTIFICAÃ‡Ã•ES INTELIGENTES PISCINA SOLAR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Sistema de alertas proativo baseado em:
# - ImportaÃ§Ã£o alta durante perÃ­odo solar
# - Tempo filtragem crÃ­tico
# - CondiÃ§Ãµes instÃ¡veis
# - Oportunidades de otimizaÃ§Ã£o
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

automation:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âš ï¸ ALERTA: ImportaÃ§Ã£o Alta com Bomba Ligada
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: piscina_solar_alert_high_import
    alias: "ğŸŠ Piscina Solar - Alerta ImportaÃ§Ã£o Alta"
    description: >
      Notifica quando bomba estÃ¡ ligada mas sistema importa >1000W
      durante perÃ­odo diurno (provÃ¡vel problema: nuvens ou consumo alto)
    
    trigger:
      - platform: numeric_state
        entity_id: sensor.emoncms_import_export
        above: 1000
        for:
          minutes: 3
          
    condition:
      - condition: state
        entity_id: switch.bomba_piscina_switch_0
        state: 'on'
        
      - condition: sun
        after: sunrise
        after_offset: "01:00:00"
        before: sunset
        before_offset: "-01:00:00"
        
      - condition: or
        conditions:
          - condition: state
            entity_id: input_select.piscina_notification_level
            state: "Alertas + Info"
          - condition: state
            entity_id: input_select.piscina_notification_level
            state: "Todas"
          - condition: state
            entity_id: input_select.piscina_notification_level
            state: "SÃ³ Alertas"
            
    action:
      - service: notify.mobile_app_iphone_de_guilherme  # Ajustar para teu device
        data:
          title: "âš ï¸ Piscina: ImportaÃ§Ã£o Alta"
          message: >-
            Bomba ligada mas a importar {{ states('sensor.emoncms_import_export')|round(0) }}W!
            
            ğŸŒ PV: {{ states('sensor.emoncms_solar')|round(0) }}W
            ğŸ  Casa: {{ states('sensor.emoncms_192_168_1_250_use_no_pool_pump')|round(0) }}W
            â±ï¸ Ligada hÃ¡: {{ relative_time(states.switch.bomba_piscina_switch_0.last_changed) }}
            
            Verificar:
            - Nuvens passageiras?
            - Consumo casa anormalmente alto?
          data:
            actions:
              - action: "PUMP_OFF_NOW"
                title: "âŒ Desligar Bomba"
              - action: "PUMP_IGNORE_1H"
                title: "â° Ignorar 1h"
                
      - service: system_log.write
        data:
          message: "âš ï¸ Alerta enviado: ImportaÃ§Ã£o alta ({{ states('sensor.emoncms_import_export')|round(0) }}W) com bomba ligada"
          level: warning
          logger: automations.piscina_solar
          
    mode: single
    max_exceeded: silent
    
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â° ALERTA: Tempo Filtragem CrÃ­tico
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: piscina_solar_alert_low_time
    alias: "ğŸŠ Piscina Solar - Alerta Tempo CrÃ­tico"
    description: >
      Avisa quando restam <30min de filtragem e jÃ¡ passa das 16h
      (pouco tempo + sol a acabar = risco nÃ£o completar filtragem)
    
    trigger:
      - platform: numeric_state
        entity_id: sensor.pool_pump_remaining_time
        below: 30
        
    condition:
      - condition: state
        entity_id: switch.bomba_piscina_switch_0
        state: 'off'
        
      - condition: time
        after: "16:00:00"
        before: "21:00:00"
        
      - condition: or
        conditions:
          - condition: state
            entity_id: input_select.piscina_notification_level
            state: "Alertas + Info"
          - condition: state
            entity_id: input_select.piscina_notification_level
            state: "Todas"
          - condition: state
            entity_id: input_select.piscina_notification_level
            state: "SÃ³ Alertas"
            
    action:
      - service: notify.mobile_app_iphone_de_guilherme
        data:
          title: "â° Piscina: Pouco Tempo!"
          message: >-
            Restam apenas {{ states('sensor.pool_pump_remaining_time') }}min de filtragem
            e sol vai-se pÃ´r em breve ({{ state_attr('sun.sun', 'next_setting')|timestamp_custom('%H:%M') }}).
            
            â˜€ï¸ Solar atual: {{ states('sensor.emoncms_solar')|round(0) }}W
            ğŸ“Š Excedente: {{ states('sensor.emoncms_export_power_positive')|round(0) }}W
            
            ğŸ’¡ RecomendaÃ§Ã£o:
            {% if states('sensor.emoncms_export_power_positive')|float(0) > 500 %}
            HÃ¡ excedente disponÃ­vel! Liga manualmente.
            {% else %}
            Pouco excedente. Considerar vazio noturno.
            {% endif %}
          data:
            actions:
              - action: "PUMP_ON_NOW"
                title: "âœ… Ligar Agora"
              - action: "PUMP_SCHEDULE_NIGHT"
                title: "ğŸŒ™ Agendar Noite"
                
      - service: system_log.write
        data:
          message: "â° Alerta enviado: Tempo crÃ­tico ({{ states('sensor.pool_pump_remaining_time') }}min restantes)"
          level: warning
          logger: automations.piscina_solar
          
    mode: single
    max_exceeded: silent
    
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ’¡ INFO: Oportunidade de Excedente Alto
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: piscina_solar_info_high_excess
    alias: "ğŸŠ Piscina Solar - Info Excedente Alto"
    description: >
      Notifica quando hÃ¡ excedente >2000W disponÃ­vel
      mas bomba estÃ¡ desligada (oportunidade perdida)
    
    trigger:
      - platform: numeric_state
        entity_id: sensor.emoncms_export_power_positive
        above: 2000
        for:
          minutes: 5
          
    condition:
      - condition: state
        entity_id: switch.bomba_piscina_switch_0
        state: 'off'
        
      - condition: numeric_state
        entity_id: sensor.pool_pump_remaining_time
        above: 10
        
      - condition: sun
        after: sunrise
        after_offset: "01:00:00"
        before: sunset
        before_offset: "-02:00:00"
        
      - condition: or
        conditions:
          - condition: state
            entity_id: input_select.piscina_notification_level
            state: "Alertas + Info"
          - condition: state
            entity_id: input_select.piscina_notification_level
            state: "Todas"
            
    action:
      - service: notify.mobile_app_iphone_de_guilherme
        data:
          title: "ğŸ’¡ Piscina: Excedente Alto!"
          message: >-
            HÃ¡ {{ states('sensor.emoncms_export_power_positive')|round(0) }}W de excedente disponÃ­vel!
            
            ğŸŒ Solar: {{ states('sensor.emoncms_solar')|round(0) }}W
            ğŸ  Casa: {{ states('sensor.emoncms_192_168_1_250_use_no_pool_pump')|round(0) }}W
            â³ Faltam: {{ states('sensor.pool_pump_remaining_time') }}min
            
            ğŸ’° Energia "grÃ¡tis" disponÃ­vel!
          data:
            actions:
              - action: "PUMP_ON_NOW"
                title: "âœ… Aproveitar!"
                
      - service: system_log.write
        data:
          message: "ğŸ’¡ Info enviada: Excedente alto ({{ states('sensor.emoncms_export_power_positive')|round(0) }}W) disponÃ­vel"
          level: info
          logger: automations.piscina_solar
          
    mode: single
    max_exceeded: silent
    
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸŒ¤ï¸ INFO: CondiÃ§Ãµes InstÃ¡veis
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: piscina_solar_info_unstable
    alias: "ğŸŠ Piscina Solar - Info CondiÃ§Ãµes InstÃ¡veis"
    description: >
      Avisa quando condiÃ§Ãµes estÃ£o muito instÃ¡veis
      (indicador estabilidade >30%)
    
    trigger:
      - platform: numeric_state
        entity_id: sensor.solar_stability_indicator
        above: 30
        for:
          minutes: 5
          
    condition:
      - condition: sun
        after: sunrise
        before: sunset
        
      - condition: state
        entity_id: input_select.piscina_notification_level
        state: "Todas"
        
    action:
      - service: notify.mobile_app_iphone_de_guilherme
        data:
          title: "ğŸŒ¤ï¸ Piscina: CondiÃ§Ãµes InstÃ¡veis"
          message: >-
            ProduÃ§Ã£o solar muito variÃ¡vel ({{ states('sensor.solar_stability_indicator')|round(0) }}% variaÃ§Ã£o).
            
            Provavelmente nuvens passageiras.
            
            ğŸ¤– Blueprint vai ser mais conservador automaticamente.
            
            {{ state_attr('sensor.solar_stability_indicator', 'recommendation') }}
          data:
            tag: "piscina_unstable"
            
      - service: system_log.write
        data:
          message: "ğŸŒ¤ï¸ Info enviada: CondiÃ§Ãµes instÃ¡veis ({{ states('sensor.solar_stability_indicator')|round(0) }}%)"
          level: info
          logger: automations.piscina_solar
          
    mode: single
    max_exceeded: silent
    
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ¯ AÃ‡Ã•ES DOS BOTÃ•ES DE NOTIFICAÃ‡ÃƒO
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: piscina_solar_notification_actions
    alias: "ğŸŠ Piscina Solar - AÃ§Ãµes NotificaÃ§Ãµes"
    description: Processa aÃ§Ãµes dos botÃµes das notificaÃ§Ãµes
    
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "PUMP_OFF_NOW"
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "PUMP_ON_NOW"
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "PUMP_IGNORE_1H"
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "PUMP_SCHEDULE_NIGHT"
          
    action:
      - choose:
          # Desligar bomba
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.action == 'PUMP_OFF_NOW' }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: switch.bomba_piscina_switch_0
              - service: notify.mobile_app_iphone_de_guilherme
                data:
                  message: "âœ… Bomba desligada"
                  
          # Ligar bomba
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.action == 'PUMP_ON_NOW' }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: switch.bomba_piscina_switch_0
              - service: notify.mobile_app_iphone_de_guilherme
                data:
                  message: "âœ… Bomba ligada"
                  
          # Ignorar 1h (desabilita automaÃ§Ã£o temporariamente)
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.action == 'PUMP_IGNORE_1H' }}"
            sequence:
              - service: automation.turn_off
                target:
                  entity_id: automation.piscina_solar_alert_high_import
              - delay:
                  hours: 1
              - service: automation.turn_on
                target:
                  entity_id: automation.piscina_solar_alert_high_import
              - service: notify.mobile_app_iphone_de_guilherme
                data:
                  message: "â° Alertas pausados por 1h"
                  
    mode: queued
    max: 10
