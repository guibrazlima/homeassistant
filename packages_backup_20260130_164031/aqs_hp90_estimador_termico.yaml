#############################################
# üì¶ Package: AQS - HP90 Estimador T√©rmico Solar
# üéØ Objetivo: Estimar energia t√©rmica produzida por 50 tubos Varisol HP90
# üìÇ Localiza√ß√£o: /config/packages/aqs_hp90_estimador_termico.yaml
# üîó Depend√™ncias:
#    - aqs_common.yaml (dhw_volume_l, aqs_target_temp)
#    - Forecast.Solar (1000 Wp, Tilt=20¬∞, Azimuth=174¬∞)
#    - sensor.power_production_now_tubos_hp90
#    - sensor.energy_production_today_tubos_hp90
# üìÖ √öltima atualiza√ß√£o: 2025-11-11
#############################################

input_number:
  solar_hp_n_tubos:
    name: "HP90 ‚Äî N¬∫ de tubos"
    min: 1
    max: 120
    step: 1
    initial: 50
    icon: mdi:counter

  solar_hp_area_tubo_m2:
    name: "HP90 ‚Äî √Årea por tubo (m¬≤)"
    min: 0.05
    max: 0.20
    step: 0.001
    initial: 0.105
    unit_of_measurement: "m¬≤"
    icon: mdi:ruler-square

  solar_hp_eta_sistema:
    name: "HP90 ‚Äî Rendimento t√©rmico (0‚Äì1)"
    min: 0.30
    max: 0.85
    step: 0.01
    initial: 0.55
    icon: mdi:percent

  # NOTA: dhw_volume_l e aqs_target_temp agora est√£o em aqs_common.yaml

  aqs_hp90_kwh_factor:
    name: "AQS HP90 ‚Äî Fator kWh t√©rmicos"

    min: 0.5
    max: 2.0
    step: 0.05
    unit_of_measurement: "√ó"
    initial: 1.0
    icon: mdi:tune-variant

  aqs_min_liters_window:
    name: "AQS ‚Äî M√≠n. litros/1h p/ janela boa"
    min: 20
    max: 200
    step: 5
    unit_of_measurement: "L"
    initial: 80
    icon: mdi:shower-head

template:
  - sensor:
      # =================== BLOCO BASE HP90 (j√° existente) ===================
      - name: "HP90 ‚Äî √Årea total (m¬≤)"
        unique_id: hp90_area_total_m2
        unit_of_measurement: "m¬≤"
        icon: mdi:selection
        attributes:
          description: "√Årea total √∫til de abertura dos tubos: N¬∫ de tubos √ó √°rea por tubo."
          inputs: "N_tubos=input_number.solar_hp_n_tubos, area_tubo=input_number.solar_hp_area_tubo_m2"
        state: >
          {% set n  = states('input_number.solar_hp_n_tubos')|float(50) %}
          {% set at = states('input_number.solar_hp_area_tubo_m2')|float(0.105) %}
          {{ (n * at) | round(3) }}

      - name: "HP90 ‚Äî Pot√™ncia t√©rmica (kW)"
        unique_id: hp90_pot_termica_kw
        unit_of_measurement: "kW"
        icon: mdi:solar-power
        attributes:
          description: "Pot√™ncia t√©rmica estimada no instante: (power_now/1000) √ó √Årea √ó Rendimento."
          inputs: "power_now=sensor.power_production_now_tubos_hp90, area_total=sensor.hp90_area_total_m2, eta=input_number.solar_hp_eta_sistema"
        state: >
          {% set p_fs_kw = (states('sensor.power_production_now_tubos_hp90')|float(0)) / 1000 %}
          {% set A       = states('sensor.hp90_area_total_m2')|float(0) %}
          {% set eta     = states('input_number.solar_hp_eta_sistema')|float(0.55) %}
          {{ (p_fs_kw * A * eta) | round(2) }}

      - name: "HP90 ‚Äî Energia t√©rmica do dia (kWh)"
        unique_id: hp90_energia_termica_dia_kwh
        unit_of_measurement: "kWh"
        icon: mdi:chart-areaspline
        attributes:
          description: "Energia t√©rmica di√°ria estimada: energy_today_proxy √ó √Årea √ó Rendimento."
          inputs: "energy_today=sensor.energy_production_today_tubos_hp90, area_total=sensor.hp90_area_total_m2, eta=input_number.solar_hp_eta_sistema"
        state: >
          {% set Hproxy = states('sensor.energy_production_today_tubos_hp90')|float(0) %}
          {% set A      = states('sensor.hp90_area_total_m2')|float(0) %}
          {% set eta    = states('input_number.solar_hp_eta_sistema')|float(0.55) %}
          {{ (Hproxy * A * eta) | round(2) }}

      - name: "HP90 ‚Äî ŒîT previsto hoje (¬∞C)"
        unique_id: hp90_deltaT_previsto_hoje_c
        unit_of_measurement: "¬∞C"
        icon: mdi:thermometer-lines
        attributes:
          description: "Eleva√ß√£o de temperatura do dep√≥sito assumindo mistura homog√©nea."
          formula: "ŒîT = E_kWh / (V_L √ó 4.18 kJ/kgK / 3600)"
          inputs: "E=sensor.hp90_energia_termica_do_dia_kwh, V=input_number.dhw_volume_l"
        state: >
          {% set E = states('sensor.hp90_energia_termica_do_dia_kwh')|float(0) %}
          {% set V = states('input_number.dhw_volume_l')|float(500) %}
          {% set kWh_per_C = (V * 4.18 / 3600) %}
          {{ (E / max(kWh_per_C, 0.001)) | round(1) }}

      - name: "HP90 ‚Äî Energia l√≠quida ap√≥s perdas (kWh)"
        unique_id: hp90_energia_liquida_kwh
        unit_of_measurement: "kWh"
        icon: mdi:fire-circle
        attributes:
          description: "Energia di√°ria ap√≥s perdas do dep√≥sito (se sensor de perdas existir)."
          inputs: "E_bruta=sensor.hp90_energia_termica_do_dia_kwh, perdas=sensor.aqs_perdas_kwh_dia"
        state: >
          {% set E  = states('sensor.hp90_energia_termica_do_dia_kwh')|float(0) %}
          {% set Pl = states('sensor.aqs_perdas_kwh_dia')|float(0) %}
          {% set net = E - Pl %}
          {{ (net if net > 0 else 0) | round(2) }}

      - name: "HP90 ‚Äî ŒîT l√≠quido previsto (¬∞C)"
        unique_id: hp90_deltaT_liquido_previsto_c
        unit_of_measurement: "¬∞C"
        icon: mdi:thermometer-water
        attributes:
          description: "Eleva√ß√£o de temperatura considerando as perdas (se declaradas)."
          formula: "ŒîT_liq = E_liquida / (V_L √ó 4.18/3600)"
          inputs: "E_liquida=sensor.hp90_energia_liquida_apos_perdas_kwh, V=input_number.dhw_volume_l"
        state: >
          {% set E_net = states('sensor.hp90_energia_liquida_apos_perdas_kwh')|float(0) %}
          {% set V     = states('input_number.dhw_volume_l')|float(500) %}
          {% set kWh_per_C = (V * 4.18 / 3600) %}
          {{ (E_net / max(kWh_per_C, 0.001)) | round(1) }}

      # =================== NOVOS SENSORES "AQS HP90" ===================
      - name: "AQS HP90 - Energia Hoje"
        unique_id: aqs_hp90_energy_today
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        attributes:
          description: "Energia t√©rmica prevista para hoje (kWh_th) com fator de calibra√ß√£o."
          formula: "E_today_th = (energy_today √ó √Årea √ó Œ∑) √ó fator"
          inputs: "energy_today=sensor.energy_production_today_tubos_hp90, area_total=sensor.hp90_area_total_m2, eta=input_number.solar_hp_eta_sistema, fator=input_number.aqs_hp90_kwh_factor"
        state: >
          {% set Hproxy = states('sensor.energy_production_today_tubos_hp90')|float(0) %}
          {% set A      = states('sensor.hp90_area_total_m2')|float(0) %}
          {% set eta    = states('input_number.solar_hp_eta_sistema')|float(0.55) %}
          {% set k      = states('input_number.aqs_hp90_kwh_factor')|float(1.0) %}
          {{ (Hproxy * A * eta * k) | round(2) }}

      - name: "AQS HP90 - Energia Amanh√£"
        unique_id: aqs_hp90_energy_tomorrow
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        attributes:
          description: "Energia t√©rmica prevista para amanh√£ (kWh_th) com fator de calibra√ß√£o."
          formula: "E_tomorrow_th = (energy_tomorrow √ó √Årea √ó Œ∑) √ó fator"
          inputs: "energy_tomorrow=sensor.energy_production_tomorrow_tubos_hp90, area_total=sensor.hp90_area_total_m2, eta=input_number.solar_hp_eta_sistema, fator=input_number.aqs_hp90_kwh_factor"
        state: >
          {% set Htom = states('sensor.energy_production_tomorrow_tubos_hp90')|float(0) %}
          {% set A    = states('sensor.hp90_area_total_m2')|float(0) %}
          {% set eta  = states('input_number.solar_hp_eta_sistema')|float(0.55) %}
          {% set k    = states('input_number.aqs_hp90_kwh_factor')|float(1.0) %}
          {{ (Htom * A * eta * k) | round(2) }}

      - name: "AQS HP90 - Energia Restante Hoje"
        unique_id: aqs_hp90_energy_remaining_today
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total
        attributes:
          description: "Energia t√©rmica ainda prevista para o resto do dia (kWh_th) com fator."
          formula: "E_remaining_th = (energy_today_remaining √ó √Årea √ó Œ∑) √ó fator"
          inputs: "energy_today_remaining=sensor.energy_production_today_remaining_tubos_hp90, area_total=sensor.hp90_area_total_m2, eta=input_number.solar_hp_eta_sistema, fator=input_number.aqs_hp90_kwh_factor"
        state: >
          {% set Hrem = states('sensor.energy_production_today_remaining_tubos_hp90')|float(0) %}
          {% set A    = states('sensor.hp90_area_total_m2')|float(0) %}
          {% set eta  = states('input_number.solar_hp_eta_sistema')|float(0.55) %}
          {% set k    = states('input_number.aqs_hp90_kwh_factor')|float(1.0) %}
          {{ (Hrem * A * eta * k) | round(2) }}

      - name: "AQS HP90 - Litros Hoje (T alvo)"
        unique_id: aqs_hp90_liters_today_target
        unit_of_measurement: "L"
        state_class: measurement
        attributes:
          description: "Litros de AQS poss√≠veis hoje √† temperatura alvo com base na energia prevista."
          formula: "L = E_today_th / (0.001163 √ó (T_alvo - T_fria))"
          notes: "T_fria aproximada pela temperatura exterior (limitada a 8..20 ¬∞C)."
          inputs: "E_today_th=sensor.aqs_hp90_energy_today, T_alvo=input_number.aqs_target_temp, T_ext=sensor.bthome_sensor_6a2b_temperature"
        state: >
          {% set E = states('sensor.aqs_hp90_energy_today')|float(0) %}
          {% set tgt = states('input_number.aqs_target_temp')|float(45) %}
          {% set ext = states('sensor.bthome_sensor_6a2b_temperature')|float(15) %}
          {% set t_cold = ext %}
          {% if t_cold < 8 %}{% set t_cold = 8 %}{% elif t_cold > 20 %}{% set t_cold = 20 %}{% endif %}
          {% set denom = 0.001163 * max(tgt - t_cold, 1) %}
          {{ (E / denom) | round(0) }}

      - name: "AQS HP90 - Litros Pr√≥xima Hora"
        unique_id: aqs_hp90_liters_next_hour
        unit_of_measurement: "L"
        state_class: measurement
        attributes:
          description: "Litros de AQS que poder√£o ser aquecidos na pr√≥xima hora."
          formula: "L_h = E_h_th / (0.001163 √ó (T_alvo - T_fria))"
          inputs: "E_h=sensor.energy_next_hour_tubos_hp90, area_total=sensor.hp90_area_total_m2, eta=input_number.solar_hp_eta_sistema, fator=input_number.aqs_hp90_kwh_factor, T_alvo=input_number.aqs_target_temp, T_ext=sensor.bthome_sensor_6a2b_temperature"
        state: >
          {% set Eh  = states('sensor.energy_next_hour_tubos_hp90')|float(0) %}
          {% set A   = states('sensor.hp90_area_total_m2')|float(0) %}
          {% set eta = states('input_number.solar_hp_eta_sistema')|float(0.55) %}
          {% set k   = states('input_number.aqs_hp90_kwh_factor')|float(1.0) %}
          {% set E   = Eh * A * eta * k %}
          {% set tgt = states('input_number.aqs_target_temp')|float(45) %}
          {% set ext = states('sensor.bthome_sensor_6a2b_temperature')|float(15) %}
          {% set t_cold = ext %}
          {% if t_cold < 8 %}{% set t_cold = 8 %}{% elif t_cold > 20 %}{% set t_cold = 20 %}{% endif %}
          {% set denom = 0.001163 * max(tgt - t_cold, 1) %}
          {{ (E / denom) | round(0) }}

      - name: "AQS HP90 - Carga Estimada Dep√≥sito"
        unique_id: aqs_hp90_tank_charge_estimate
        unit_of_measurement: "%"
        icon: mdi:water-boiler
        attributes:
          description: "Estimativa de % de carga do dep√≥sito no fim do dia (usa T atual do dep√≥sito, se existir)."
          formula: "% = (E_now + E_today_th) / E_full √ó 100"
          inputs: "V=input_number.dhw_volume_l, T_alvo=input_number.aqs_target_temp, T_ext=sensor.bthome_sensor_6a2b_temperature, T_tanque=sensor.hpsu_can_dhw_temperature (opcional), E_today=sensor.aqs_hp90_energy_today"
        state: >
          {% set vol = states('input_number.dhw_volume_l')|float(500) %}
          {% set tgt = states('input_number.aqs_target_temp')|float(45) %}
          {% set ext = states('sensor.bthome_sensor_6a2b_temperature')|float(15) %}
          {% set t_cold = ext %}
          {% if t_cold < 8 %}{% set t_cold = 8 %}{% elif t_cold > 20 %}{% set t_cold = 20 %}{% endif %}
          {% set E_full = 0.001163 * vol * max(tgt - t_cold, 1) %}
          {% set E_today = states('sensor.aqs_hp90_energy_today')|float(0) %}
          {% set tank_T = states('sensor.hpsu_can_dhw_temperature') %}
          {% if tank_T in ['unknown','unavailable','none',''] %}
            {% set tank_T = 40 %}
          {% else %}
            {% set tank_T = tank_T | float(40) %}
          {% endif %}
          {% set E_now = 0.001163 * vol * max(tank_T - t_cold, 0) %}
          {% set pct = ((E_now + E_today) / max(E_full, 0.1)) * 100 %}
          {% if pct < 0 %}0{% elif pct > 100 %}100{% else %}{{ pct | round(0) }}{% endif %}

      - name: "AQS HP90 - Pico Hoje (hora)"
        unique_id: aqs_hp90_peak_time_today
        icon: mdi:clock-outline
        attributes:
          description: "Hora do pico de pot√™ncia previsto para hoje."
          source: "sensor.power_highest_peak_time_today_tubos_hp90"
        state: "{{ states('sensor.power_highest_peak_time_today_tubos_hp90') }}"

      - name: "AQS HP90 - Pico Amanh√£ (hora)"
        unique_id: aqs_hp90_peak_time_tomorrow
        icon: mdi:clock-outline
        attributes:
          description: "Hora do pico de pot√™ncia previsto para amanh√£."
          source: "sensor.power_highest_peak_time_tomorrow_tubos_hp90"
        state: "{{ states('sensor.power_highest_peak_time_tomorrow_tubos_hp90') }}"

      - name: "AQS HP90 - Pot√™ncia Agora"
        unique_id: aqs_hp90_power_now
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        attributes:
          description: "Pot√™ncia t√©rmica prevista agora (modelo: power_now √ó √Årea √ó Œ∑)."
          inputs: "power_now=sensor.power_production_now_tubos_hp90, area_total=sensor.hp90_area_total_m2, eta=input_number.solar_hp_eta_sistema"
        state: >
          {% set pW  = states('sensor.power_production_now_tubos_hp90')|float(0) %}
          {% set A   = states('sensor.hp90_area_total_m2')|float(0) %}
          {% set eta = states('input_number.solar_hp_eta_sistema')|float(0.55) %}
          {{ (pW * A * eta) | round(0) }}

  - binary_sensor:
      - name: "AQS HP90 - Janela Boa Pr√≥xima Hora"
        unique_id: aqs_hp90_good_window_next_hour
        device_class: heat
        attributes:
          description: "ON se os litros previstos na pr√≥xima hora ‚â• m√≠nimo definido."
          rule: "on se L_h >= input_number.aqs_min_liters_window"
        state: >
          {% set Lh = states('sensor.aqs_hp90_liters_next_hour')|float(0) %}
          {% set minL = states('input_number.aqs_min_liters_window')|float(80) %}
          {{ 'on' if Lh >= minL else 'off' }}

group:
  aqs_hp90_previsao:
    name: "AQS HP90 - Previs√£o"
    entities:
      - sensor.aqs_hp90_energy_today
      - sensor.aqs_hp90_energy_tomorrow
      - sensor.aqs_hp90_energy_remaining_today
      - sensor.aqs_hp90_liters_today_target
      - sensor.aqs_hp90_liters_next_hour
      - sensor.aqs_hp90_tank_charge_estimate
      - sensor.aqs_hp90_peak_time_today
      - sensor.aqs_hp90_peak_time_tomorrow
      - sensor.aqs_hp90_power_now
      - binary_sensor.aqs_hp90_good_window_next_hour
