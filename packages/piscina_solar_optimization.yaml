# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PACKAGE: OTIMIZAÃ‡ÃƒO PISCINA SOLAR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Input helpers e configuraÃ§Ãµes para otimizaÃ§Ã£o avanÃ§ada
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

input_number:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“… Fator Consumo Fim-de-Semana
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  piscina_weekend_consumption_factor:
    name: "ğŸ“… Fator Consumo Fim-Semana"
    icon: mdi:calendar-weekend
    min: 0.5
    max: 2.0
    step: 0.1
    mode: slider
    unit_of_measurement: "Ã—"
    initial: 1.0

input_boolean:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸŒ¤ï¸ Usar PrevisÃ£o MeteorolÃ³gica
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  piscina_use_weather_forecast:
    name: "ğŸŒ¤ï¸ Ajustar por Meteorologia"
    icon: mdi:weather-partly-cloudy
    initial: true

  piscina_night_session_done:
    name: "Piscina - SessÃ£o Noturna Completa"
    icon: mdi:moon-waning-crescent
    initial: false

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ”® Usar PrevisÃ£o Solar para Planeamento DiÃ¡rio
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  piscina_forecast_planning_enabled:
    name: "ğŸ”® Planeamento Solar (PrevisÃ£o Solcast)"
    icon: mdi:crystal-ball
    initial: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸŒ™ Dia Previsto Sem Solar â†’ Preferir Noite Coopernico
  # Ligado automaticamente pela automaÃ§Ã£o de planeamento matinal
  # quando a previsÃ£o Solcast indica <30min contÃ­nuos de excesso solar.
  # A blueprint v6 pode usar este flag para decidir nÃ£o tentar
  # filtragem solar nesse dia (evitando cycling inÃºtil).
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  piscina_prefer_night_filtering:
    name: "ğŸŒ™ Dia Sem Solar (Filtrar Ã  Noite)"
    icon: mdi:weather-night
    initial: false

input_select:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“± NÃ­vel NotificaÃ§Ãµes
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  piscina_notification_level:
    name: "ğŸ“± NÃ­vel de NotificaÃ§Ãµes"
    icon: mdi:bell-ring
    options:
      - "Nenhuma"
      - "SÃ³ Alertas"
      - "Alertas + Info"
      - "Todas"
    initial: "Alertas + Info"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UTILITY METER - ENERGIA BOMBA DIÃRIA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
utility_meter:
  bomba_piscina_switch_0_energy:
    source: sensor.bomba_piscina_total_energy
    name: "Energia Bomba Piscina Hoje"
    cycle: daily
    offset:
      hours: 0
      minutes: 0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AUTOMAÃ‡Ã•ES: PLANEAMENTO SOLAR COM PREVISÃƒO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Usa Solcast (previsÃ£o solar hora-a-hora) para decidir de manhÃ£:
#   - Se vale a pena tentar filtragem solar durante o dia
#   - Ou se Ã© melhor filtrar Ã  noite com Coopernico (mais barato)
#
# Evita cycling inÃºtil em dias nublados â†’ bomba liga/desliga
# constantemente gastando electricidade cara da rede.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

automation:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ”® Planeamento Matinal: Analisar PrevisÃ£o Solar
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: piscina_forecast_morning_planning
    alias: "ğŸŠ Piscina - Planeamento Solar Matinal"
    description: >
      Analisa previsÃ£o Solcast Ã s 07:00 para decidir se vale a pena
      tentar filtragem solar ou se Ã© melhor filtrar Ã  noite com
      Coopernico (mais barato que importar da rede de dia).

    trigger:
      # Disparar Ã s 07:00 (antes do sol forte)
      - platform: time
        at: "07:00:00"
        id: morning_check

      # Disparar quando Solcast atualiza (pode ser 2x/dia)
      - platform: state
        entity_id: sensor.solcast_pv_forecast_forecast_today
        id: solcast_update

      # Disparar manualmente quando o toggle muda
      - platform: state
        entity_id: input_boolean.piscina_forecast_planning_enabled
        to: "on"
        id: manual_enable

    condition:
      # SÃ³ executar se o planeamento por previsÃ£o estÃ¡ ativado
      - condition: state
        entity_id: input_boolean.piscina_forecast_planning_enabled
        state: "on"

      # SÃ³ durante a manhÃ£ (07:00-12:00) para ser relevante
      - condition: time
        after: "06:30:00"
        before: "12:00:00"

    action:
      - variables:
          recommendation: "{{ state_attr('sensor.piscina_solar_forecast_analysis', 'recommendation_code') | default('unknown') }}"
          best_window: "{{ state_attr('sensor.piscina_solar_forecast_analysis', 'best_window_minutes') | int(0) }}"
          viable_hours: "{{ state_attr('sensor.piscina_solar_forecast_analysis', 'viable_hours') | int(0) }}"
          viable_windows: "{{ state_attr('sensor.piscina_solar_forecast_analysis', 'viable_windows') | int(0) }}"
          forecast_total: "{{ states('sensor.solcast_pv_forecast_forecast_today') | float(0) | round(1) }}"
          peak_w: "{{ states('sensor.solcast_pv_forecast_peak_forecast_today') | float(0) | round(0) }}"

      - choose:
          # CENÃRIO 1: Dia SEM solar viÃ¡vel â†’ Noite Coopernico
          - conditions:
              - condition: template
                value_template: "{{ recommendation in ['noite_coopernico', 'unknown'] or best_window < 30 }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.piscina_prefer_night_filtering

              - service: logbook.log
                data:
                  name: "Piscina Planeamento"
                  message: >
                    ğŸŒ™ SEM SOLAR â†’ Filtrar Ã  noite Coopernico
                    ğŸ“Š {{ forecast_total }}kWh | Pico {{ peak_w }}W
                    â±ï¸ Melhor janela: {{ best_window }}min (mÃ­n 30)
                    ğŸ’¡ Evitar cycling, noite Ã© mais barato
                  entity_id: input_boolean.piscina_prefer_night_filtering

              - service: persistent_notification.create
                data:
                  title: "ğŸŠ Piscina - Dia Sem Solar"
                  message: >
                    PrevisÃ£o: **{{ forecast_total }}kWh** | Pico: **{{ peak_w }}W**
                    Melhor janela: **{{ best_window }}min** (mÃ­n. 30min)
                    â¡ï¸ Filtragem Ã  **noite** com Coopernico
                  notification_id: piscina_forecast_planning

          # CENÃRIO 2: Dia misto
          - conditions:
              - condition: template
                value_template: "{{ recommendation in ['misto', 'pouco_solar'] and best_window >= 30 }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.piscina_prefer_night_filtering

              - service: logbook.log
                data:
                  name: "Piscina Planeamento"
                  message: >
                    ğŸŒ¤ï¸ MISTO â†’ Solar quando possÃ­vel + Noite complementa
                    ğŸ“Š {{ forecast_total }}kWh | Pico {{ peak_w }}W
                    â±ï¸ Janela: {{ best_window }}min | {{ viable_hours }}h viÃ¡veis
                  entity_id: input_boolean.piscina_prefer_night_filtering

          # CENÃRIO 3: Bom dia solar
          - conditions:
              - condition: template
                value_template: "{{ recommendation == 'solar_diurno' }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.piscina_prefer_night_filtering

              - service: logbook.log
                data:
                  name: "Piscina Planeamento"
                  message: >
                    â˜€ï¸ BOM SOLAR â†’ Prioridade solar {{ viable_hours }}h
                    ğŸ“Š {{ forecast_total }}kWh | Pico {{ peak_w }}W
                    â±ï¸ Janela: {{ best_window }}min contÃ­nuos!
                  entity_id: input_boolean.piscina_prefer_night_filtering

        default:
          - service: logbook.log
            data:
              name: "Piscina Planeamento"
              message: >
                âš ï¸ Inconclusivo: {{ recommendation }} | Janela {{ best_window }}min
              entity_id: input_boolean.piscina_prefer_night_filtering

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ”„ Re-anÃ¡lise ao meio-dia
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: piscina_forecast_midday_recheck
    alias: "ğŸŠ Piscina - Re-anÃ¡lise Solar Meio-Dia"
    description: >
      Re-analisa ao meio-dia. Se condiÃ§Ãµes pioraram â†’ modo noite.
      Se estavam mÃ¡s e melhoraram â†’ tentar solar.

    trigger:
      - platform: time
        at: "12:00:00"

    condition:
      - condition: state
        entity_id: input_boolean.piscina_forecast_planning_enabled
        state: "on"

    action:
      - variables:
          best_window: "{{ state_attr('sensor.piscina_solar_forecast_analysis', 'best_window_minutes') | int(0) }}"
          was_night_mode: "{{ is_state('input_boolean.piscina_prefer_night_filtering', 'on') }}"
          forecast_remaining: "{{ states('sensor.solcast_pv_forecast_forecast_remaining_today') | float(0) | round(1) }}"

      - choose:
          # Solar â†’ Noite (piorou)
          - conditions:
              - condition: template
                value_template: "{{ not was_night_mode and best_window < 30 }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.piscina_prefer_night_filtering
              - service: logbook.log
                data:
                  name: "Piscina Re-anÃ¡lise"
                  message: "ğŸ”„â†’ğŸŒ™ Piorou! Restante {{ forecast_remaining }}kWh, janela {{ best_window }}min"
                  entity_id: input_boolean.piscina_prefer_night_filtering

          # Noite â†’ Solar (melhorou)
          - conditions:
              - condition: template
                value_template: "{{ was_night_mode and best_window >= 60 }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.piscina_prefer_night_filtering
              - service: logbook.log
                data:
                  name: "Piscina Re-anÃ¡lise"
                  message: "ğŸ”„â†’â˜€ï¸ Melhorou! Restante {{ forecast_remaining }}kWh, janela {{ best_window }}min"
                  entity_id: input_boolean.piscina_prefer_night_filtering

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸŒ… Reset diÃ¡rio ao nascer do sol
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - id: piscina_forecast_daily_reset
    alias: "ğŸŠ Piscina - Reset Planeamento DiÃ¡rio"
    description: "Limpa flag noturno ao nascer do sol"

    trigger:
      - platform: sun
        event: sunrise
        offset: "-01:00:00"

    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.piscina_prefer_night_filtering
      - service: logbook.log
        data:
          name: "Piscina Reset"
          message: "ğŸŒ… Flag noite resetado, anÃ¡lise Ã s 07:00"
          entity_id: input_boolean.piscina_prefer_night_filtering
