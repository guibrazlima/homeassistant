blueprint:
  name: ðŸŠ Piscina - Controlo Solar Inteligente v6 HÃBRIDO (PT)
  description: |
    ### **Controlo Inteligente COMPLETO da Bomba da Piscina**
    Blueprint portuguÃªs que combina o melhor da v4 e v5!
    **VersÃ£o 6.0** - Modo HÃ­brido: Solar DIA + Coopernico NOITE
    
    #### âœ¨ **Funcionalidades Principais:**
    - â˜€ï¸ **Modo Dia:** Excedente solar com hysteresis inteligente (v4)
    - ðŸŒ™ **Modo Noite:** OtimizaÃ§Ã£o Coopernico janela mais barata (v5)
    - ðŸ”„ **TransiÃ§Ã£o AutomÃ¡tica:** CoordenaÃ§Ã£o inteligente entre modos
    - âœ… **PrevisÃ£o de importaÃ§Ã£o** - Liga antes de importar da rede
    - âœ… **6 nÃ­veis de fallback** - Prioridade para sensores com mÃ©dia 5min
    - âœ… **OtimizaÃ§Ã£o econÃ³mica** - CÃ¡lculo de break-even vs tarifa noturna
    - âœ… **Tempo dinÃ¢mico** - Filtragem baseada em temperatura Ã¡gua/ar
    - âœ… **Override manual** - Respeita controlo manual
    - âœ… **DiagnÃ³stico** - Logs detalhados opcionais
    
    #### ðŸ†• **NOVIDADE v6: Modo HÃ­brido**
    - ðŸŒž **Dia (sunriseâ†’sunset):** Liga com excedente solar (lÃ³gica v4)
    - ðŸ’° **Noite (22hâ†’08h):** Liga na janela Coopernico mais barata (v5)
    - ðŸ”€ **Zero Conflitos:** CoordenaÃ§Ã£o automÃ¡tica entre modos
    - ðŸ“Š **DÃ©fice Partilhado:** Calcula dÃ©fice global para ambos os modos
    
    #### ðŸ“Š **Hierarquia de Sensores (6 nÃ­veis):**
    1. NET mÃ©dia 5min (mais estÃ¡vel)
    2. Casa+PV mÃ©dia 5min
    3. Export mÃ©dia 5min
    4. NET instantÃ¢neo
    5. Casa+PV instantÃ¢neo
    6. Export instantÃ¢neo
    
    #### ðŸ’¡ **Baseado em:**
    CÃ³digo original de **guibrazlima** (binary_sensor.piscina_excedente_fv_bomba)
    v6 unifica v4 (solar) + v5 (Coopernico) numa blueprint hÃ­brida.
    
    ---
    *Blueprint v6.0 criado para Home Assistant - Portugal*

  domain: automation
  author: guibrazlima (original) + AI Assistant (blueprint v6 hÃ­brido)
  source_url: https://github.com/guibrazlima/homeassistant

  input:
    # ==========================================
    # SECÃ‡ÃƒO 1: CONFIGURAÃ‡ÃƒO ESSENCIAL
    # ==========================================
    
    pump_switch:
      name: ðŸ”Œ Switch da Bomba
      description: |
        **[OBRIGATÃ“RIO]** Entidade para ligar/desligar a bomba da piscina.
        **Exemplo:** `switch.bomba_piscina_switch_0`
      selector:
        entity:
          domain: switch

    pump_nominal_power:
      name: ðŸ’ª PotÃªncia Nominal da Bomba (W)
      description: |
        PotÃªncia nominal da bomba em Watts.
        **Como calcular:** Amperes Ã— 230V (ex: 6A Ã— 230V = 1380W)
        Usado para cÃ¡lculos de previsÃ£o e custos.
      default: 1380
      selector:
        number:
          min: 100
          max: 5000
          step: 10
          unit_of_measurement: "W"
          mode: box

    pump_actual_power:
      name: âš¡ Sensor Consumo Real da Bomba (opcional)
      description: |
        Sensor opcional do consumo atual da bomba em Watts.
        Melhora precisÃ£o usando consumo real em vez do nominal.
        **Exemplo:** `sensor.bomba_piscina_power`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    # ==========================================
    # SECÃ‡ÃƒO 2: NOVIDADE V6 - MODO HÃBRIDO
    # ==========================================

    hybrid_mode_enabled:
      name: ðŸ”€ Ativar Modo HÃ­brido
      description: |
        **NOVIDADE v6!** Combina solar (dia) + Coopernico (noite).
        
        **Como funciona:**
        - â˜€ï¸ DIA: Liga com excedente solar (lÃ³gica v4)
        - ðŸŒ™ NOITE: Liga na janela Coopernico mais barata (v5)
        - ðŸ”„ CoordenaÃ§Ã£o automÃ¡tica sem conflitos
        
        **Se DESATIVADO:** Funciona apenas modo dia (como v4)
      default: true
      selector:
        boolean: {}

    # ==========================================
    # SECÃ‡ÃƒO 3: COOPERNICO (MODO NOITE)
    # ==========================================

    use_coopernico_optimization:
      name: ðŸ’° Usar OtimizaÃ§Ã£o Coopernico (Noite)
      description: |
        Calcula automaticamente a janela de tempo mais barata Ã  noite.
        
        **Requer:** 
        - Modo HÃ­brido ativado
        - Sensor Coopernico configurado abaixo
        - Helpers criados (datetime, boolean, text)
        
        **PoupanÃ§a tÃ­pica:** 5-15% vs horÃ¡rio fixo
      default: false
      selector:
        boolean: {}

    coopernico_price_sensor:
      name: ðŸ’¶ Sensor PreÃ§os Coopernico
      description: |
        Sensor com preÃ§os dinÃ¢micos em intervalos de 15 minutos.
        **Exemplo:** `sensor.coopernico_base_bi_horario_ciclo_diario_all_prices`
      default: {}
      selector:
        entity:
          domain: sensor

    cheapest_window_helper:
      name: ðŸ• Helper Hora Agendada
      description: |
        Input datetime para guardar hora calculada mais barata.
        **Exemplo:** `input_datetime.piscina_hora_agendada_mais_barata`
      default: input_datetime.piscina_hora_agendada_mais_barata
      selector:
        entity:
          domain: input_datetime

    coopernico_end_helper:
      name: ðŸ Helper Fim Janela Coopernico
      description: |
        Input datetime para guardar hora calculada de FIM da janela Coopernico.
        Preenchido automaticamente quando a janela inicia (start + duraÃ§Ã£o).
        **Exemplo:** `input_datetime.piscina_fim_janela_coopernico`
      default: input_datetime.piscina_fim_janela_coopernico
      selector:
        entity:
          domain: input_datetime

    night_session_active_helper:
      name: ðŸ”’ Helper SessÃ£o Noturna
      description: |
        Input boolean para controlar sessÃ£o noturna ativa.
        **Exemplo:** `input_boolean.piscina_sessao_noturna_ativa`
      default: input_boolean.piscina_sessao_noturna_ativa
      selector:
        entity:
          domain: input_boolean

    calculation_info_helper:
      name: ðŸ“Š Helper Info CÃ¡lculo (opcional)
      description: |
        Input text para guardar info do Ãºltimo cÃ¡lculo.
        **Exemplo:** `input_text.piscina_ultima_janela_calculada`
      default: input_text.piscina_ultima_janela_calculada
      selector:
        entity:
          domain: input_text

    calculation_time:
      name: â° Hora do CÃ¡lculo Coopernico
      description: |
        Hora para calcular janela mais barata (antes da noite).
        **Recomendado:** 19:00-20:00
      default: "19:00:00"
      selector:
        time: {}

    # ==========================================
    # SECÃ‡ÃƒO 4: SENSORES DE POTÃŠNCIA (6 nÃ­veis)
    # ==========================================

    net_power_5min:
      name: ðŸ“Š PotÃªncia NET - MÃ©dia 5min
      description: |
        **[PRIORIDADE 1]** Sensor NET com mÃ©dia de 5 minutos.
        Positivo = importaÃ§Ã£o, Negativo = exportaÃ§Ã£o.
        **Exemplo:** `sensor.import_export_5min_smooth`
      default: {}
      selector:
        entity:
          domain: sensor

    house_power_no_pump_5min:
      name: ðŸ  Consumo Casa (SEM bomba) - MÃ©dia 5min
      description: |
        **[PRIORIDADE 2]** Consumo casa EXCLUINDO bomba, mÃ©dia 5min.
        **Exemplo:** `sensor.house_power_5min_smooth`
      default: {}
      selector:
        entity:
          domain: sensor

    pv_power_5min:
      name: â˜€ï¸ ProduÃ§Ã£o Solar (PV) - MÃ©dia 5min
      description: |
        **[PRIORIDADE 2]** ProduÃ§Ã£o solar com mÃ©dia 5min.
        **Exemplo:** `sensor.solar_power_5min_smooth`
      default: {}
      selector:
        entity:
          domain: sensor

    export_power_5min:
      name: ðŸ“¤ ExportaÃ§Ã£o - MÃ©dia 5min
      description: |
        **[PRIORIDADE 3]** ExportaÃ§Ã£o para rede, mÃ©dia 5min.
        **Exemplo:** `sensor.export_power_5min_smooth`
      default: {}
      selector:
        entity:
          domain: sensor

    net_power:
      name: ðŸ“Š PotÃªncia NET - InstantÃ¢neo
      description: |
        **[PRIORIDADE 4]** Sensor NET instantÃ¢neo (fallback).
        **Exemplo:** `sensor.emoncms_import_export`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    house_power_no_pump:
      name: ðŸ  Consumo Casa - InstantÃ¢neo
      description: |
        **[PRIORIDADE 5]** Consumo casa instantÃ¢neo.
        **Exemplo:** `sensor.emoncms_use_no_pool_pump`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    pv_power:
      name: â˜€ï¸ ProduÃ§Ã£o Solar - InstantÃ¢neo
      description: |
        **[PRIORIDADE 5]** ProduÃ§Ã£o solar instantÃ¢nea.
        **Exemplo:** `sensor.emoncms_solar`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    export_power:
      name: ðŸ“¤ ExportaÃ§Ã£o - InstantÃ¢neo
      description: |
        **[PRIORIDADE 6]** ExportaÃ§Ã£o instantÃ¢nea.
        **Exemplo:** `sensor.emoncms_export_power_positive`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    # ==========================================
    # SECÃ‡ÃƒO 5: FILTRAÃ‡ÃƒO DINÃ‚MICA
    # ==========================================

    use_dynamic_filtration_time:
      name: ðŸŒ¡ï¸ Usar Tempo DinÃ¢mico de Filtragem
      description: |
        Se ATIVADO, usa sensor de tempo baseado em temperatura.
        Se DESATIVADO, usa valor fixo de energia.
      default: true
      selector:
        boolean: {}

    dynamic_filtration_hours_sensor:
      name: ðŸŒ¡ï¸ Sensor Tempo Recomendado (horas)
      description: |
        Sensor que calcula horas baseado em temperatura.
        **Exemplo:** `sensor.piscina_tempo_de_filtracao_recomendado`
      default: {}
      selector:
        entity:
          domain: sensor

    min_daily_filtration_kwh:
      name: âš¡ Energia MÃ­nima DiÃ¡ria (kWh) - FIXO
      description: |
        Energia fixa se tempo dinÃ¢mico desativado.
        **Exemplo:** 8h Ã— 1.38kW = 11 kWh
      default: 11
      selector:
        number:
          min: 1
          max: 25
          step: 0.5
          unit_of_measurement: "kWh"
          mode: slider

    filtration_energy_today:
      name: ðŸ“Š Energia FiltraÃ§Ã£o Hoje
      description: |
        Sensor com kWh jÃ¡ consumidos hoje.
        **Exemplo:** `sensor.bomba_piscina_energy_today`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: energy

    filtration_remaining:
      name: â³ Tempo Filtragem Restante (opcional)
      description: |
        Sensor com tempo restante de filtragem hoje.
        Formatos: HH:MM, minutos numÃ©ricos, ou atributo 'seconds'
        **Exemplo:** `sensor.pool_pump_remaining_time`
      default: {}
      selector:
        entity:
          domain:
            - input_number
            - sensor

    ignore_filtration_limit:
      name: â™¾ï¸ Ignorar Limite de Filtragem (Dia)
      description: |
        Se ATIVADO, bomba liga com excedente solar MESMO apÃ³s meta cumprida.
        âœ… **Vantagens:** MÃ¡ximo autoconsumo
        âš ï¸ **AtenÃ§Ã£o:** Pode causar sobre-filtragem
      default: false
      selector:
        boolean: {}

    min_night_deficit_kwh:
      name: âš¡ DÃ©fice MÃ­nimo para Noite (kWh)
      description: |
        SÃ³ liga Ã  noite se dÃ©fice > este valor.
        **Recomendado:** 1.5-2.5 kWh
      default: 2
      selector:
        number:
          min: 0.5
          max: 8
          step: 0.5
          unit_of_measurement: "kWh"
          mode: slider

    # ==========================================
    # SECÃ‡ÃƒO 6: FILTRAGEM NOTURNA
    # ==========================================

    enable_night_auto:
      name: ðŸŒ™ Ligar Automaticamente Ã  Noite
      description: |
        Se ativado, completa filtragem Ã  noite.
        - Com Coopernico: usa janela mais barata
        - Sem Coopernico: usa horÃ¡rio fixo (fallback)
      default: false
      selector:
        boolean: {}

    night_start_time:
      name: ðŸ•™ InÃ­cio HorÃ¡rio Vazio (fallback)
      description: |
        Hora inÃ­cio vazio (usado se Coopernico nÃ£o configurado).
        **TÃ­pico:** 22:00
      default: "22:00:00"
      selector:
        time: {}

    night_end_time:
      name: ðŸ•— Fim HorÃ¡rio Vazio
      description: |
        Hora fim do vazio (failsafe desliga se ainda ligada).
        **TÃ­pico:** 08:00
      default: "08:00:00"
      selector:
        time: {}

    # ==========================================
    # SECÃ‡ÃƒO 7: OTIMIZAÃ‡ÃƒO ECONÃ“MICA (DIA)
    # ==========================================

    use_economic_optimization:
      name: ðŸ“Š Usar OtimizaÃ§Ã£o EconÃ³mica (Dia)
      description: |
        Calcula break-even dia vs noite.
        **Recomendado:** Ativar para tarifas bi-horÃ¡rias.
      default: true
      selector:
        boolean: {}

    price_peak:
      name: ðŸ’¶ PreÃ§o Fora-Vazio (â‚¬/kWh)
      description: |
        PreÃ§o durante o dia.
        **TÃ­pico PT 2024:** 0.15-0.18 â‚¬/kWh
      default: 0.1537
      selector:
        number:
          min: 0
          max: 1
          step: 0.001
          unit_of_measurement: "â‚¬/kWh"
          mode: box

    price_offpeak:
      name: ðŸ’¶ PreÃ§o Vazio (â‚¬/kWh)
      description: |
        PreÃ§o Ã  noite.
        **TÃ­pico PT 2024:** 0.08-0.10 â‚¬/kWh
      default: 0.0929
      selector:
        number:
          min: 0
          max: 1
          step: 0.001
          unit_of_measurement: "â‚¬/kWh"
          mode: box

    import_limit:
      name: ðŸ“ˆ Limite ImportaÃ§Ã£o MÃ¡xima (W) - Dia
      description: |
        ImportaÃ§Ã£o mÃ¡xima para manter ligada de dia.
        **Recomendado:** 500-800W
      default: 700
      selector:
        number:
          min: 0
          max: 2000
          step: 50
          unit_of_measurement: "W"
          mode: slider

    start_margin:
      name: ðŸš€ Margem Extra para Arranque (W) - Dia
      description: |
        Margem extra exigida para ligar de dia.
        **Recomendado:** 100W
      default: 100
      selector:
        number:
          min: 0
          max: 500
          step: 25
          unit_of_measurement: "W"
          mode: slider

    import_limit_strategy:
      name: ðŸŽ¯ EstratÃ©gia Limite ImportaÃ§Ã£o (Dia)
      description: |
        - **maior**: max(import_limit, break_even) â†’ verÃ£o
        - **menor**: min(import_limit, break_even) â†’ primavera/outono
        - **import_limit**: fixo â†’ controlo manual
        - **break_even**: sÃ³ economia â†’ inverno
      default: "maior"
      selector:
        select:
          options:
            - label: "MAIOR (max auto-consumo)"
              value: "maior"
            - label: "MENOR (balanÃ§o)"
              value: "menor"
            - label: "IMPORT_LIMIT (fixo)"
              value: "import_limit"
            - label: "BREAK_EVEN (economia)"
              value: "break_even"

    # ==========================================
    # SECÃ‡ÃƒO 8: DELAYS E TIMINGS
    # ==========================================

    delay_on:
      name: â±ï¸ Delay para Ligar (segundos) - Dia
      description: |
        Tempo de espera antes de ligar de dia.
        **Recomendado:** 20-60s
      default: 30
      selector:
        number:
          min: 0
          max: 300
          step: 5
          unit_of_measurement: "s"
          mode: slider

    delay_off:
      name: â±ï¸ Delay para Desligar (segundos) - Dia
      description: |
        Tempo de espera antes de desligar de dia.
        **Recomendado:** 45-90s
      default: 60
      selector:
        number:
          min: 0
          max: 300
          step: 5
          unit_of_measurement: "s"
          mode: slider

    min_on_time:
      name: â° Tempo MÃ­nimo Ligada (minutos)
      description: |
        Tempo mÃ­nimo apÃ³s arranque (dia e noite).
        **Recomendado:** 10-15min
      default: 10
      selector:
        number:
          min: 0
          max: 60
          step: 1
          unit_of_measurement: "min"
          mode: slider

    delay_multiplier_sensor:
      name: ðŸŒ¤ï¸ Multiplicador de Delay (opcional)
      description: |
        Sensor que ajusta delays baseado no tempo.
        - CÃ©u limpo: 1.0Ã— - Nublado: 1.5Ã— - InstÃ¡vel: 2.0Ã—
        **Exemplo:** `sensor.piscina_weather_delay_multiplier`
      default: {}
      selector:
        entity:
          domain: sensor

    # ==========================================
    # SECÃ‡ÃƒO 9: HORÃRIOS SOLARES
    # ==========================================

    sun_offset_start:
      name: ðŸŒ… Offset ApÃ³s Nascer do Sol (min)
      description: |
        Minutos apÃ³s nascer do sol para comeÃ§ar.
      default: 30
      selector:
        number:
          min: 0
          max: 180
          step: 15
          unit_of_measurement: "min"
          mode: slider

    sun_offset_end:
      name: ðŸŒ‡ Offset Antes do PÃ´r do Sol (min)
      description: |
        Minutos antes do pÃ´r do sol para parar.
      default: 30
      selector:
        number:
          min: 0
          max: 180
          step: 15
          unit_of_measurement: "min"
          mode: slider

    # ==========================================
    # SECÃ‡ÃƒO 10: CONTROLO E DEBUG
    # ==========================================

    override_manual:
      name: ðŸ”§ Override Manual
      description: |
        Input boolean para modo manual.
        **Exemplo:** `input_boolean.piscina_manual_mode`
      default: {}
      selector:
        entity:
          domain: input_boolean

    enable_debug_logs:
      name: ðŸ” Logs de DiagnÃ³stico
      description: |
        Ativa logs detalhados.
        Logger: `blueprints.piscina_solar_v6`
      default: false
      selector:
        boolean: {}

    dry_run_mode:
      name: ðŸ§ª Modo Dry Run (Teste)
      description: |
        Testa lÃ³gica SEM controlar a bomba.
        Ãštil para validar configuraÃ§Ã£o.
      default: false
      selector:
        boolean: {}

# ==========================================
# VARIÃVEIS GLOBAIS
# ==========================================
variables:
  # Inputs base
  pump_entity: !input pump_switch
  pump_power: !input pump_nominal_power
  pump_power_sensor: !input pump_actual_power
  dry_run: !input dry_run_mode
  debug: !input enable_debug_logs
  
  # Modo HÃ­brido
  hybrid_mode: !input hybrid_mode_enabled
  
  # Coopernico
  use_coopernico: !input use_coopernico_optimization
  coopernico_sensor: !input coopernico_price_sensor
  cheapest_helper: !input cheapest_window_helper
  coopernico_end: !input coopernico_end_helper
  session_helper: !input night_session_active_helper
  info_helper: !input calculation_info_helper
  
  # FiltraÃ§Ã£o
  use_dynamic: !input use_dynamic_filtration_time
  dynamic_sensor: !input dynamic_filtration_hours_sensor
  fixed_kwh: !input min_daily_filtration_kwh
  energy_today_sensor: !input filtration_energy_today
  remaining_sensor: !input filtration_remaining
  ignore_limit: !input ignore_filtration_limit
  min_deficit: !input min_night_deficit_kwh
  enable_night_auto: !input enable_night_auto
  
  # HorÃ¡rios
  night_start: !input night_start_time
  night_end: !input night_end_time
  calc_time: !input calculation_time
  
  # PreÃ§os
  price_peak_val: !input price_peak
  price_offpeak_val: !input price_offpeak
  use_econ_opt: !input use_economic_optimization
  
  # Limites e estratÃ©gia
  import_limit_val: !input import_limit
  start_margin_val: !input start_margin
  limit_strategy: !input import_limit_strategy
  
  # Delays
  delay_on_val: !input delay_on
  delay_off_val: !input delay_off
  min_on_time_val: !input min_on_time
  delay_mult_sensor: !input delay_multiplier_sensor
  
  # Sensores potÃªncia (hierarquia 6 nÃ­veis)
  net_5min: !input net_power_5min
  house_5min: !input house_power_no_pump_5min
  pv_5min: !input pv_power_5min
  export_5min: !input export_power_5min
  net_inst: !input net_power
  house_inst: !input house_power_no_pump
  pv_inst: !input pv_power
  export_inst: !input export_power
  
  # Override manual
  manual_override: !input override_manual

  # ==========================================
  # ESTADO DA BOMBA
  # ==========================================
  pump_is_on: "{{ is_state(pump_entity, 'on') }}"
  
  # Consumo real ou nominal
  pump_current_power: >
    {% if pump_power_sensor != {} and states(pump_power_sensor) not in ['unavailable', 'unknown', 'none'] %}
      {{ states(pump_power_sensor) | float(pump_power) }}
    {% else %}
      {{ pump_power }}
    {% endif %}

  # ==========================================
  # CÃLCULO DÃ‰FICE FILTRAGEM
  # ==========================================
  
  # Target kWh
  target_kwh: >
    {% if use_dynamic and dynamic_sensor != {} %}
      {% set hours = states(dynamic_sensor) | float(8) %}
      {{ (hours * (pump_power / 1000)) | round(2) }}
    {% else %}
      {{ fixed_kwh }}
    {% endif %}
  
  # Energia jÃ¡ consumida hoje
  energy_consumed: >
    {% if energy_today_sensor != {} %}
      {{ states(energy_today_sensor) | float(0) }}
    {% else %}
      0
    {% endif %}
  
  # DÃ©fice restante em kWh
  deficit_kwh: >
    {{ [target_kwh - energy_consumed, 0] | max | round(2) }}
  
  # Horas restantes a filtrar
  deficit_hours: >
    {{ (deficit_kwh / (pump_power / 1000)) | round(2) }}
  
  # Tempo restante (do sensor ou calculado)
  remaining_time_minutes: >
    {% if remaining_sensor != {} %}
      {% set state = states(remaining_sensor) %}
      {% if ':' in state %}
        {# Formato HH:MM #}
        {% set parts = state.split(':') %}
        {{ (parts[0] | int * 60) + (parts[1] | int) }}
      {% elif state_attr(remaining_sensor, 'seconds') is not none %}
        {{ (state_attr(remaining_sensor, 'seconds') | int / 60) | round(0) }}
      {% else %}
        {{ state | int }}
      {% endif %}
    {% else %}
      {{ (deficit_hours * 60) | round(0) }}
    {% endif %}

  # ==========================================
  # HIERARCHIA SENSORES (6 nÃ­veis)
  # ==========================================
  
  # NÃ­vel selecionado (1-6)
  sensor_level: >
    {% if net_5min != {} %}
      1
    {% elif house_5min != {} and pv_5min != {} %}
      2
    {% elif export_5min != {} %}
      3
    {% elif net_inst != {} %}
      4
    {% elif house_inst != {} and pv_inst != {} %}
      5
    {% elif export_inst != {} %}
      6
    {% else %}
      0
    {% endif %}
  
  # PotÃªncia NET atual (baseado no nÃ­vel)
  current_net_power: >
    {% set level = sensor_level | int %}
    {% if level == 1 %}
      {{ states(net_5min) | float(0) }}
    {% elif level == 2 %}
      {% set house = states(house_5min) | float(0) %}
      {% set pv = states(pv_5min) | float(0) %}
      {{ (house - pv) | round(0) }}
    {% elif level == 3 %}
      {% set export = states(export_5min) | float(0) %}
      {{ (0 - export) | round(0) }}
    {% elif level == 4 %}
      {{ states(net_inst) | float(0) }}
    {% elif level == 5 %}
      {% set house = states(house_inst) | float(0) %}
      {% set pv = states(pv_inst) | float(0) %}
      {{ (house - pv) | round(0) }}
    {% elif level == 6 %}
      {% set export = states(export_inst) | float(0) %}
      {{ (0 - export) | round(0) }}
    {% else %}
      0
    {% endif %}
  
  # PrevisÃ£o importaÃ§Ã£o COM bomba
  import_predicted: >
    {{ (current_net_power + pump_current_power) | round(0) }}

  # ==========================================
  # BREAK-EVEN ECONÃ“MICO
  # ==========================================
  
  break_even_import_w: >
    {% if use_econ_opt %}
      {% set cost_night = price_offpeak_val * (pump_power / 1000) %}
      {% set cost_day_per_w = price_peak_val / 1000 %}
      {{ ((cost_night / cost_day_per_w) - pump_power) | round(0) }}
    {% else %}
      {{ import_limit_val }}
    {% endif %}
  
  # Limite final baseado na estratÃ©gia
  final_import_limit: >
    {% set break_even = break_even_import_w | int %}
    {% set config_limit = import_limit_val | int %}
    {% if limit_strategy == 'maior' %}
      {{ [break_even, config_limit] | max }}
    {% elif limit_strategy == 'menor' %}
      {{ [break_even, config_limit] | min }}
    {% elif limit_strategy == 'break_even' %}
      {{ break_even }}
    {% else %}
      {{ config_limit }}
    {% endif %}

  # ==========================================
  # DELAYS DINÃ‚MICOS
  # ==========================================
  
  delay_multiplier: >
    {% if delay_mult_sensor != {} %}
      {{ states(delay_mult_sensor) | float(1.0) }}
    {% else %}
      1.0
    {% endif %}
  
  final_delay_on: >
    {{ (delay_on_val * delay_multiplier) | round(0) }}
  
  final_delay_off: >
    {{ (delay_off_val * delay_multiplier) | round(0) }}

  # ==========================================
  # CONDIÃ‡Ã•ES DE LIGAÃ‡ÃƒO (DIA)
  # ==========================================
  
  # Pode ligar? (previsÃ£o importaÃ§Ã£o OK)
  can_turn_on: >
    {{ import_predicted <= (final_import_limit - start_margin_val) }}
  
  # Pode manter? (importaÃ§Ã£o atual OK)
  can_keep_on: >
    {{ import_predicted <= final_import_limit }}
  
  # Tem dÃ©fice suficiente?
  has_deficit: >
    {{ deficit_kwh > 0.1 or ignore_limit }}
  
  # Tempo mÃ­nimo ligada respeitado?
  min_time_elapsed: >
    {% set last_changed = as_timestamp(states.switch[pump_entity.split('.')[1]].last_changed) %}
    {% set now_ts = as_timestamp(now()) %}
    {{ (now_ts - last_changed) >= (min_on_time_val * 60) }}

  # ==========================================
  # COOPERNICO: CÃ¡lculo janela mais barata
  # ==========================================
  
  coopernico_prices: >
    {% if coopernico_sensor != {} and use_coopernico %}
      {{ state_attr(coopernico_sensor, 'prices') | default([]) }}
    {% else %}
      []
    {% endif %}
  
  # Filtrar preÃ§os noturnos (22h-08h)
  night_prices: >
    {% set prices = coopernico_prices %}
    {% if prices | length > 0 %}
      {% set ns = namespace(filtered=[]) %}
      {% for p in prices %}
        {% set datetime_str = p.datetime | string %}
        {% set time_part = datetime_str.split('T')[1].split('+')[0] if 'T' in datetime_str else datetime_str.split(' ')[1].split('+')[0] %}
        {% set hour = time_part.split(':')[0] | int %}
        {% if hour >= 22 or hour < 8 %}
          {% set ns.filtered = ns.filtered + [p] %}
        {% endif %}
      {% endfor %}
      {{ ns.filtered }}
    {% else %}
      []
    {% endif %}
  
  # Sliding Window: encontrar slots mais baratos
  cheapest_result: >
    {% set prices = night_prices %}
    {% set deficit_h = deficit_hours %}
    
    {% if prices | length == 0 or deficit_h <= 0 %}
      {{ {'start_time': night_start, 'avg_price': price_offpeak_val, 'found': false} }}
    {% else %}
      {% set slots_needed = (deficit_h * 4) | round(0, 'ceil') | int %}
      {% set max_slots = 40 %}
      {% set slots_needed = [slots_needed, max_slots] | min %}
      
      {% if slots_needed > prices | length %}
        {{ {'start_time': night_start, 'avg_price': price_offpeak_val, 'found': false} }}
      {% else %}
        {% set ns = namespace(best_start=0, best_avg=999, best_time='') %}
        
        {% for i in range(0, (prices | length) - slots_needed + 1) %}
          {% set window = prices[i:i+slots_needed] %}
          {% set avg_price = (window | map(attribute='price_w_vat') | sum) / (window | length) %}
          
          {% if avg_price < ns.best_avg %}
            {% set ns.best_avg = avg_price %}
            {% set ns.best_start = i %}
            {% set datetime_str = window[0].datetime | string %}
            {% set time_part = datetime_str.split('T')[1].split('+')[0] if 'T' in datetime_str else datetime_str.split(' ')[1].split('+')[0] %}
            {% set ns.best_time = time_part %}
          {% endif %}
        {% endfor %}
        
        {{ {
          'start_time': ns.best_time,
          'avg_price': ns.best_avg,
          'total_cost': (ns.best_avg * deficit_h * (pump_power / 1000)) | round(3),
          'duration_hours': deficit_h,
          'found': true
        } }}
      {% endif %}
    {% endif %}

  # ==========================================
  # MODO ATUAL (Dia ou Noite)
  # ==========================================
  
  current_mode: >
    {% set now_hour = now().hour %}
    {% set night_start_str = night_start | string %}
    {% set night_end_str = night_end | string %}
    {% set night_start_hour = night_start_str.split(':')[0] | int %}
    {% set night_end_hour = night_end_str.split(':')[0] | int %}
    
    {% if now_hour >= night_start_hour or now_hour < night_end_hour %}
      night
    {% else %}
      day
    {% endif %}

# ==========================================
# TRIGGERS
# ==========================================
trigger:
  # ========== TRIGGERS COOPERNICO (NOITE) ==========
  
  # 1. CÃ¡lculo diÃ¡rio janela mais barata
  - platform: time
    at: !input calculation_time
    id: daily_calculation
  
  # 2. Hora agendada Coopernico
  - platform: time
    at: !input cheapest_window_helper
    id: cheapest_scheduled_time
  
  # 2.5. Fim janela Coopernico (calculado automaticamente)
  - platform: time
    at: !input coopernico_end_helper
    id: coopernico_window_end
  
  # 3. Fallback inÃ­cio noite
  - platform: time
    at: !input night_start_time
    id: night_fallback_start
  
  # 4. Fim perÃ­odo noturno
  - platform: time
    at: !input night_end_time
    id: night_end
  
  # ========== TRIGGERS SOLARES (DIA) ==========
  
  # 5. Nascer do sol
  - platform: sun
    event: sunrise
    offset: !input sun_offset_start
    id: sunrise
  
  # 6. PÃ´r do sol
  - platform: sun
    event: sunset
    offset: -1800  # 30 min antes (em segundos)
    id: sunset
  
  # 7-8. MonitorizaÃ§Ã£o potÃªncia (DIA)
  - platform: state
    entity_id: !input net_power_5min
    id: power_change_5min
  
  - platform: state
    entity_id: !input net_power
    id: power_change_inst
  
  # 9. MudanÃ§a estado bomba (para min_on_time)
  - platform: state
    entity_id: !input pump_switch
    id: pump_state_change

# ==========================================
# CONDITIONS
# ==========================================
condition:
  # Respeitar override manual
  - condition: template
    value_template: >
      {{ manual_override == {} or not is_state(manual_override, 'on') }}

# ==========================================
# ACTIONS
# ==========================================
action:
  - choose:
      # ==========================================
      # ACTION 1: CÃLCULO COOPERNICO (19h)
      # ==========================================
      - conditions:
          - condition: trigger
            id: daily_calculation
          - condition: template
            value_template: "{{ hybrid_mode and use_coopernico }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ coopernico_sensor != {} and cheapest_helper != {} }}"
            then:
              # Calcular e guardar hora
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input cheapest_window_helper
                data:
                  time: "{{ cheapest_result.start_time }}"
              
              # Guardar info cÃ¡lculo
              - if:
                  - condition: template
                    value_template: "{{ info_helper != {} }}"
                then:
                  - service: input_text.set_value
                    target:
                      entity_id: !input calculation_info_helper
                    data:
                      value: >
                        {% set r = cheapest_result %}
                        {% if r.found %}
                          {{ r.start_time }} | {{ r.avg_price | round(5) }}â‚¬/kWh | {{ r.total_cost }}â‚¬ | {{ r.duration_hours }}h
                        {% else %}
                          Fallback: {{ night_start }} (sem dados)
                        {% endif %}
              
              # Log
              - if:
                  - condition: template
                    value_template: "{{ debug }}"
                then:
                  - service: logbook.log
                    data:
                      name: "Piscina v6 - CÃ¡lculo Coopernico"
                      message: >
                        Janela: {{ cheapest_result.start_time }}
                        PreÃ§o: {{ cheapest_result.avg_price | round(5) }}â‚¬/kWh
                        Custo: {{ cheapest_result.total_cost }}â‚¬
                        DuraÃ§Ã£o: {{ cheapest_result.duration_hours }}h
                      entity_id: !input pump_switch

      # ==========================================
      # ACTION 2: LIGA NA HORA AGENDADA (NOITE)
      # ==========================================
      - conditions:
          - condition: trigger
            id: cheapest_scheduled_time
          - condition: template
            value_template: "{{ hybrid_mode and use_coopernico and enable_night_auto }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ deficit_kwh >= min_deficit }}"
              - condition: template
                value_template: "{{ not is_state(session_helper, 'on') }}"
            then:
              # Ativar session lock
              - service: input_boolean.turn_on
                target:
                  entity_id: !input night_session_active_helper
              
              # Ligar bomba
              - if:
                  - condition: template
                    value_template: "{{ not dry_run }}"
                then:
                  - service: switch.turn_on
                    target:
                      entity_id: !input pump_switch
              
              # Log
              - if:
                  - condition: template
                    value_template: "{{ debug }}"
                then:
                  - service: logbook.log
                    data:
                      name: "Piscina v6 - Coopernico ON"
                      message: >
                        ðŸ’° NOITE: Bomba ligada na janela mais barata
                        DÃ©fice: {{ deficit_kwh }}kWh ({{ deficit_hours }}h)
                        {% if dry_run %}[DRY RUN]{% endif %}
                      entity_id: !input pump_switch
              
              # Calcular e guardar hora de fim da janela
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input coopernico_end_helper
                data:
                  time: >
                    {% set duration_sec = (cheapest_result.duration_hours * 3600) | int %}
                    {% set end_time = now() + timedelta(seconds=duration_sec) %}
                    {{ end_time.strftime('%H:%M:%S') }}
              
              - if:
                  - condition: template
                    value_template: "{{ debug }}"
                then:
                  - service: logbook.log
                    data:
                      name: "Piscina v6 - Coopernico Timer"
                      message: >
                        â±ï¸ Fim janela agendado para {{ 
                          (now() + timedelta(seconds=(cheapest_result.duration_hours * 3600) | int)).strftime('%H:%M') 
                        }} ({{ cheapest_result.duration_hours }}h)
                      entity_id: !input pump_switch

      # ==========================================
      # ACTION 3: FALLBACK HORÃRIO FIXO (NOITE)
      # ==========================================
      - conditions:
          - condition: trigger
            id: night_fallback_start
          - condition: template
            value_template: "{{ (not use_coopernico or not hybrid_mode) and enable_night_auto }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ deficit_kwh >= min_deficit }}"
              - condition: template
                value_template: "{{ not is_state(session_helper, 'on') }}"
            then:
              - service: input_boolean.turn_on
                target:
                  entity_id: !input night_session_active_helper
              
              - if:
                  - condition: template
                    value_template: "{{ not dry_run }}"
                then:
                  - service: switch.turn_on
                    target:
                      entity_id: !input pump_switch
              
              - if:
                  - condition: template
                    value_template: "{{ debug }}"
                then:
                  - service: logbook.log
                    data:
                      name: "Piscina v6 - Fallback Noite"
                      message: >
                        ðŸ•™ NOITE: Bomba ligada horÃ¡rio fixo (fallback)
                        DÃ©fice: {{ deficit_kwh }}kWh
                      entity_id: !input pump_switch

      # ==========================================
      # ACTION 3.5: FIM JANELA COOPERNICO (auto-stop)
      # ==========================================
      - conditions:
          - condition: trigger
            id: coopernico_window_end
          - condition: template
            value_template: "{{ is_state(session_helper, 'on') }}"
        sequence:
          # Reset session lock
          - service: input_boolean.turn_off
            target:
              entity_id: !input night_session_active_helper
          
          # Desligar bomba
          - if:
              - condition: template
                value_template: "{{ pump_is_on and not dry_run }}"
            then:
              - service: switch.turn_off
                target:
                  entity_id: !input pump_switch
          
          - if:
              - condition: template
                value_template: "{{ debug }}"
            then:
              - service: logbook.log
                data:
                  name: "Piscina v6 - Coopernico OFF"
                  message: >
                    â±ï¸ Janela Coopernico terminada ({{ cheapest_result.duration_hours }}h)
                    DÃ©fice restante: {{ deficit_kwh }}kWh
                    {% if dry_run %}[DRY RUN]{% endif %}
                  entity_id: !input pump_switch

      # ==========================================
      # ACTION 4: FIM PERÃODO NOTURNO
      # ==========================================
      - conditions:
          - condition: trigger
            id: night_end
        sequence:
          # Reset session lock
          - service: input_boolean.turn_off
            target:
              entity_id: !input night_session_active_helper
          
          # Desligar bomba (failsafe)
          - if:
              - condition: template
                value_template: "{{ pump_is_on and not dry_run }}"
            then:
              - service: switch.turn_off
                target:
                  entity_id: !input pump_switch
          
          - if:
              - condition: template
                value_template: "{{ debug }}"
            then:
              - service: logbook.log
                data:
                  name: "Piscina v6 - Fim Noite"
                  message: "ðŸ•— Fim perÃ­odo noturno, session resetada"
                  entity_id: !input pump_switch

      # ==========================================
      # ACTION 5: NASCER DO SOL
      # ==========================================
      - conditions:
          - condition: trigger
            id: sunrise
        sequence:
          # Reset session lock
          - service: input_boolean.turn_off
            target:
              entity_id: !input night_session_active_helper
          
          - if:
              - condition: template
                value_template: "{{ debug }}"
            then:
              - service: logbook.log
                data:
                  name: "Piscina v6 - Nascer Sol"
                  message: "ðŸŒ… Session noturna resetada, modo DIA ativo"
                  entity_id: !input pump_switch

      # ==========================================
      # ACTION 6: PÃ”R DO SOL
      # ==========================================
      - conditions:
          - condition: trigger
            id: sunset
        sequence:
          # Desligar bomba se ligada de dia
          - if:
              - condition: template
                value_template: "{{ pump_is_on and not dry_run }}"
            then:
              - service: switch.turn_off
                target:
                  entity_id: !input pump_switch
          
          - if:
              - condition: template
                value_template: "{{ debug }}"
            then:
              - service: logbook.log
                data:
                  name: "Piscina v6 - PÃ´r Sol"
                  message: "ðŸŒ‡ Bomba desligada ao pÃ´r do sol, modo NOITE pronto"
                  entity_id: !input pump_switch

      # ==========================================
      # ACTION 7: CONTROLO SOLAR (DIA)
      # ==========================================
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: power_change_5min
              - condition: trigger
                id: power_change_inst
          - condition: template
            value_template: "{{ current_mode == 'day' }}"
        sequence:
          - choose:
              # ===== LIGAR BOMBA =====
              - conditions:
                  - condition: template
                    value_template: "{{ not pump_is_on }}"
                  - condition: template
                    value_template: "{{ has_deficit }}"
                  - condition: template
                    value_template: "{{ can_turn_on }}"
                sequence:
                  # Delay antes de ligar
                  - delay:
                      seconds: "{{ final_delay_on }}"
                  
                  # Re-verificar condiÃ§Ãµes
                  - if:
                      - condition: template
                        value_template: "{{ can_turn_on and has_deficit }}"
                    then:
                      - if:
                          - condition: template
                            value_template: "{{ not dry_run }}"
                        then:
                          - service: switch.turn_on
                            target:
                              entity_id: !input pump_switch
                      
                      - if:
                          - condition: template
                            value_template: "{{ debug }}"
                        then:
                          - service: logbook.log
                            data:
                              name: "Piscina v6 - Solar ON"
                              message: >
                                â˜€ï¸ DIA: Bomba ligada com excedente
                                NET: {{ current_net_power }}W
                                Previsto: {{ import_predicted }}W
                                Limite: {{ final_import_limit }}W
                                DÃ©fice: {{ deficit_kwh }}kWh
                                Sensor: NÃ­vel {{ sensor_level }}
                                {% if dry_run %}[DRY RUN]{% endif %}
                              entity_id: !input pump_switch
              
              # ===== DESLIGAR BOMBA =====
              - conditions:
                  - condition: template
                    value_template: "{{ pump_is_on }}"
                  - condition: template
                    value_template: "{{ not can_keep_on or (not has_deficit and not ignore_limit) }}"
                  - condition: template
                    value_template: "{{ min_time_elapsed }}"
                sequence:
                  # Delay antes de desligar
                  - delay:
                      seconds: "{{ final_delay_off }}"
                  
                  # Re-verificar
                  - if:
                      - condition: template
                        value_template: "{{ not can_keep_on or not has_deficit }}"
                    then:
                      - if:
                          - condition: template
                            value_template: "{{ not dry_run }}"
                        then:
                          - service: switch.turn_off
                            target:
                              entity_id: !input pump_switch
                      
                      - if:
                          - condition: template
                            value_template: "{{ debug }}"
                        then:
                          - service: logbook.log
                            data:
                              name: "Piscina v6 - Solar OFF"
                              message: >
                                â˜€ï¸ DIA: Bomba desligada
                                RazÃ£o: {{ 'Sem excedente' if not can_keep_on else 'Meta cumprida' }}
                                NET: {{ current_net_power }}W
                                Previsto: {{ import_predicted }}W
                                DÃ©fice: {{ deficit_kwh }}kWh
                                {% if dry_run %}[DRY RUN]{% endif %}
                              entity_id: !input pump_switch

    # ===== DEFAULT (DEBUG) =====
    default:
      - if:
          - condition: template
            value_template: "{{ debug }}"
        then:
          - service: logbook.log
            data:
              name: "Piscina v6 - Debug"
              message: >
                Trigger: {{ trigger.id | default('unknown') }}
                Modo: {{ current_mode }}
                Bomba: {{ 'ON' if pump_is_on else 'OFF' }}
                DÃ©fice: {{ deficit_kwh }}kWh
                NET: {{ current_net_power }}W
                Sensor: NÃ­vel {{ sensor_level }}
              entity_id: !input pump_switch

mode: single
max_exceeded: silent
