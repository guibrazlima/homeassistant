blueprint:
  name: üèä Piscina - Controlo Solar Inteligente v6 H√çBRIDO (PT)
  description: |
    ### **Controlo Inteligente COMPLETO da Bomba da Piscina**
    Blueprint portugu√™s que combina o melhor da v4 e v5!
    **Vers√£o 6.0** - Modo H√≠brido: Solar DIA + Coopernico NOITE
    
    #### ‚ú® **Funcionalidades Principais:**
    - ‚òÄÔ∏è **Modo Dia:** Excedente solar com hysteresis inteligente (v4)
    - üåô **Modo Noite:** Otimiza√ß√£o Coopernico janela mais barata (v5)
    - üîÑ **Transi√ß√£o Autom√°tica:** Coordena√ß√£o inteligente entre modos
    - ‚úÖ **Previs√£o de importa√ß√£o** - Liga antes de importar da rede
    - ‚úÖ **6 n√≠veis de fallback** - Prioridade para sensores com m√©dia 5min
    - ‚úÖ **Otimiza√ß√£o econ√≥mica** - C√°lculo de break-even vs tarifa noturna
    - ‚úÖ **Tempo din√¢mico** - Filtragem baseada em temperatura √°gua/ar
    - ‚úÖ **Override manual** - Respeita controlo manual
    - ‚úÖ **Diagn√≥stico** - Logs detalhados opcionais
    
    #### üÜï **NOVIDADE v6: Modo H√≠brido**
    - üåû **Dia (sunrise‚Üísunset):** Liga com excedente solar (l√≥gica v4)
    - üí∞ **Noite (22h‚Üí08h):** Liga na janela Coopernico mais barata (v5)
    - üîÄ **Zero Conflitos:** Coordena√ß√£o autom√°tica entre modos
    - üìä **D√©fice Partilhado:** Calcula d√©fice global para ambos os modos
    
    #### üìä **Hierarquia de Sensores (6 n√≠veis):**
    1. NET m√©dia 5min (mais est√°vel)
    2. Casa+PV m√©dia 5min
    3. Export m√©dia 5min
    4. NET instant√¢neo
    5. Casa+PV instant√¢neo
    6. Export instant√¢neo
    
    #### üí° **Baseado em:**
    C√≥digo original de **guibrazlima** (binary_sensor.piscina_excedente_fv_bomba)
    v6 unifica v4 (solar) + v5 (Coopernico) numa blueprint h√≠brida.
    
    ---
    *Blueprint v6.0 criado para Home Assistant - Portugal*

  domain: automation
  author: guibrazlima (original) + AI Assistant (blueprint v6 h√≠brido)
  source_url: https://github.com/guibrazlima/homeassistant

  input:
    # ==========================================
    # SEC√á√ÉO 1: CONFIGURA√á√ÉO ESSENCIAL
    # ==========================================
    
    pump_switch:
      name: üîå Switch da Bomba
      description: |
        **[OBRIGAT√ìRIO]** Entidade para ligar/desligar a bomba da piscina.
        **Exemplo:** `switch.bomba_piscina_switch_0`
      selector:
        entity:
          domain: switch

    pump_nominal_power:
      name: üí™ Pot√™ncia Nominal da Bomba (W)
      description: |
        Pot√™ncia nominal da bomba em Watts.
        **Como calcular:** Amperes √ó 230V (ex: 6A √ó 230V = 1380W)
        Usado para c√°lculos de previs√£o e custos.
      default: 1380
      selector:
        number:
          min: 100
          max: 5000
          step: 10
          unit_of_measurement: "W"
          mode: box

    pump_actual_power:
      name: ‚ö° Sensor Consumo Real da Bomba (opcional)
      description: |
        Sensor opcional do consumo atual da bomba em Watts.
        Melhora precis√£o usando consumo real em vez do nominal.
        **Exemplo:** `sensor.bomba_piscina_power`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    # ==========================================
    # SEC√á√ÉO 2: NOVIDADE V6 - MODO H√çBRIDO
    # ==========================================

    hybrid_mode_enabled:
      name: üîÄ Ativar Modo H√≠brido
      description: |
        **NOVIDADE v6!** Combina solar (dia) + Coopernico (noite).
        
        **Como funciona:**
        - ‚òÄÔ∏è DIA: Liga com excedente solar (l√≥gica v4)
        - üåô NOITE: Liga na janela Coopernico mais barata (v5)
        - üîÑ Coordena√ß√£o autom√°tica sem conflitos
        
        **Se DESATIVADO:** Funciona apenas modo dia (como v4)
      default: true
      selector:
        boolean: {}

    # ==========================================
    # SEC√á√ÉO 3: COOPERNICO (MODO NOITE)
    # ==========================================

    use_coopernico_optimization:
      name: üí∞ Usar Otimiza√ß√£o Coopernico (Noite)
      description: |
        Calcula automaticamente a janela de tempo mais barata √† noite.
        
        **Requer:** 
        - Modo H√≠brido ativado
        - Sensor Coopernico configurado abaixo
        - Helpers criados (datetime, boolean, text)
        
        **Poupan√ßa t√≠pica:** 5-15% vs hor√°rio fixo
      default: false
      selector:
        boolean: {}

    coopernico_price_sensor:
      name: üí∂ Sensor Pre√ßos Coopernico
      description: |
        Sensor com pre√ßos din√¢micos em intervalos de 15 minutos.
        **Exemplo:** `sensor.coopernico_base_bi_horario_ciclo_diario_all_prices`
      default: {}
      selector:
        entity:
          domain: sensor

    cheapest_window_helper:
      name: üïê Helper Hora Agendada
      description: |
        Input datetime para guardar hora calculada mais barata.
        **Exemplo:** `input_datetime.piscina_hora_agendada_mais_barata`
      default: input_datetime.piscina_hora_agendada_mais_barata
      selector:
        entity:
          domain: input_datetime

    coopernico_end_helper:
      name: üèÅ Helper Fim Janela Coopernico
      description: |
        Input datetime para guardar hora calculada de FIM da janela Coopernico.
        Preenchido automaticamente quando a janela inicia (start + dura√ß√£o).
        **Exemplo:** `input_datetime.piscina_fim_janela_coopernico`
      default: input_datetime.piscina_fim_janela_coopernico
      selector:
        entity:
          domain: input_datetime

    night_session_active_helper:
      name: üîí Helper Sess√£o Noturna
      description: |
        Input boolean para controlar sess√£o noturna ativa.
        **Exemplo:** `input_boolean.piscina_sessao_noturna_ativa`
      default: input_boolean.piscina_sessao_noturna_ativa
      selector:
        entity:
          domain: input_boolean

    night_session_done_helper:
      name: ‚úÖ Helper Sess√£o Noturna Completa
      description: |
        Input boolean para marcar sess√£o noturna como completa.
        **Exemplo:** `input_boolean.piscina_night_session_done`
      default: input_boolean.piscina_night_session_done
      selector:
        entity:
          domain: input_boolean

    calculation_info_helper:
      name: üìä Helper Info C√°lculo (opcional)
      description: |
        Input text para guardar info do √∫ltimo c√°lculo.
        **Exemplo:** `input_text.piscina_ultima_janela_calculada`
      default: input_text.piscina_ultima_janela_calculada
      selector:
        entity:
          domain: input_text

    calculation_time:
      name: ‚è∞ Hora do C√°lculo Coopernico
      description: |
        Hora para calcular janela mais barata (antes da noite).
        **Recomendado:** 19:00-20:00
      default: "19:00:00"
      selector:
        time: {}

    # ==========================================
    # SEC√á√ÉO 4: SENSORES DE POT√äNCIA (6 n√≠veis)
    # ==========================================

    net_power_5min:
      name: üìä Pot√™ncia NET - M√©dia 5min
      description: |
        **[PRIORIDADE 1]** Sensor NET com m√©dia de 5 minutos.
        Positivo = importa√ß√£o, Negativo = exporta√ß√£o.
        **Exemplo:** `sensor.import_export_5min_smooth`
      default: {}
      selector:
        entity:
          domain: sensor

    house_power_no_pump_5min:
      name: üè† Consumo Casa (SEM bomba) - M√©dia 5min
      description: |
        **[PRIORIDADE 2]** Consumo casa EXCLUINDO bomba, m√©dia 5min.
        **Exemplo:** `sensor.house_power_5min_smooth`
      default: {}
      selector:
        entity:
          domain: sensor

    pv_power_5min:
      name: ‚òÄÔ∏è Produ√ß√£o Solar (PV) - M√©dia 5min
      description: |
        **[PRIORIDADE 2]** Produ√ß√£o solar com m√©dia 5min.
        **Exemplo:** `sensor.solar_power_5min_smooth`
      default: {}
      selector:
        entity:
          domain: sensor

    export_power_5min:
      name: üì§ Exporta√ß√£o - M√©dia 5min
      description: |
        **[PRIORIDADE 3]** Exporta√ß√£o para rede, m√©dia 5min.
        **Exemplo:** `sensor.export_power_5min_smooth`
      default: {}
      selector:
        entity:
          domain: sensor

    net_power:
      name: üìä Pot√™ncia NET - Instant√¢neo
      description: |
        **[PRIORIDADE 4]** Sensor NET instant√¢neo (fallback).
        **Exemplo:** `sensor.emoncms_import_export`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    house_power_no_pump:
      name: üè† Consumo Casa - Instant√¢neo
      description: |
        **[PRIORIDADE 5]** Consumo casa instant√¢neo.
        **Exemplo:** `sensor.emoncms_use_no_pool_pump`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    pv_power:
      name: ‚òÄÔ∏è Produ√ß√£o Solar - Instant√¢neo
      description: |
        **[PRIORIDADE 5]** Produ√ß√£o solar instant√¢nea.
        **Exemplo:** `sensor.emoncms_solar`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    export_power:
      name: üì§ Exporta√ß√£o - Instant√¢neo
      description: |
        **[PRIORIDADE 6]** Exporta√ß√£o instant√¢nea.
        **Exemplo:** `sensor.emoncms_export_power_positive`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power

    # ==========================================
    # SEC√á√ÉO 5: FILTRA√á√ÉO DIN√ÇMICA
    # ==========================================

    use_dynamic_filtration_time:
      name: üå°Ô∏è Usar Tempo Din√¢mico de Filtragem
      description: |
        Se ATIVADO, usa sensor de tempo baseado em temperatura.
        Se DESATIVADO, usa valor fixo de energia.
      default: true
      selector:
        boolean: {}

    dynamic_filtration_hours_sensor:
      name: üå°Ô∏è Sensor Tempo Recomendado (horas)
      description: |
        Sensor que calcula horas baseado em temperatura.
        **Exemplo:** `sensor.piscina_tempo_de_filtracao_recomendado`
      default: {}
      selector:
        entity:
          domain: sensor

    min_daily_filtration_kwh:
      name: ‚ö° Energia M√≠nima Di√°ria (kWh) - FIXO
      description: |
        Energia fixa se tempo din√¢mico desativado.
        **Exemplo:** 8h √ó 1.38kW = 11 kWh
      default: 11
      selector:
        number:
          min: 1
          max: 25
          step: 0.5
          unit_of_measurement: "kWh"
          mode: slider

    filtration_energy_today:
      name: üìä Energia Filtra√ß√£o Hoje
      description: |
        Sensor com kWh j√° consumidos hoje.
        **Exemplo:** `sensor.bomba_piscina_energy_today`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: energy

    filtration_hours_today_sensor:
      name: ‚è±Ô∏è Horas Filtra√ß√£o Hoje (08-08)
      description: |
        Sensor com horas ON no per√≠odo 08:00-08:00.
        Usado para calcular d√©fice CORRETO excluindo sess√µes noturnas.
        Se configurado, tem prioridade sobre o sensor de energia para c√°lculo do d√©fice.
        **Exemplo:** `sensor.piscina_horas_on_08_08`
      default: {}
      selector:
        entity:
          domain: sensor

    ignore_filtration_limit:
      name: ‚ôæÔ∏è Ignorar Limite de Filtragem (Dia)
      description: |
        Se ATIVADO, bomba liga com excedente solar MESMO ap√≥s meta cumprida.
        ‚úÖ **Vantagens:** M√°ximo autoconsumo
        ‚ö†Ô∏è **Aten√ß√£o:** Pode causar sobre-filtragem
      default: false
      selector:
        boolean: {}

    min_night_deficit_kwh:
      name: ‚ö° D√©fice M√≠nimo para Noite (kWh)
      description: |
        S√≥ liga √† noite se d√©fice > este valor.
        **Recomendado:** 1.5-2.5 kWh
      default: 2
      selector:
        number:
          min: 0.5
          max: 8
          step: 0.5
          unit_of_measurement: "kWh"
          mode: slider

    # ==========================================
    # SEC√á√ÉO 6: FILTRAGEM NOTURNA
    # ==========================================

    enable_night_auto:
      name: üåô Ligar Automaticamente √† Noite
      description: |
        Se ativado, completa filtragem √† noite.
        - Com Coopernico: usa janela mais barata
        - Sem Coopernico: usa hor√°rio fixo (fallback)
      default: false
      selector:
        boolean: {}

    night_start_time:
      name: üïô In√≠cio Hor√°rio Vazio (fallback)
      description: |
        Hora in√≠cio vazio (usado se Coopernico n√£o configurado).
        **T√≠pico:** 22:00
      default: "22:00:00"
      selector:
        time: {}

    night_end_time:
      name: üïó Fim Hor√°rio Vazio
      description: |
        Hora fim do vazio (failsafe desliga se ainda ligada).
        **T√≠pico:** 08:00
      default: "08:00:00"
      selector:
        time: {}

    # ==========================================
    # SEC√á√ÉO 7: OTIMIZA√á√ÉO ECON√ìMICA (DIA)
    # ==========================================

    use_economic_optimization:
      name: üìä Usar Otimiza√ß√£o Econ√≥mica (Dia)
      description: |
        Calcula break-even dia vs noite.
        **Recomendado:** Ativar para tarifas bi-hor√°rias.
      default: true
      selector:
        boolean: {}

    price_peak:
      name: üí∂ Pre√ßo Fora-Vazio FALLBACK (‚Ç¨/kWh)
      description: |
        Pre√ßo durante o dia (FALLBACK).
        **S√≥ usado quando o sensor Coopernico n√£o est√° dispon√≠vel.**
        Com tarifa indexada, o pre√ßo real √© obtido automaticamente do sensor Coopernico.
        **T√≠pico PT:** 0.15-0.18 ‚Ç¨/kWh
      default: 0.1537
      selector:
        number:
          min: 0
          max: 1
          step: 0.001
          unit_of_measurement: "‚Ç¨/kWh"
          mode: box

    price_offpeak:
      name: üí∂ Pre√ßo Vazio FALLBACK (‚Ç¨/kWh)
      description: |
        Pre√ßo √† noite (FALLBACK).
        **S√≥ usado quando o sensor Coopernico n√£o est√° dispon√≠vel.**
        Com tarifa indexada, o pre√ßo real √© obtido automaticamente do sensor Coopernico.
        **T√≠pico PT:** 0.08-0.10 ‚Ç¨/kWh
      default: 0.0929
      selector:
        number:
          min: 0
          max: 1
          step: 0.001
          unit_of_measurement: "‚Ç¨/kWh"
          mode: box

    import_limit:
      name: üìà Limite Importa√ß√£o M√°xima (W) - Dia
      description: |
        Importa√ß√£o m√°xima para manter ligada de dia.
        **Recomendado:** 500-800W
      default: 700
      selector:
        number:
          min: 0
          max: 2000
          step: 50
          unit_of_measurement: "W"
          mode: slider

    start_margin:
      name: üöÄ Margem Extra para Arranque (W) - Dia
      description: |
        Margem extra de exporta√ß√£o exigida para ligar (al√©m do import_limit).
        Cria hysteresis assim√©trica: mais dif√≠cil ligar que manter ligada.
        **Ind√∫stria recomenda:** 200-400W (evita ligar "por pouco")
        **Exemplo:** Com import_limit=700W e start_margin=300W,
        a bomba s√≥ liga se import_predicted ‚â§ 400W (700-300).
      default: 300
      selector:
        number:
          min: 0
          max: 1000
          step: 25
          unit_of_measurement: "W"
          mode: slider

    import_limit_strategy:
      name: üéØ Estrat√©gia Limite Importa√ß√£o (Dia)
      description: |
        - **maior**: max(import_limit, break_even) ‚Üí ver√£o
        - **menor**: min(import_limit, break_even) ‚Üí primavera/outono
        - **import_limit**: fixo ‚Üí controlo manual
        - **break_even**: s√≥ economia ‚Üí inverno
      default: "maior"
      selector:
        select:
          options:
            - label: "MAIOR (max auto-consumo)"
              value: "maior"
            - label: "MENOR (balan√ßo)"
              value: "menor"
            - label: "IMPORT_LIMIT (fixo)"
              value: "import_limit"
            - label: "BREAK_EVEN (economia)"
              value: "break_even"

    # ==========================================
    # SEC√á√ÉO 8: DELAYS E TIMINGS
    # ==========================================

    delay_on:
      name: ‚è±Ô∏è Delay para Ligar (segundos) - Dia
      description: |
        Tempo de espera antes de ligar de dia.
        **Recomendado:** 20-60s
      default: 30
      selector:
        number:
          min: 0
          max: 300
          step: 5
          unit_of_measurement: "s"
          mode: slider

    delay_off:
      name: ‚è±Ô∏è Delay para Desligar (segundos) - Dia
      description: |
        Tempo de espera antes de desligar de dia.
        **Recomendado:** 45-90s
      default: 60
      selector:
        number:
          min: 0
          max: 300
          step: 5
          unit_of_measurement: "s"
          mode: slider

    min_on_time:
      name: ‚è∞ Tempo M√≠nimo Ligada (minutos)
      description: |
        Tempo m√≠nimo que a bomba fica ligada ap√≥s arranque.
        Protege contra cycling excessivo ‚Äî nuvens passageiras (<5min) s√£o absorvidas.
        **Ind√∫stria recomenda:** 20-30min (Pentair/Hayward spec)
        **Afectado pelo multiplicador meteo** (nublado ‚Üí tempo √ó multiplier)
      default: 20
      selector:
        number:
          min: 0
          max: 60
          step: 1
          unit_of_measurement: "min"
          mode: slider

    min_off_time:
      name: ‚è∞ Tempo M√≠nimo Desligada (minutos)
      description: |
        Cooldown obrigat√≥rio ap√≥s desligar antes de permitir religar.
        Protege contra cycling excessivo e picos de inrush current.
        **Ind√∫stria recomenda:** 15-20min para bombas de velocidade fixa
        **Afectado pelo multiplicador meteo** (nublado ‚Üí tempo √ó multiplier)
        **0** = sem cooldown (n√£o recomendado)
      default: 15
      selector:
        number:
          min: 0
          max: 60
          step: 1
          unit_of_measurement: "min"
          mode: slider

    max_daily_starts:
      name: üîÑ M√°ximo Arranques por Dia
      description: |
        Limite hard de quantas vezes a bomba pode ligar por dia (per√≠odo 08-22h).
        **Ind√∫stria recomenda:** 6-8 para bombas de velocidade fixa
        Ap√≥s atingir o limite, a bomba s√≥ religa na sess√£o noturna ou no dia seguinte.
        **0** = sem limite (n√£o recomendado, comportamento anterior)
      default: 8
      selector:
        number:
          min: 0
          max: 30
          step: 1
          unit_of_measurement: "arranques"
          mode: slider

    delay_multiplier_sensor:
      name: üå§Ô∏è Multiplicador de Delay (opcional)
      description: |
        Sensor que ajusta delays baseado no tempo.
        - C√©u limpo: 1.0√ó - Nublado: 1.5√ó - Inst√°vel: 2.0√ó
        **Exemplo:** `sensor.piscina_weather_delay_multiplier`
      default: {}
      selector:
        entity:
          domain: sensor

    # ==========================================
    # SEC√á√ÉO 9: HOR√ÅRIOS SOLARES
    # ==========================================

    sun_offset_start:
      name: üåÖ Offset Ap√≥s Nascer do Sol (min)
      description: |
        Minutos ap√≥s nascer do sol para come√ßar monitoriza√ß√£o solar.
        **Nota:** Valor em minutos, convertido internamente para segundos.
        **Recomendado:** 30 min
      default: 30
      selector:
        number:
          min: 0
          max: 180
          step: 5
          unit_of_measurement: "min"
          mode: slider

    sun_offset_end:
      name: üåá Offset P√¥r do Sol (min)
      description: |
        Minutos relativos ao p√¥r do sol para parar e desligar bomba.
        **Use valor negativo** para parar ANTES do p√¥r do sol.
        Exemplo: -30 = para 30 min antes do p√¥r do sol.
        **Recomendado:** -30 min
      default: -30
      selector:
        number:
          min: -180
          max: 60
          step: 5
          unit_of_measurement: "min"
          mode: slider

    # ==========================================
    # SEC√á√ÉO 10: CONTROLO E DEBUG
    # ==========================================

    override_manual:
      name: üîß Override Manual
      description: |
        Input boolean para modo manual.
        **Exemplo:** `input_boolean.piscina_manual_mode`
      default: {}
      selector:
        entity:
          domain: input_boolean

    enable_debug_logs:
      name: üîç Logs de Diagn√≥stico
      description: |
        Ativa logs detalhados.
        Logger: `blueprints.piscina_solar_v6`
      default: false
      selector:
        boolean: {}

    dry_run_mode:
      name: üß™ Modo Dry Run (Teste)
      description: |
        Testa l√≥gica SEM controlar a bomba.
        √ötil para validar configura√ß√£o.
      default: false
      selector:
        boolean: {}

# ==========================================
# VARI√ÅVEIS GLOBAIS
# ==========================================
variables:
  # Inputs base
  pump_entity: !input pump_switch
  pump_power: !input pump_nominal_power
  pump_power_sensor: !input pump_actual_power
  dry_run: !input dry_run_mode
  debug: !input enable_debug_logs
  
  # Modo H√≠brido
  hybrid_mode: !input hybrid_mode_enabled
  
  # Coopernico
  use_coopernico: !input use_coopernico_optimization
  coopernico_sensor: !input coopernico_price_sensor
  cheapest_helper: !input cheapest_window_helper
  coopernico_end: !input coopernico_end_helper
  session_helper: !input night_session_active_helper
  night_done_helper: !input night_session_done_helper
  info_helper: !input calculation_info_helper
  
  # Filtra√ß√£o
  use_dynamic: !input use_dynamic_filtration_time
  dynamic_sensor: !input dynamic_filtration_hours_sensor
  fixed_kwh: !input min_daily_filtration_kwh
  energy_today_sensor: !input filtration_energy_today
  hours_today_sensor: !input filtration_hours_today_sensor
  ignore_limit: !input ignore_filtration_limit
  min_deficit: !input min_night_deficit_kwh
  enable_night_auto: !input enable_night_auto
  
  # Hor√°rios
  night_start: !input night_start_time
  night_end: !input night_end_time
  calc_time: !input calculation_time
  
  # Pre√ßos
  price_peak_val: !input price_peak
  price_offpeak_val: !input price_offpeak
  use_econ_opt: !input use_economic_optimization
  
  # Limites e estrat√©gia
  import_limit_val: !input import_limit
  start_margin_val: !input start_margin
  limit_strategy: !input import_limit_strategy
  
  # Delays
  delay_on_val: !input delay_on
  delay_off_val: !input delay_off
  min_on_time_val: !input min_on_time
  min_off_time_val: !input min_off_time
  max_daily_starts_val: !input max_daily_starts
  delay_mult_sensor: !input delay_multiplier_sensor
  
  # Sensores pot√™ncia (hierarquia 6 n√≠veis)
  net_5min: !input net_power_5min
  house_5min: !input house_power_no_pump_5min
  pv_5min: !input pv_power_5min
  export_5min: !input export_power_5min
  net_inst: !input net_power
  house_inst: !input house_power_no_pump
  pv_inst: !input pv_power
  export_inst: !input export_power
  
  # Override manual
  manual_override: !input override_manual

  # ==========================================
  # ESTADO DA BOMBA
  # ==========================================
  pump_is_on: "{{ is_state(pump_entity, 'on') }}"
  
  # Consumo real ou nominal
  pump_current_power: >
    {% if pump_power_sensor != {} and states(pump_power_sensor) not in ['unavailable', 'unknown', 'none'] %}
      {{ states(pump_power_sensor) | float(pump_power) }}
    {% else %}
      {{ pump_power }}
    {% endif %}

  # ==========================================
  # C√ÅLCULO D√âFICE FILTRAGEM
  # ==========================================
  
  # Target kWh
  target_kwh: >
    {% if use_dynamic and dynamic_sensor != {} %}
      {% set hours = states(dynamic_sensor) | float(8) %}
      {{ (hours * (pump_power / 1000)) | round(2) }}
    {% else %}
      {{ fixed_kwh }}
    {% endif %}
  
  # Energia j√° consumida hoje
  # PRIORIDADE: horas_today_sensor (08-08) > energy_today_sensor (00-24)
  # O sensor de horas 08-08 exclui sess√µes noturnas, evitando falsos "sem d√©fice"
  energy_consumed: >
    {% if hours_today_sensor != {} %}
      {% set hours_done = states(hours_today_sensor) | float(0) %}
      {{ (hours_done * (pump_power / 1000)) | round(2) }}
    {% elif energy_today_sensor != {} %}
      {{ states(energy_today_sensor) | float(0) }}
    {% else %}
      0
    {% endif %}
  
  # D√©fice restante em kWh
  deficit_kwh: >
    {{ [target_kwh - energy_consumed, 0] | max | round(2) }}
  
  # Horas restantes a filtrar
  deficit_hours: >
    {{ (deficit_kwh / (pump_power / 1000)) | round(2) }}
  
  # ==========================================
  # HIERARCHIA SENSORES (6 n√≠veis)
  # ==========================================
  
  # N√≠vel selecionado (1-6)
  sensor_level: >
    {% if net_5min != {} %}
      1
    {% elif house_5min != {} and pv_5min != {} %}
      2
    {% elif export_5min != {} %}
      3
    {% elif net_inst != {} %}
      4
    {% elif house_inst != {} and pv_inst != {} %}
      5
    {% elif export_inst != {} %}
      6
    {% else %}
      0
    {% endif %}
  
  # Pot√™ncia NET atual (baseado no n√≠vel)
  current_net_power: >
    {% set level = sensor_level | int %}
    {% if level == 1 %}
      {{ states(net_5min) | float(0) }}
    {% elif level == 2 %}
      {% set house = states(house_5min) | float(0) %}
      {% set pv = states(pv_5min) | float(0) %}
      {{ (house - pv) | round(0) }}
    {% elif level == 3 %}
      {% set export = states(export_5min) | float(0) %}
      {{ (0 - export) | round(0) }}
    {% elif level == 4 %}
      {{ states(net_inst) | float(0) }}
    {% elif level == 5 %}
      {% set house = states(house_inst) | float(0) %}
      {% set pv = states(pv_inst) | float(0) %}
      {{ (house - pv) | round(0) }}
    {% elif level == 6 %}
      {% set export = states(export_inst) | float(0) %}
      {{ (0 - export) | round(0) }}
    {% else %}
      0
    {% endif %}
  
  # Previs√£o importa√ß√£o COM bomba
  import_predicted: >
    {{ (current_net_power + pump_current_power) | round(0) }}

  # ==========================================
  # BREAK-EVEN ECON√ìMICO (DIN√ÇMICO)
  # ==========================================
  
  # Pre√ßo diurno REAL: Coopernico com IVA (price_w_vat) ou fallback fixo
  price_current_day: >
    {% if coopernico_sensor != {} %}
      {% set prices = state_attr(coopernico_sensor, 'prices') | default([]) %}
      {% if prices | length > 0 %}
        {% set now_ts = now() %}
        {% set ns = namespace(found=0) %}
        {% for p in prices %}
          {% set p_dt = p.datetime | as_datetime %}
          {% if p_dt is not none %}
            {% set diff = (now_ts - p_dt).total_seconds() %}
            {% if diff >= 0 and diff < 900 %}
              {% set ns.found = p.price_w_vat | float(0) %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ ns.found if ns.found > 0 else price_peak_val }}
      {% else %}
        {{ price_peak_val }}
      {% endif %}
    {% else %}
      {{ price_peak_val }}
    {% endif %}
  
  # Pre√ßo noturno REAL: m√©dia dos pre√ßos vazio dispon√≠veis (22h-08h) com IVA
  price_cheapest_night: >
    {% if coopernico_sensor != {} %}
      {% set prices = state_attr(coopernico_sensor, 'prices') | default([]) %}
      {% if prices | length > 0 %}
        {% set ns = namespace(night_prices=[]) %}
        {% for p in prices %}
          {% set p_dt = p.datetime | as_datetime %}
          {% if p_dt is not none %}
            {% set hour = p_dt.hour %}
            {% if hour >= 22 or hour < 8 %}
              {% set ns.night_prices = ns.night_prices + [p.price_w_vat | float(0)] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if ns.night_prices | length > 0 %}
          {{ (ns.night_prices | sum / ns.night_prices | length) | round(5) }}
        {% else %}
          {{ price_offpeak_val }}
        {% endif %}
      {% else %}
        {{ price_offpeak_val }}
      {% endif %}
    {% else %}
      {{ price_offpeak_val }}
    {% endif %}
  
  # Break-even: importa√ß√£o m√°xima (W) onde custo dia = custo noite
  # F√≥rmula: X = price_night * pump_power / price_day
  # Se importar at√© X watts, o custo diurno ‚â§ custo noturno
  break_even_import_w: >
    {% if use_econ_opt %}
      {% set p_day = price_current_day | float(price_peak_val) %}
      {% set p_night = price_cheapest_night | float(price_offpeak_val) %}
      {% if p_day > 0 %}
        {{ (p_night * pump_power / p_day) | round(0) }}
      {% else %}
        {{ import_limit_val }}
      {% endif %}
    {% else %}
      {{ import_limit_val }}
    {% endif %}
  
  # Limite final baseado na estrat√©gia
  final_import_limit: >
    {% set break_even = break_even_import_w | int %}
    {% set config_limit = import_limit_val | int %}
    {% if limit_strategy == 'maior' %}
      {{ [break_even, config_limit] | max }}
    {% elif limit_strategy == 'menor' %}
      {{ [break_even, config_limit] | min }}
    {% elif limit_strategy == 'break_even' %}
      {{ break_even }}
    {% else %}
      {{ config_limit }}
    {% endif %}

  # ==========================================
  # DELAYS DIN√ÇMICOS
  # ==========================================
  
  delay_multiplier: >
    {% if delay_mult_sensor != {} %}
      {{ states(delay_mult_sensor) | float(1.0) }}
    {% else %}
      1.0
    {% endif %}
  
  final_delay_on: >
    {{ (delay_on_val * delay_multiplier) | round(0) }}
  
  final_delay_off: >
    {{ (delay_off_val * delay_multiplier) | round(0) }}

  # ==========================================
  # CONDI√á√ïES DE LIGA√á√ÉO (DIA)
  # ==========================================
  
  # Pode ligar? (previs√£o importa√ß√£o OK)
  can_turn_on: >
    {{ import_predicted <= (final_import_limit - start_margin_val) }}
  
  # Pode manter? (importa√ß√£o atual OK)
  can_keep_on: >
    {{ import_predicted <= final_import_limit }}
  
  # Tem d√©fice suficiente?
  has_deficit: >
    {{ deficit_kwh > 0.1 or ignore_limit }}
  
  # Tempo m√≠nimo ligada respeitado? (com multiplicador meteo)
  min_time_elapsed: >
    {% set last_changed = as_timestamp(states.switch[pump_entity.split('.')[1]].last_changed) %}
    {% set now_ts = as_timestamp(now()) %}
    {% set min_on_seconds = (min_on_time_val | float(0)) * 60 * (delay_multiplier | float(1.0)) %}
    {{ (now_ts - last_changed) >= min_on_seconds }}

  # Cooldown ap√≥s desligar respeitado? (anti-cycling, com multiplicador meteo)
  min_off_time_elapsed: >
    {% set last_changed = as_timestamp(states.switch[pump_entity.split('.')[1]].last_changed) %}
    {% set now_ts = as_timestamp(now()) %}
    {% set min_off_seconds = (min_off_time_val | float(0)) * 60 * (delay_multiplier | float(1.0)) %}
    {{ not pump_is_on and (now_ts - last_changed) >= min_off_seconds or pump_is_on or min_off_time_val == 0 }}

  # Contagem de arranques diurnos hoje (08:00-22:00)
  # Conta transi√ß√µes OFF‚ÜíON no hist√≥rico do switch hoje
  daily_starts_count: >
    {{ states.counter.piscina_daily_starts.state | int(0) if states.counter.piscina_daily_starts is defined else 0 }}

  # Limite de arranques di√°rios respeitado?
  daily_starts_ok: >
    {{ max_daily_starts_val | int(0) == 0 or daily_starts_count < max_daily_starts_val | int(8) }}

  # Previs√£o solar bloqueia filtragem diurna?
  # Se input_boolean.piscina_prefer_night_filtering = ON,
  # a previs√£o Solcast indicou que hoje n√£o h√° janela solar vi√°vel.
  # ‚Üí N√£o tentar ligar a bomba de dia (evita cycling in√∫til).
  forecast_allows_solar: >
    {{ not is_state('input_boolean.piscina_prefer_night_filtering', 'on')
       or not is_state('input_boolean.piscina_forecast_planning_enabled', 'on') }}

  # ==========================================
  # COOPERNICO: C√°lculo janela mais barata
  # ==========================================
  
  coopernico_prices: >
    {% if coopernico_sensor != {} and use_coopernico %}
      {{ state_attr(coopernico_sensor, 'prices') | default([]) }}
    {% else %}
      []
    {% endif %}
  
  # Filtrar pre√ßos noturnos (22h-08h)
  night_prices: >
    {% set prices = coopernico_prices %}
    {% if prices | length > 0 %}
      {% set ns = namespace(filtered=[]) %}
      {% for p in prices %}
        {% set datetime_str = p.datetime | string %}
        {% set time_part = datetime_str.split('T')[1].split('+')[0] if 'T' in datetime_str else datetime_str.split(' ')[1].split('+')[0] %}
        {% set hour = time_part.split(':')[0] | int %}
        {% if hour >= 22 or hour < 8 %}
          {% set ns.filtered = ns.filtered + [p] %}
        {% endif %}
      {% endfor %}
      {{ ns.filtered }}
    {% else %}
      []
    {% endif %}
  
  # Sliding Window: encontrar slots mais baratos
  cheapest_result: >
    {% set prices = night_prices %}
    {% set deficit_h = deficit_hours %}
    
    {% if prices | length == 0 or deficit_h <= 0 %}
      {{ {'start_time': night_start, 'avg_price': price_offpeak_val, 'found': false} }}
    {% else %}
      {% set slots_needed = (deficit_h * 4) | round(0, 'ceil') | int %}
      {% set max_slots = 40 %}
      {% set slots_needed = [slots_needed, max_slots] | min %}
      
      {% if slots_needed > prices | length %}
        {{ {'start_time': night_start, 'avg_price': price_offpeak_val, 'found': false} }}
      {% else %}
        {% set ns = namespace(best_start=0, best_avg=999, best_time='') %}
        
        {% for i in range(0, (prices | length) - slots_needed + 1) %}
          {% set window = prices[i:i+slots_needed] %}
          {% set avg_price = (window | map(attribute='price_w_vat') | sum) / (window | length) %}
          
          {% if avg_price < ns.best_avg %}
            {% set ns.best_avg = avg_price %}
            {% set ns.best_start = i %}
            {% set datetime_str = window[0].datetime | string %}
            {% set time_part = datetime_str.split('T')[1].split('+')[0] if 'T' in datetime_str else datetime_str.split(' ')[1].split('+')[0] %}
            {% set ns.best_time = time_part %}
          {% endif %}
        {% endfor %}
        
        {{ {
          'start_time': ns.best_time,
          'avg_price': ns.best_avg,
          'total_cost': (ns.best_avg * deficit_h * (pump_power / 1000)) | round(3),
          'duration_hours': deficit_h,
          'found': true
        } }}
      {% endif %}
    {% endif %}

  # ==========================================
  # MODO ATUAL (Dia ou Noite)
  # ==========================================
  
  current_mode: >
    {% set now_hour = now().hour %}
    {% set night_start_str = night_start | string %}
    {% set night_end_str = night_end | string %}
    {% set night_start_hour = night_start_str.split(':')[0] | int %}
    {% set night_end_hour = night_end_str.split(':')[0] | int %}
    
    {% if now_hour >= night_start_hour or now_hour < night_end_hour %}
      night
    {% else %}
      day
    {% endif %}

# ==========================================
# TRIGGERS
# ==========================================
trigger:
  # ========== TRIGGERS COOPERNICO (NOITE) ==========
  
  # 1. C√°lculo di√°rio janela mais barata
  - platform: time
    at: !input calculation_time
    id: daily_calculation
  
  # 2. Hora agendada Coopernico
  - platform: time
    at: !input cheapest_window_helper
    id: cheapest_scheduled_time
  
  # 2.5. Fim janela Coopernico (calculado automaticamente)
  - platform: time
    at: !input coopernico_end_helper
    id: coopernico_window_end
  
  # 3. Fallback in√≠cio noite
  - platform: time
    at: !input night_start_time
    id: night_fallback_start
  
  # 4. Fim per√≠odo noturno
  - platform: time
    at: !input night_end_time
    id: night_end
  
  # ========== TRIGGERS SOLARES (DIA) ==========
  
  # 5. Nascer do sol
  - platform: sun
    event: sunrise
    offset:
      minutes: !input sun_offset_start
    id: sunrise
  
  # 6. P√¥r do sol (offset negativo = antes)
  - platform: sun
    event: sunset
    offset:
      minutes: !input sun_offset_end
    id: sunset
  
  # 7-8. Monitoriza√ß√£o pot√™ncia (DIA)
  - platform: state
    entity_id: !input net_power_5min
    id: power_change_5min
  
  - platform: state
    entity_id: !input net_power
    id: power_change_inst
  
  # 9. Mudan√ßa estado bomba (para min_on_time)
  - platform: state
    entity_id: !input pump_switch
    id: pump_state_change

# ==========================================
# CONDITIONS
# ==========================================
condition:
  # Respeitar override manual
  - condition: template
    value_template: >
      {{ manual_override == {} or not is_state(manual_override, 'on') }}

# ==========================================
# ACTIONS
# ==========================================
action:
  - choose:
      # ==========================================
      # ACTION 1: C√ÅLCULO COOPERNICO (19h)
      # ==========================================
      - conditions:
          - condition: trigger
            id: daily_calculation
          - condition: template
            value_template: "{{ hybrid_mode and use_coopernico }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ coopernico_sensor != {} and cheapest_helper != {} }}"
            then:
              # Calcular e guardar hora
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input cheapest_window_helper
                data:
                  time: "{{ cheapest_result.start_time }}"
              
              # Guardar info c√°lculo
              - if:
                  - condition: template
                    value_template: "{{ info_helper != {} }}"
                then:
                  - service: input_text.set_value
                    target:
                      entity_id: !input calculation_info_helper
                    data:
                      value: >
                        {% set r = cheapest_result %}
                        {% if r.found %}
                          {{ r.start_time }} | {{ r.avg_price | round(5) }}‚Ç¨/kWh | {{ r.total_cost }}‚Ç¨ | {{ r.duration_hours }}h
                        {% else %}
                          Fallback: {{ night_start }} (sem dados)
                        {% endif %}
              
              # Log
              - if:
                  - condition: template
                    value_template: "{{ debug }}"
                then:
                  - service: logbook.log
                    data:
                      name: "Piscina v6 - C√°lculo Coopernico"
                      message: >
                        Janela: {{ cheapest_result.start_time }}
                        Pre√ßo: {{ cheapest_result.avg_price | round(5) }}‚Ç¨/kWh
                        Custo: {{ cheapest_result.total_cost }}‚Ç¨
                        Dura√ß√£o: {{ cheapest_result.duration_hours }}h
                      entity_id: !input pump_switch

      # ==========================================
      # ACTION 2: LIGA NA HORA AGENDADA (NOITE)
      # ==========================================
      - conditions:
          - condition: trigger
            id: cheapest_scheduled_time
          - condition: template
            value_template: "{{ hybrid_mode and use_coopernico and enable_night_auto }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ deficit_kwh >= min_deficit }}"
              - condition: template
                value_template: "{{ not is_state(session_helper, 'on') }}"
            then:
              # Ativar session lock
              - service: input_boolean.turn_on
                target:
                  entity_id: !input night_session_active_helper
              
              # Ligar bomba
              - if:
                  - condition: template
                    value_template: "{{ not dry_run }}"
                then:
                  - service: switch.turn_on
                    target:
                      entity_id: !input pump_switch
              
              # Log
              - if:
                  - condition: template
                    value_template: "{{ debug }}"
                then:
                  - service: logbook.log
                    data:
                      name: "Piscina v6 - Coopernico ON"
                      message: >
                        üí∞ NOITE: Bomba ligada na janela mais barata
                        D√©fice: {{ deficit_kwh }}kWh ({{ deficit_hours }}h)
                        {% if dry_run %}[DRY RUN]{% endif %}
                      entity_id: !input pump_switch
              
              # Calcular e guardar hora de fim da janela
              - service: input_datetime.set_datetime
                target:
                  entity_id: !input coopernico_end_helper
                data:
                  time: >
                    {% set duration_sec = (cheapest_result.duration_hours * 3600) | int %}
                    {% set end_time = now() + timedelta(seconds=duration_sec) %}
                    {{ end_time.strftime('%H:%M:%S') }}
              
              - if:
                  - condition: template
                    value_template: "{{ debug }}"
                then:
                  - service: logbook.log
                    data:
                      name: "Piscina v6 - Coopernico Timer"
                      message: >
                        ‚è±Ô∏è Fim janela agendado para {{ 
                          (now() + timedelta(seconds=(cheapest_result.duration_hours * 3600) | int)).strftime('%H:%M') 
                        }} ({{ cheapest_result.duration_hours }}h)
                      entity_id: !input pump_switch

      # ==========================================
      # ACTION 3: FALLBACK HOR√ÅRIO FIXO (NOITE)
      # ==========================================
      - conditions:
          - condition: trigger
            id: night_fallback_start
          - condition: template
            value_template: "{{ (not use_coopernico or not hybrid_mode) and enable_night_auto }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ deficit_kwh >= min_deficit }}"
              - condition: template
                value_template: "{{ not is_state(session_helper, 'on') }}"
            then:
              - service: input_boolean.turn_on
                target:
                  entity_id: !input night_session_active_helper
              
              - if:
                  - condition: template
                    value_template: "{{ not dry_run }}"
                then:
                  - service: switch.turn_on
                    target:
                      entity_id: !input pump_switch
              
              - if:
                  - condition: template
                    value_template: "{{ debug }}"
                then:
                  - service: logbook.log
                    data:
                      name: "Piscina v6 - Fallback Noite"
                      message: >
                        üïô NOITE: Bomba ligada hor√°rio fixo (fallback)
                        D√©fice: {{ deficit_kwh }}kWh
                      entity_id: !input pump_switch

      # ==========================================
      # ACTION 3.5: FIM JANELA COOPERNICO (auto-stop)
      # ==========================================
      - conditions:
          - condition: trigger
            id: coopernico_window_end
          # Removida condi√ß√£o session_helper: ap√≥s restart HA o boolean √©
          # resetado para OFF, mas a bomba continua ligada. Desligar sempre
          # que o trigger dispara e a bomba est√° ON (resistente a restarts).
        sequence:
          # Reset session lock (pode j√° estar off ap√≥s restart)
          - service: input_boolean.turn_off
            target:
              entity_id: !input night_session_active_helper
          
          # Marcar sess√£o como completa
          - service: input_boolean.turn_on
            target:
              entity_id: !input night_session_done_helper
          
          # Desligar bomba
          - if:
              - condition: template
                value_template: "{{ pump_is_on and not dry_run }}"
            then:
              - service: switch.turn_off
                target:
                  entity_id: !input pump_switch
          
          - if:
              - condition: template
                value_template: "{{ debug }}"
            then:
              - service: logbook.log
                data:
                  name: "Piscina v6 - Coopernico OFF"
                  message: >
                    ‚è±Ô∏è Janela Coopernico terminada ({{ cheapest_result.duration_hours }}h)
                    D√©fice restante: {{ deficit_kwh }}kWh
                    {% if dry_run %}[DRY RUN]{% endif %}
                  entity_id: !input pump_switch

      # ==========================================
      # ACTION 4: FIM PER√çODO NOTURNO
      # ==========================================
      - conditions:
          - condition: trigger
            id: night_end
        sequence:
          # Reset session lock
          - service: input_boolean.turn_off
            target:
              entity_id: !input night_session_active_helper
          
          # Marcar sess√£o como completa (failsafe)
          - service: input_boolean.turn_on
            target:
              entity_id: !input night_session_done_helper
          
          # Desligar bomba (failsafe)
          - if:
              - condition: template
                value_template: "{{ pump_is_on and not dry_run }}"
            then:
              - service: switch.turn_off
                target:
                  entity_id: !input pump_switch
          
          - if:
              - condition: template
                value_template: "{{ debug }}"
            then:
              - service: logbook.log
                data:
                  name: "Piscina v6 - Fim Noite"
                  message: "üïó Fim per√≠odo noturno, session resetada"
                  entity_id: !input pump_switch

      # ==========================================
      # ACTION 5: NASCER DO SOL
      # ==========================================
      - conditions:
          - condition: trigger
            id: sunrise
        sequence:
          # Reset session lock
          - service: input_boolean.turn_off
            target:
              entity_id: !input night_session_active_helper

          # Reset night_session_done (Bug #9 fix)
          - service: input_boolean.turn_off
            target:
              entity_id: !input night_session_done_helper
          
          # Reset contador de arranques di√°rios
          - if:
              - condition: template
                value_template: "{{ states.counter.piscina_daily_starts is defined }}"
            then:
              - service: counter.reset
                target:
                  entity_id: counter.piscina_daily_starts
          
          - if:
              - condition: template
                value_template: "{{ debug }}"
            then:
              - service: logbook.log
                data:
                  name: "Piscina v6 - Nascer Sol"
                  message: "üåÖ Session noturna resetada, modo DIA ativo"
                  entity_id: !input pump_switch

      # ==========================================
      # ACTION 6: P√îR DO SOL
      # ==========================================
      - conditions:
          - condition: trigger
            id: sunset
        sequence:
          # Desligar bomba se ligada de dia
          - if:
              - condition: template
                value_template: "{{ pump_is_on and not dry_run }}"
            then:
              - service: switch.turn_off
                target:
                  entity_id: !input pump_switch
          
          - if:
              - condition: template
                value_template: "{{ debug }}"
            then:
              - service: logbook.log
                data:
                  name: "Piscina v6 - P√¥r Sol"
                  message: "üåá Bomba desligada ao p√¥r do sol, modo NOITE pronto"
                  entity_id: !input pump_switch

      # ==========================================
      # ACTION 7: CONTROLO SOLAR (DIA)
      # ==========================================
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: power_change_5min
              - condition: trigger
                id: power_change_inst
          - condition: template
            value_template: "{{ current_mode == 'day' }}"
          - condition: template
            value_template: "{{ not is_state(session_helper, 'on') }}"
          # Bloquear arranque solar entre coopernico_window_end e sunrise (fix anomalia alba - Bug #10)
          - condition: template
            value_template: "{{ not is_state(night_done_helper, 'on') }}"
        sequence:
          - choose:
              # ===== LIGAR BOMBA =====
              - conditions:
                  - condition: template
                    value_template: "{{ not pump_is_on }}"
                  - condition: template
                    value_template: "{{ has_deficit }}"
                  - condition: template
                    value_template: "{{ can_turn_on }}"
                  - condition: template
                    value_template: "{{ min_off_time_elapsed }}"
                  - condition: template
                    value_template: "{{ forecast_allows_solar }}"
                  - condition: template
                    value_template: "{{ daily_starts_ok }}"
                sequence:
                  # Delay antes de ligar
                  - delay:
                      seconds: "{{ final_delay_on }}"
                  
                  # Re-verificar condi√ß√µes com valores ATUAIS (n√£o stale)
                  - variables:
                      live_net: >
                        {% if net_5min != {} %}
                          {{ states(net_5min) | float(0) }}
                        {% elif house_5min != {} and pv_5min != {} %}
                          {{ (states(house_5min) | float(0) - states(pv_5min) | float(0)) | round(0) }}
                        {% elif export_5min != {} %}
                          {{ (0 - states(export_5min) | float(0)) | round(0) }}
                        {% elif net_inst != {} %}
                          {{ states(net_inst) | float(0) }}
                        {% elif house_inst != {} and pv_inst != {} %}
                          {{ (states(house_inst) | float(0) - states(pv_inst) | float(0)) | round(0) }}
                        {% elif export_inst != {} %}
                          {{ (0 - states(export_inst) | float(0)) | round(0) }}
                        {% else %}
                          0
                        {% endif %}
                      live_import_predicted: >
                        {{ (live_net | float(0) + pump_current_power | float(0)) | round(0) }}
                      live_can_turn_on: >
                        {{ live_import_predicted | float(0) <= (final_import_limit | float(0) - start_margin_val | float(0)) }}
                      live_energy: >
                        {% if hours_today_sensor != {} %}
                          {% set hours_done = states(hours_today_sensor) | float(0) %}
                          {{ (hours_done * (pump_power / 1000)) | round(2) }}
                        {% elif energy_today_sensor != {} %}
                          {{ states(energy_today_sensor) | float(0) }}
                        {% else %}
                          0
                        {% endif %}
                      live_deficit: >
                        {{ [target_kwh | float(0) - live_energy | float(0), 0] | max | round(2) }}
                      live_has_deficit: >
                        {{ live_deficit | float(0) > 0.1 or ignore_limit }}
                  - if:
                      - condition: template
                        value_template: "{{ live_can_turn_on and live_has_deficit }}"
                    then:
                      - if:
                          - condition: template
                            value_template: "{{ not dry_run }}"
                        then:
                          - service: switch.turn_on
                            target:
                              entity_id: !input pump_switch
                          # Incrementar contador de arranques di√°rios
                          - if:
                              - condition: template
                                value_template: "{{ states.counter.piscina_daily_starts is defined }}"
                            then:
                              - service: counter.increment
                                target:
                                  entity_id: counter.piscina_daily_starts
                      
                      - if:
                          - condition: template
                            value_template: "{{ debug }}"
                        then:
                          - service: logbook.log
                            data:
                              name: "Piscina v6 - Solar ON"
                              message: >
                                ‚òÄÔ∏è DIA: Bomba ligada com excedente
                                NET: {{ current_net_power }}W
                                Previsto: {{ import_predicted }}W
                                Limite: {{ final_import_limit }}W
                                D√©fice: {{ deficit_kwh }}kWh
                                Sensor: N√≠vel {{ sensor_level }}
                                Arranques hoje: {{ daily_starts_count + 1 }}/{{ max_daily_starts_val }}
                                Delay ON: {{ final_delay_on }}s (base {{ delay_on_val }}s √ó {{ delay_multiplier }})
                                {% if dry_run %}[DRY RUN]{% endif %}
                              entity_id: !input pump_switch
              
              # ===== DESLIGAR BOMBA =====
              - conditions:
                  - condition: template
                    value_template: "{{ pump_is_on }}"
                  - condition: template
                    value_template: "{{ not can_keep_on or (not has_deficit and not ignore_limit) }}"
                  - condition: template
                    value_template: "{{ min_time_elapsed }}"
                sequence:
                  # Delay antes de desligar
                  - delay:
                      seconds: "{{ final_delay_off }}"
                  
                  # Re-verificar com valores ATUAIS (n√£o stale)
                  - variables:
                      live_net_off: >
                        {% if net_5min != {} %}
                          {{ states(net_5min) | float(0) }}
                        {% elif house_5min != {} and pv_5min != {} %}
                          {{ (states(house_5min) | float(0) - states(pv_5min) | float(0)) | round(0) }}
                        {% elif export_5min != {} %}
                          {{ (0 - states(export_5min) | float(0)) | round(0) }}
                        {% elif net_inst != {} %}
                          {{ states(net_inst) | float(0) }}
                        {% elif house_inst != {} and pv_inst != {} %}
                          {{ (states(house_inst) | float(0) - states(pv_inst) | float(0)) | round(0) }}
                        {% elif export_inst != {} %}
                          {{ (0 - states(export_inst) | float(0)) | round(0) }}
                        {% else %}
                          0
                        {% endif %}
                      live_import_off: >
                        {{ (live_net_off | float(0) + pump_current_power | float(0)) | round(0) }}
                      live_can_keep_on: >
                        {{ live_import_off | float(0) <= final_import_limit | float(0) }}
                      live_energy_off: >
                        {% if hours_today_sensor != {} %}
                          {% set hours_done = states(hours_today_sensor) | float(0) %}
                          {{ (hours_done * (pump_power / 1000)) | round(2) }}
                        {% elif energy_today_sensor != {} %}
                          {{ states(energy_today_sensor) | float(0) }}
                        {% else %}
                          0
                        {% endif %}
                      live_deficit_off: >
                        {{ [target_kwh | float(0) - live_energy_off | float(0), 0] | max | round(2) }}
                      live_has_deficit_off: >
                        {{ live_deficit_off | float(0) > 0.1 or ignore_limit }}
                  - if:
                      - condition: template
                        value_template: "{{ not live_can_keep_on or not live_has_deficit_off }}"
                    then:
                      - if:
                          - condition: template
                            value_template: "{{ not dry_run }}"
                        then:
                          - service: switch.turn_off
                            target:
                              entity_id: !input pump_switch
                      
                      - if:
                          - condition: template
                            value_template: "{{ debug }}"
                        then:
                          - service: logbook.log
                            data:
                              name: "Piscina v6 - Solar OFF"
                              message: >
                                ‚òÄÔ∏è DIA: Bomba desligada
                                Raz√£o: {{ 'Sem excedente' if not can_keep_on else 'Meta cumprida' }}
                                NET: {{ current_net_power }}W
                                Previsto: {{ import_predicted }}W
                                D√©fice: {{ deficit_kwh }}kWh
                                Delay OFF: {{ final_delay_off }}s (base {{ delay_off_val }}s √ó {{ delay_multiplier }})
                                Cooldown: {{ (min_off_time_val * delay_multiplier) | round(0) }}min
                                {% if dry_run %}[DRY RUN]{% endif %}
                              entity_id: !input pump_switch

    # ===== DEFAULT (DEBUG) =====
    default:
      - if:
          - condition: template
            value_template: "{{ debug }}"
        then:
          - service: logbook.log
            data:
              name: "Piscina v6 - Debug"
              message: >
                Trigger: {{ trigger.id | default('unknown') }}
                Modo: {{ current_mode }}
                Bomba: {{ 'ON' if pump_is_on else 'OFF' }}
                D√©fice: {{ deficit_kwh }}kWh
                NET: {{ current_net_power }}W
                Sensor: N√≠vel {{ sensor_level }}
                Previs√£o: {{ 'bloqueada (noite)' if not forecast_allows_solar else 'OK' }}
              entity_id: !input pump_switch

mode: single
max_exceeded: silent
