blueprint:
  name: "ğŸŠ Piscina - Controlo Solar Inteligente v2 (PT)"
  description: >
    ### **Controlo Inteligente da Bomba da Piscina com PrevisÃ£o Solar**
    
    Blueprint portuguÃªs otimizado para maximizar o autoconsumo solar na filtragem da piscina.
    
    **VersÃ£o 2.0** - Agora com integraÃ§Ã£o Solcast!
    
    
    #### âœ¨ **Funcionalidades:**
    
    - âœ… **PrevisÃ£o de importaÃ§Ã£o** - Liga antes de importar da rede
    
    - âœ… **Hysteresis inteligente** - CritÃ©rios diferentes para ligar vs manter
    
    - âœ… **3 nÃ­veis de fallback** - Usa sensores alternativos se principal falhar
    
    - âœ… **OtimizaÃ§Ã£o econÃ³mica** - CÃ¡lculo de break-even vs tarifa noite
    
    - âœ… **Controlo de tempo filtragem** - Integra com timer de filtragem
    
    - âœ… **HorÃ¡rios solares** - SÃ³ funciona durante horas de sol
    
    - âœ… **Override manual** - Respeita controlo manual
    
    - âœ… **Delays configurÃ¡veis** - Evita oscilaÃ§Ãµes
    
    - âœ… **DiagnÃ³stico completo** - Logs detalhados
    
    
    #### ğŸ†• **Novidades v2.0:**
    
    - â˜€ï¸ **PrevisÃ£o Solar Solcast** - Adapta agressividade ao sol previsto
    
    - ğŸ¯ **Modos Adaptativos** - Agressivo/Normal/Conservador/EmergÃªncia
    
    - â° **AntecipaÃ§Ã£o de Quedas** - PrevÃª nuvens antes de chegarem
    
    - ğŸŒ™ **Backup Noturno** - Agenda filtragem noturna se necessÃ¡rio
    
    - ğŸ”‹ **CoordenaÃ§Ã£o Bateria** - Reserva energia para bateria


    #### ğŸ“Š **Sensores Suportados:**
    
    - Sensor de consumo casa (sem bomba) + PV (preferencial)
    
    - Sensor NET import/export (fallback 1)
    
    - Sensor exportaÃ§Ã£o positiva (fallback 2)
    
    - Solcast forecast (recomendado)
    
    
    #### ğŸ’¡ **Baseado em:**
    
    CÃ³digo original de **guibrazlima** (binary_sensor.piscina_excedente_fv_bomba)
    
    Melhorado com funcionalidades adicionais e previsÃ£o solar.

    
    ---
    
    *Blueprint v2.0 criado para Home Assistant - Portugal*
    
  domain: automation
  author: "guibrazlima (original) + AI Assistant (blueprint)"
  source_url: "https://github.com/guibrazlima/homeassistant"
  
  input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SENSORES DE ENERGIA (obrigatÃ³rios - pelo menos um grupo)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    house_power_no_pump:
      name: "ğŸ  Consumo Casa (SEM bomba)"
      description: >
        Sensor do consumo da casa EXCLUINDO a bomba da piscina.
        
        Se nÃ£o tiver este sensor, deixe vazio e configure o sensor NET.
        
        **Exemplo:** `sensor.emoncms_use_no_pool_pump`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power
          multiple: false
          
    pv_power:
      name: "â˜€ï¸ ProduÃ§Ã£o Solar (PV)"
      description: >
        Sensor da produÃ§Ã£o solar instantÃ¢nea em Watts.
        
        Opcional se usar NET ou Export.
        
        **Exemplo:** `sensor.emoncms_solar`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power
          multiple: false
          
    net_power:
      name: "ğŸ“Š PotÃªncia NET (Import/Export)"
      description: >
        Sensor NET: positivo = importaÃ§Ã£o, negativo = exportaÃ§Ã£o.
        
        Usado como fallback se house_power_no_pump nÃ£o disponÃ­vel.
        
        **Exemplo:** `sensor.emoncms_import_export`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power
          multiple: false
          
    export_power:
      name: "ğŸ“¤ ExportaÃ§Ã£o (positiva)"
      description: >
        Sensor de exportaÃ§Ã£o para a rede (valor sempre positivo).
        
        Ãšltimo fallback se outros sensores falharem.
        
        **Exemplo:** `sensor.emoncms_export_power_positive`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power
          multiple: false
          
    pump_actual_power:
      name: "âš¡ Consumo Real da Bomba"
      description: >
        Sensor do consumo atual da bomba (opcional, melhora precisÃ£o).
        
        Se nÃ£o tiver, serÃ¡ usado o valor nominal configurado.
        
        **Exemplo:** `sensor.bomba_piscina_power`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power
          multiple: false

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ†• PREVISÃƒO SOLAR (SOLCAST)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    forecast_remaining_today:
      name: "â˜€ï¸ PrevisÃ£o Solar Restante Hoje"
      description: >
        Sensor com kWh previstos para o resto do dia.
        
        Usado para adaptar agressividade do controlo.
        
        **Exemplo:** `sensor.solcast_pv_forecast_forecast_remaining_today`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: energy
          multiple: false
          
    forecast_tomorrow:
      name: "ğŸŒ… PrevisÃ£o Solar AmanhÃ£"
      description: >
        Sensor com kWh previstos para amanhÃ£.
        
        Usado para decidir se ativa filtragem noturna de backup.
        
        **Exemplo:** `sensor.solcast_pv_forecast_forecast_tomorrow`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: energy
          multiple: false
          
    power_forecast_1h:
      name: "â° PotÃªncia Prevista 1 Hora"
      description: >
        PotÃªncia esperada daqui a 1 hora.
        
        Ajuda a antecipar quedas de produÃ§Ã£o.
        
        **Exemplo:** `sensor.solcast_pv_forecast_power_now_1hr`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: power
          multiple: false
          
    forecast_confidence:
      name: "ğŸ“Š ConfianÃ§a na PrevisÃ£o (%)"
      description: >
        Quanto confiar na previsÃ£o Solcast.
        
        **85%** = conservador (recomendado)
        
        **100%** = confia totalmente
        
        **70%** = muito conservador
      default: 85
      selector:
        number:
          min: 50
          max: 100
          step: 5
          unit_of_measurement: "%"
          mode: slider
          
    min_daily_filtration_kwh:
      name: "âš¡ Energia MÃ­nima Filtragem DiÃ¡ria (kWh) - FIXO"
      description: >
        Energia mÃ­nima FIXA que a bomba deve consumir por dia.
        
        âš ï¸ SÃ³ usado se "Usar Tempo DinÃ¢mico" estiver DESLIGADO.
        
        **TÃ­pico:** 5-8 kWh (6-10 horas Ã— 800W)
      default: 6
      selector:
        number:
          min: 1
          max: 20
          step: 0.5
          unit_of_measurement: "kWh"
          mode: slider
    
    use_dynamic_filtration_time:
      name: "ğŸŒ¡ï¸ Usar Tempo DinÃ¢mico de Filtragem"
      description: >
        Se ATIVADO, usa o sensor de tempo de filtragem recomendado
        (baseado na temperatura da Ã¡gua/ar).
        
        Se DESATIVADO, usa o valor fixo acima.
      default: true
      selector:
        boolean:
        
    dynamic_filtration_hours_sensor:
      name: "ğŸŒ¡ï¸ Sensor Tempo Filtragem Recomendado (horas)"
      description: >
        Sensor que calcula dinamicamente as horas de filtragem
        baseado na temperatura da Ã¡gua e ar.
        
        O valor deve estar em HORAS (ex: 6.5 = 6h30).
        
        **Exemplo:** `sensor.piscina_tempo_de_filtracao_recomendado`
      default: {}
      selector:
        entity:
          domain: sensor
          multiple: false
          
    filtration_energy_today:
      name: "ğŸ“Š Energia FiltraÃ§Ã£o Hoje"
      description: >
        Sensor com kWh jÃ¡ consumidos pela bomba hoje.
        
        Usado para calcular dÃ©fice de filtragem.
        
        **Exemplo:** `sensor.bomba_piscina_energy_today`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: energy
          multiple: false

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ”‹ BATERIA DOMÃ‰STICA (OPCIONAL)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    battery_level:
      name: "ğŸ”‹ NÃ­vel da Bateria (%)"
      description: >
        Sensor do nÃ­vel atual da bateria domÃ©stica.
        
        Se nÃ£o tiver bateria, deixe vazio.
        
        **Exemplo:** `sensor.battery_soc`
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: battery
          multiple: false
          
    battery_target_level:
      name: "ğŸ¯ NÃ­vel Alvo Bateria (%)"
      description: >
        NÃ­vel que a bateria deve atingir ao fim do dia.
        
        A piscina sÃ³ usa excedente apÃ³s garantir este nÃ­vel.
      default: 80
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "%"
          mode: slider
          
    battery_capacity_kwh:
      name: "ğŸ”‹ Capacidade Bateria (kWh)"
      description: >
        Capacidade utilizÃ¡vel da bateria em kWh.
      default: 0
      selector:
        number:
          min: 0
          max: 50
          step: 0.5
          unit_of_measurement: "kWh"
          mode: box

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ†• CONSUMO DA CASA (PREVISÃƒO)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    house_avg_power:
      name: "ğŸ  Consumo MÃ©dio Casa (W)"
      description: >
        Consumo mÃ©dio da casa durante as horas de sol (SEM piscina).
        
        Usado para prever quanta energia solar sobra para a piscina.
        
        **Como calcular:** 
        - Energia diÃ¡ria da casa (kWh) Ã· Horas de sol (10h) Ã— 1000
        - Ex: 8 kWh/dia Ã· 10h = 800W mÃ©dio
        
        **TÃ­pico Portugal:**
        - Casa bÃ¡sica: 300-500W
        - Com AC: 800-1500W
        - Com EV a carregar: 2000-7000W
      default: 600
      selector:
        number:
          min: 100
          max: 5000
          step: 50
          unit_of_measurement: "W"
          mode: slider
          
    house_power_sensor_daily:
      name: "ğŸ“Š Sensor Consumo DiÃ¡rio Casa (kWh) [DEPRECATED]"
      description: >
        âš ï¸ **DEPRECATED**: Este sensor nÃ£o Ã© usado. Use `house_power_avg_sensor` em vez disso.
        
        SerÃ¡ removido numa versÃ£o futura.
        
        **Exemplo:** `sensor.emoncms_use_kwhd`
      default: {}
      selector:
        entity:
          domain: sensor
          multiple: false
          
    house_power_avg_sensor:
      name: "ğŸ“ˆ Sensor MÃ©dia Consumo 7 Dias (W)"
      description: >
        Sensor opcional com a mÃ©dia de consumo dos Ãºltimos 7 dias.
        
        Criado automaticamente se usares o sensor de estatÃ­sticas.
        
        **Recomendado:** `sensor.casa_consumo_medio_7d`
        
        Se nÃ£o configurado, usa o valor manual de "Consumo MÃ©dio Casa".
      default: {}
      selector:
        entity:
          domain: sensor
          multiple: false
          
    use_dynamic_house_estimate:
      name: "ğŸ”„ Usar Estimativa DinÃ¢mica"
      description: >
        Se ativado, usa o consumo ATUAL da casa para estimar
        o consumo futuro (multiplica pela hora restante atÃ© pÃ´r do sol).
        
        Mais preciso se o padrÃ£o de consumo for estÃ¡vel.
      default: true
      selector:
        boolean:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONTROLO DA BOMBA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    pump_switch:
      name: "ğŸ”Œ Switch da Bomba"
      description: >
        Entidade para ligar/desligar a bomba da piscina.
        
        **Exemplo:** `switch.bomba_piscina_switch_0`
      selector:
        entity:
          domain: switch
          multiple: false
          
    pump_nominal_power:
      name: "ğŸ’ª PotÃªncia Nominal da Bomba (W)"
      description: >
        PotÃªncia nominal da bomba em Watts.
        
        Usado para cÃ¡lculos de previsÃ£o.
        
        **TÃ­pico:** 800-1500W para bomba 1.5CV
      default: 800
      selector:
        number:
          min: 100
          max: 5000
          step: 50
          unit_of_measurement: "W"
          mode: box

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # THRESHOLDS E LIMITES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    import_limit:
      name: "ğŸ“ˆ Limite de ImportaÃ§Ã£o MÃ¡xima (W)"
      description: >
        ImportaÃ§Ã£o mÃ¡xima permitida para MANTER a bomba ligada.
        
        Este valor Ã© ajustado automaticamente pelo modo adaptativo!
        
        **Recomendado:** 500-800W
      default: 700
      selector:
        number:
          min: 0
          max: 2000
          step: 50
          unit_of_measurement: "W"
          mode: slider
          
    start_margin:
      name: "ğŸš€ Margem Extra para Arranque (W)"
      description: >
        Margem adicional exigida para LIGAR a bomba.
        
        Ajustado automaticamente pelo modo adaptativo.
      default: 100
      selector:
        number:
          min: 0
          max: 500
          step: 25
          unit_of_measurement: "W"
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # DELAYS (ANTI-OSCILAÃ‡ÃƒO)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    delay_on:
      name: "â±ï¸ Delay para Ligar (segundos)"
      description: >
        Tempo de espera antes de ligar.
        
        Ajustado automaticamente pelo modo adaptativo.
      default: 30
      selector:
        number:
          min: 0
          max: 300
          step: 5
          unit_of_measurement: "s"
          mode: slider
          
    delay_off:
      name: "â±ï¸ Delay para Desligar (segundos)"
      description: >
        Tempo de espera antes de desligar.
        
        Aumentado automaticamente se queda de PV prevista.
      default: 60
      selector:
        number:
          min: 0
          max: 300
          step: 5
          unit_of_measurement: "s"
          mode: slider
          
    min_on_time:
      name: "â° Tempo MÃ­nimo Ligada (minutos)"
      description: >
        Tempo mÃ­nimo que a bomba fica ligada apÃ³s arranque.
        
        Evita ciclos ON/OFF em dias nublados.
        
        **Recomendado:** 10-15 minutos
      default: 10
      selector:
        number:
          min: 0
          max: 60
          step: 1
          unit_of_measurement: "min"
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # INTEGRAÃ‡ÃƒO COM SISTEMA EXISTENTE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    filtration_remaining:
      name: "â³ Tempo Filtragem Restante"
      description: >
        Sensor com tempo de filtragem restante hoje.
        
        Aceita formatos:
        - Minutos numÃ©ricos (ex: 120)
        - Formato HH:MM (ex: "02:00")
        - Sensor com atributo 'seconds'
        
        Se 0, nÃ£o liga a bomba (jÃ¡ filtrou suficiente).
        
        **Exemplo:** `sensor.pool_pump_remaining_time`
      default: {}
      selector:
        entity:
          domain:
            - input_number
            - sensor
          multiple: false
          
    override_manual:
      name: "ğŸ”§ Override Manual"
      description: >
        Input boolean que indica modo manual ativo.
        
        Quando ON, a automaÃ§Ã£o nÃ£o interfere.
      default: {}
      selector:
        entity:
          domain: input_boolean
          multiple: false

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # HORÃRIOS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    sun_offset_start:
      name: "ğŸŒ… Offset ApÃ³s Nascer do Sol (minutos)"
      description: >
        Minutos apÃ³s nascer do sol para comeÃ§ar.
      default: 30
      selector:
        number:
          min: 0
          max: 180
          step: 15
          unit_of_measurement: "min"
          mode: slider
          
    sun_offset_end:
      name: "ğŸŒ‡ Offset Antes do PÃ´r do Sol (minutos)"
      description: >
        Minutos antes do pÃ´r do sol para parar.
      default: 30
      selector:
        number:
          min: 0
          max: 180
          step: 15
          unit_of_measurement: "min"
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # OTIMIZAÃ‡ÃƒO ECONÃ“MICA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    price_peak:
      name: "ğŸ’¶ PreÃ§o Fora-Vazio (â‚¬/kWh)"
      description: >
        PreÃ§o da eletricidade fora de vazio.
      default: 0.1537
      selector:
        number:
          min: 0
          max: 1
          step: 0.01
          unit_of_measurement: "â‚¬/kWh"
          mode: box
          
    price_offpeak:
      name: "ğŸ’¶ PreÃ§o Vazio (â‚¬/kWh)"
      description: >
        PreÃ§o da eletricidade em vazio (noite).
      default: 0.0929
      selector:
        number:
          min: 0
          max: 1
          step: 0.01
          unit_of_measurement: "â‚¬/kWh"
          mode: box

    use_economic_optimization:
      name: "ğŸ“Š Usar OtimizaÃ§Ã£o EconÃ³mica"
      description: >
        Calcula break-even e ajusta limites.
      default: true
      selector:
        boolean:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ†• FILTRAGEM NOTURNA BACKUP
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    enable_night_backup:
      name: "ğŸŒ™ Ativar Backup Noturno"
      description: >
        Se filtragem solar insuficiente E amanhÃ£ mau tempo previsto,
        envia notificaÃ§Ã£o para agendar filtragem noturna.
      default: false
      selector:
        boolean:
        
    night_backup_notify:
      name: "ğŸ“± NotificaÃ§Ã£o Backup Noturno"
      description: >
        ServiÃ§o de notificaÃ§Ã£o para avisar sobre backup noturno.
        
        **Exemplo:** `notify.mobile_app_phone`
      default: {}
      selector:
        entity:
          domain: notify
          multiple: false
          
    good_forecast_threshold:
      name: "â˜€ï¸ Limite Dia Bom (kWh)"
      description: >
        PrevisÃ£o mÃ­nima para considerar "dia bom".
        
        Abaixo disto, considera filtragem noturna.
      default: 15
      selector:
        number:
          min: 5
          max: 50
          step: 1
          unit_of_measurement: "kWh"
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ†• TARIFA BI-HORÃRIO (VAZIO NOTURNO)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    enable_night_auto:
      name: "ğŸŒ™ Ligar Automaticamente Ã  Noite (Bi-HorÃ¡rio)"
      description: >
        Se ativado, liga a bomba automaticamente no horÃ¡rio de vazio
        para completar a filtragem que faltou durante o dia solar.
        
        Ideal para tarifas bi-horÃ¡rias!
      default: false
      selector:
        boolean:
        
    night_start_time:
      name: "ğŸ•™ InÃ­cio HorÃ¡rio Vazio"
      description: >
        Hora de inÃ­cio da tarifa de vazio (mais barata).
        
        **TÃ­pico Portugal:** 22:00
      default: "22:00:00"
      selector:
        time:
        
    night_end_time:
      name: "ğŸ•— Fim HorÃ¡rio Vazio"
      description: >
        Hora de fim da tarifa de vazio.
        
        **TÃ­pico Portugal:** 08:00
      default: "08:00:00"
      selector:
        time:
        
    min_night_filtration_minutes:
      name: "â±ï¸ FiltraÃ§Ã£o Noturna MÃ­nima (minutos)"
      description: >
        Tempo mÃ­nimo de filtragem noturna se for necessÃ¡rio ligar.
        
        Evita ligar/desligar rapidamente.
      default: 60
      selector:
        number:
          min: 15
          max: 240
          step: 15
          unit_of_measurement: "min"
          mode: slider

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # DIAGNÃ“STICO E LOGS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    enable_debug_logs:
      name: "ğŸ” Logs de DiagnÃ³stico"
      description: >
        Ativa logs detalhados para debug.
      default: false
      selector:
        boolean:

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VARIÃVEIS GLOBAIS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

variables:
  # â”€â”€â”€ Inputs bÃ¡sicos â”€â”€â”€
  house_power_no_pump: !input house_power_no_pump
  pv_power: !input pv_power
  net_power: !input net_power
  export_power: !input export_power
  pump_actual_power: !input pump_actual_power
  pump_switch: !input pump_switch
  pump_nominal_power: !input pump_nominal_power
  import_limit: !input import_limit
  start_margin: !input start_margin
  delay_on: !input delay_on
  delay_off: !input delay_off
  min_on_time: !input min_on_time
  filtration_remaining: !input filtration_remaining
  override_manual: !input override_manual
  sun_offset_start: !input sun_offset_start
  sun_offset_end: !input sun_offset_end
  price_peak: !input price_peak
  price_offpeak: !input price_offpeak
  use_economic_optimization: !input use_economic_optimization
  enable_debug_logs: !input enable_debug_logs
  
  # â”€â”€â”€ Inputs forecast â”€â”€â”€
  forecast_remaining_today: !input forecast_remaining_today
  forecast_tomorrow: !input forecast_tomorrow
  power_forecast_1h: !input power_forecast_1h
  forecast_confidence: !input forecast_confidence
  min_daily_filtration_kwh: !input min_daily_filtration_kwh
  filtration_energy_today: !input filtration_energy_today
  use_dynamic_filtration_time: !input use_dynamic_filtration_time
  dynamic_filtration_hours_sensor: !input dynamic_filtration_hours_sensor
  
  # â”€â”€â”€ Inputs bateria â”€â”€â”€
  battery_level: !input battery_level
  battery_target_level: !input battery_target_level
  battery_capacity_kwh: !input battery_capacity_kwh
  
  # â”€â”€â”€ Inputs consumo casa â”€â”€â”€
  house_avg_power: !input house_avg_power
  house_power_sensor_daily: !input house_power_sensor_daily
  house_power_avg_sensor: !input house_power_avg_sensor
  use_dynamic_house_estimate: !input use_dynamic_house_estimate
  
  # â”€â”€â”€ Inputs backup noturno â”€â”€â”€
  enable_night_backup: !input enable_night_backup
  night_backup_notify: !input night_backup_notify
  good_forecast_threshold: !input good_forecast_threshold
  
  # â”€â”€â”€ Inputs bi-horÃ¡rio noturno â”€â”€â”€
  enable_night_auto: !input enable_night_auto
  night_start_time: !input night_start_time
  night_end_time: !input night_end_time
  min_night_filtration_minutes: !input min_night_filtration_minutes
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VALORES CALCULADOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  pump_power: >-
    {% if pump_actual_power and states(pump_actual_power) not in ['unknown','unavailable',''] %}
      {{ states(pump_actual_power)|float(pump_nominal_power) }}
    {% else %}
      {{ pump_nominal_power }}
    {% endif %}
    
  pump_is_on: "{{ is_state(pump_switch, 'on') }}"
  
  # â”€â”€â”€ Hierarquia de sensores â”€â”€â”€
  have_house_pv: >-
    {{ 
      house_power_no_pump and pv_power and 
      states(house_power_no_pump) not in ['unknown','unavailable',''] and 
      states(pv_power) not in ['unknown','unavailable','']
    }}
    
  have_net: >-
    {{ net_power and states(net_power) not in ['unknown','unavailable',''] }}
    
  have_export: >-
    {{ export_power and states(export_power) not in ['unknown','unavailable',''] }}
    
  # â”€â”€â”€ Leituras â”€â”€â”€
  house_w: "{{ states(house_power_no_pump)|float(0) if have_house_pv else 0 }}"
  pv_w: "{{ states(pv_power)|float(0) if have_house_pv else 0 }}"
  net_w: "{{ states(net_power)|float(0) if have_net else 0 }}"
  export_w: "{{ states(export_power)|float(0) if have_export else 0 }}"
  
  source_used: >-
    {% if have_house_pv %}house+pv{% elif have_net %}net{% elif have_export %}export{% else %}none{% endif %}
    
  # â”€â”€â”€ CÃ¡lculos de importaÃ§Ã£o â”€â”€â”€
  import_current: >-
    {% if have_house_pv %}
      {{ [house_w + (pump_power if pump_is_on else 0) - pv_w, 0]|max }}
    {% elif have_net %}
      {{ [net_w, 0]|max }}
    {% else %}
      {{ 999999 }}
    {% endif %}
    
  import_predicted: >-
    {% if have_house_pv %}
      {{ [house_w + pump_power - pv_w, 0]|max }}
    {% elif have_net %}
      {{ [net_w + pump_power, 0]|max }}
    {% elif have_export %}
      {{ [pump_power - export_w, 0]|max }}
    {% else %}
      {{ 999999 }}
    {% endif %}
    
  export_available: >-
    {% if have_house_pv %}
      {{ [pv_w - house_w, 0]|max }}
    {% elif have_net %}
      {{ [-net_w, 0]|max }}
    {% elif have_export %}
      {{ export_w }}
    {% else %}
      {{ 0 }}
    {% endif %}
    
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ†• CÃLCULOS DE FORECAST
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  have_forecast: >-
    {{ forecast_remaining_today and states(forecast_remaining_today) not in ['unknown','unavailable',''] }}
    
  forecast_kwh: >-
    {{ states(forecast_remaining_today)|float(0) if have_forecast else 0 }}
    
  adjusted_forecast_kwh: >-
    {{ forecast_kwh * (forecast_confidence / 100) }}
    
  have_forecast_tomorrow: >-
    {{ forecast_tomorrow and states(forecast_tomorrow) not in ['unknown','unavailable',''] }}
    
  forecast_tomorrow_kwh: >-
    {{ states(forecast_tomorrow)|float(0) if have_forecast_tomorrow else 999 }}
    
  have_power_forecast: >-
    {{ power_forecast_1h and states(power_forecast_1h) not in ['unknown','unavailable',''] }}
    
  power_in_1h: >-
    {{ states(power_forecast_1h)|float(pv_w) if have_power_forecast else pv_w }}
    
  # â”€â”€â”€ CÃ¡lculos de filtragem â”€â”€â”€
  have_filtration_energy: >-
    {{ filtration_energy_today and states(filtration_energy_today) not in ['unknown','unavailable',''] }}
    
  filtration_done_kwh: >-
    {{ states(filtration_energy_today)|float(0) if have_filtration_energy else 0 }}
  
  # ğŸ†• Tempo dinÃ¢mico de filtragem baseado em temperatura
  have_dynamic_filtration: >-
    {{ use_dynamic_filtration_time and dynamic_filtration_hours_sensor and states(dynamic_filtration_hours_sensor) not in ['unknown','unavailable',''] }}
  
  # Horas de filtragem alvo (dinÃ¢mico ou fixo)
  filtration_target_hours: >-
    {% if have_dynamic_filtration %}
      {{ states(dynamic_filtration_hours_sensor)|float(8) }}
    {% else %}
      {{ min_daily_filtration_kwh / (pump_nominal_power / 1000) if pump_nominal_power > 0 else 8 }}
    {% endif %}
  
  # Energia alvo de filtragem (calculada a partir das horas)
  filtration_target_kwh: >-
    {{ filtration_target_hours * (pump_nominal_power / 1000) }}
    
  filtration_needed_kwh: >-
    {{ [filtration_target_kwh - filtration_done_kwh, 0]|max }}
    
  # Fonte do tempo de filtragem (para debug)
  filtration_source: >-
    {% if have_dynamic_filtration %}
      dinÃ¢mico ({{ states(dynamic_filtration_hours_sensor)|float(8)|round(1) }}h baseado em temperatura)
    {% else %}
      fixo ({{ min_daily_filtration_kwh }}kWh = {{ (min_daily_filtration_kwh / (pump_nominal_power / 1000))|round(1) if pump_nominal_power > 0 else 'N/A' }}h)
    {% endif %}
    
  # â”€â”€â”€ Energia para bateria â”€â”€â”€
  have_battery: >-
    {{ battery_level and battery_capacity_kwh > 0 and states(battery_level) not in ['unknown','unavailable',''] }}
    
  battery_current: >-
    {{ states(battery_level)|float(100) if have_battery else 100 }}
    
  battery_needed_kwh: >-
    {% if have_battery %}
      {{ battery_capacity_kwh * ([battery_target_level - battery_current, 0]|max) / 100 }}
    {% else %}
      {{ 0 }}
    {% endif %}
  
  # â”€â”€â”€ ğŸŒ¤ï¸ Multiplicador Meteorologia â”€â”€â”€
  weather_multiplier: >-
    {% set sensor = 'sensor.piscina_weather_delay_multiplier' %}
    {% if states(sensor) not in ['unknown', 'unavailable', ''] %}
      {{ states(sensor)|float(1.0) }}
    {% else %}
      1.0
    {% endif %}
    
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ†• CONSUMO CASA - ESTIMATIVA DINÃ‚MICA COM HISTÃ“RICO
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  # Horas solares restantes atÃ© pÃ´r do sol
  hours_until_sunset: >-
    {% set sunset = state_attr('sun.sun', 'next_setting')|as_datetime %}
    {% if sunset %}
      {{ [((sunset - now()).total_seconds() / 3600)|round(1), 0]|max }}
    {% else %}
      {{ 4 }}
    {% endif %}
    
  # Consumo atual da casa (instantÃ¢neo, sem bomba)
  house_power_now: >-
    {% if have_house_pv %}
      {{ house_w }}
    {% else %}
      {{ house_avg_power }}
    {% endif %}
    
  # MÃ©dia estatÃ­stica dos Ãºltimos 7 dias 
  # Prioridade: 1) Sensor estatÃ­sticas, 2) Valor configurado manual
  house_power_avg_7d: >-
    {% if house_power_avg_sensor and states(house_power_avg_sensor) not in ['unknown','unavailable',''] %}
      {# Usa o sensor de estatÃ­sticas (sensor.casa_consumo_medio_7d) #}
      {{ states(house_power_avg_sensor)|float(house_avg_power) }}
    {% else %}
      {# Fallback: usar valor manual configurado #}
      {{ house_avg_power }}
    {% endif %}
    
  # Estimativa dinÃ¢mica do consumo restante (kWh)
  # Prioridade: 1) Consumo atual, 2) MÃ©dia 7 dias, 3) Valor configurado
  house_consumption_estimate: >-
    {% if use_dynamic_house_estimate and house_power_now > 0 %}
      {# DINÃ‚MICO: consumo atual Ã— horas restantes Ã— fator seguranÃ§a #}
      {# Ajusta o fator baseado na hora do dia (tarde = maior consumo) #}
      {% set hour = now().hour %}
      {% set factor = 1.3 if hour >= 14 and hour <= 18 else 1.1 %}
      {{ (house_power_now / 1000 * hours_until_sunset * factor)|round(1) }}
    {% else %}
      {# FIXO: usa mÃ©dia 7 dias se disponÃ­vel, senÃ£o valor manual #}
      {{ (house_power_avg_7d / 1000 * hours_until_sunset)|round(1) }}
    {% endif %}
  
  # â”€â”€â”€ Energia disponÃ­vel para piscina â”€â”€â”€
  available_for_pool_kwh: >-
    {% if have_forecast %}
      {{ [adjusted_forecast_kwh - house_consumption_estimate - battery_needed_kwh, 0]|max }}
    {% else %}
      {{ 999 }}
    {% endif %}
    
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ†• MODO ADAPTATIVO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  operation_mode: >-
    {% if not have_forecast %}
      normal
    {% elif available_for_pool_kwh >= filtration_needed_kwh * 2 %}
      aggressive
    {% elif available_for_pool_kwh >= filtration_needed_kwh * 1.2 %}
      normal
    {% elif available_for_pool_kwh >= filtration_needed_kwh * 0.5 %}
      conservative
    {% else %}
      emergency
    {% endif %}
    
  # â”€â”€â”€ ParÃ¢metros por modo â”€â”€â”€
  effective_import_limit: >-
    {% if operation_mode == 'aggressive' %}
      {{ import_limit * 1.5 }}
    {% elif operation_mode == 'conservative' %}
      {{ import_limit * 0.7 }}
    {% elif operation_mode == 'emergency' %}
      {{ import_limit * 2 }}
    {% else %}
      {{ import_limit }}
    {% endif %}
    
  effective_start_margin: >-
    {% if operation_mode == 'aggressive' %}
      {{ 0 }}
    {% elif operation_mode == 'conservative' %}
      {{ start_margin * 2 }}
    {% elif operation_mode == 'emergency' %}
      {{ 0 }}
    {% else %}
      {{ start_margin }}
    {% endif %}
    
  effective_delay_on: >-
    {% set base_delay = delay_on %}
    {% if operation_mode == 'aggressive' %}
      {% set base_delay = (base_delay * 0.5)|int %}
    {% elif operation_mode == 'conservative' %}
      {% set base_delay = (base_delay * 1.5)|int %}
    {% elif operation_mode == 'emergency' %}
      {% set base_delay = 10 %}
    {% endif %}
    {{ (base_delay * weather_multiplier)|int }}
    
  # â”€â”€â”€ AntecipaÃ§Ã£o de queda â”€â”€â”€
  power_drop_expected: >-
    {% if have_power_forecast and pv_w > 100 %}
      {{ ((pv_w - power_in_1h) / pv_w * 100)|round(0) }}
    {% else %}
      {{ 0 }}
    {% endif %}
    
  effective_delay_off: >-
    {% set base_delay = delay_off %}
    {% if power_drop_expected > 50 %}
      {% set base_delay = base_delay * 2 %}
    {% elif power_drop_expected > 30 %}
      {% set base_delay = (base_delay * 1.5)|int %}
    {% endif %}
    {{ (base_delay * weather_multiplier)|int }}
    
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OTIMIZAÃ‡ÃƒO ECONÃ“MICA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
  break_even_w: >-
    {% if use_economic_optimization and price_peak > 0 %}
      {{ (pump_power * (price_peak - price_offpeak) / price_peak)|round(0) }}
    {% else %}
      {{ 0 }}
    {% endif %}
    
  final_import_limit: >-
    {% if use_economic_optimization %}
      {{ [effective_import_limit, break_even_w]|max }}
    {% else %}
      {{ effective_import_limit }}
    {% endif %}
    
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DECISÃ•ES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
  should_start: >-
    {{ import_predicted <= (final_import_limit - effective_start_margin) }}
    
  should_stay_on: >-
    {{ pump_is_on and import_current <= final_import_limit }}
    
  should_turn_on: >-
    {{ should_start or should_stay_on }}
    
  # â”€â”€â”€ CondiÃ§Ãµes adicionais â”€â”€â”€
  filtration_ok: >-
    {% if filtration_remaining %}
      {{ states(filtration_remaining)|float(999) > 0 }}
    {% else %}
      {{ true }}
    {% endif %}
    
  manual_override_off: >-
    {% if override_manual %}
      {{ is_state(override_manual, 'off') }}
    {% else %}
      {{ true }}
    {% endif %}
    
  # â”€â”€â”€ Backup noturno necessÃ¡rio â”€â”€â”€
  night_backup_needed: >-
    {% if enable_night_backup and have_forecast_tomorrow %}
      {% set deficit = filtration_needed_kwh %}
      {% set tomorrow_bad = forecast_tomorrow_kwh < good_forecast_threshold %}
      {{ deficit > 0 and tomorrow_bad }}
    {% else %}
      {{ false }}
    {% endif %}
    
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ†• BI-HORÃRIO: FILTRAGEM NOTURNA AUTOMÃTICA
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  # Verifica se estamos no horÃ¡rio de vazio (22:00-08:00)
  is_night_tariff: >-
    {% if enable_night_auto %}
      {% set now_time = now().strftime('%H:%M:%S') %}
      {% set start = night_start_time %}
      {% set end = night_end_time %}
      {% if start > end %}
        {# HorÃ¡rio atravessa meia-noite (22:00-08:00) #}
        {{ now_time >= start or now_time < end }}
      {% else %}
        {# HorÃ¡rio normal #}
        {{ now_time >= start and now_time < end }}
      {% endif %}
    {% else %}
      {{ false }}
    {% endif %}
    
  # Minutos de filtragem que ainda faltam
  filtration_remaining_minutes: >-
    {% if filtration_remaining and states(filtration_remaining) not in ['unknown','unavailable',''] %}
      {# Tenta ler atributo 'seconds' se existir, senÃ£o converte HH:MM para minutos #}
      {% set secs = state_attr(filtration_remaining, 'seconds') %}
      {% if secs is not none %}
        {{ (secs|float(0) / 60)|round(0) }}
      {% else %}
        {# Tenta converter HH:MM para minutos #}
        {% set val = states(filtration_remaining) %}
        {% if ':' in val|string %}
          {% set parts = val.split(':') %}
          {{ (parts[0]|int(0) * 60 + parts[1]|int(0))|round(0) }}
        {% else %}
          {{ val|float(0) }}
        {% endif %}
      {% endif %}
    {% else %}
      {# Calcula baseado na energia: kWh restantes Ã· potÃªncia bomba Ã— 60 min #}
      {{ (filtration_needed_kwh / (pump_power/1000) * 60)|round(0) if pump_power > 0 else 0 }}
    {% endif %}
    
  # DecisÃ£o: Deve ligar Ã  noite no bi-horÃ¡rio?
  should_run_night: >-
    {% if enable_night_auto and is_night_tariff and manual_override_off %}
      {% set needs_filtration = filtration_remaining_minutes > 0 %}
      {% set min_time = min_night_filtration_minutes %}
      {{ needs_filtration and filtration_remaining_minutes >= min_time }}
    {% else %}
      {{ false }}
    {% endif %}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TRIGGERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

trigger:
  - trigger: state
    entity_id: !input pv_power
    id: pv_changed
    
  - trigger: state
    entity_id: !input house_power_no_pump
    id: house_changed
    enabled: "{{ house_power_no_pump is not none }}"
    
  - trigger: state
    entity_id: !input net_power
    id: net_changed
    enabled: "{{ net_power is not none }}"
    
  - trigger: state
    entity_id: !input export_power
    id: export_changed
    enabled: "{{ export_power is not none }}"
    
  - trigger: time_pattern
    minutes: "/2"
    id: periodic
    
  # Trigger para verificar backup noturno
  - trigger: time
    at: "20:30:00"
    id: night_check
    
  # ğŸ†• Trigger para inÃ­cio do horÃ¡rio vazio (bi-horÃ¡rio)
  - trigger: time
    at: !input night_start_time
    id: night_tariff_start
    
  # ğŸ†• Trigger periÃ³dico noturno (a cada 15 min durante horÃ¡rio vazio)
  - trigger: time_pattern
    minutes: "/15"
    id: night_periodic

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONDITIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

condition:
  - condition: or
    conditions:
      # CondiÃ§Ã£o normal (durante o dia - modo solar)
      - condition: and
        conditions:
          - condition: template
            value_template: >-
              {# Verifica se Ã© dia e se estamos dentro do offset configurado #}
              {% set is_day = is_state('sun.sun', 'above_horizon') %}
              {% if not is_day %}
                false
              {% else %}
                {% set elevation = state_attr('sun.sun', 'elevation') | float(0) %}
                {# Usa elevaÃ§Ã£o como proxy - offsets maiores = elevaÃ§Ã£o mÃ­nima maior #}
                {% set min_elevation = (sun_offset_start | int / 10) %}
                {% set sun_azimuth = state_attr('sun.sun', 'azimuth') | float(180) %}
                {# ManhÃ£: azimute < 180, Tarde: azimute >= 180 #}
                {% set is_morning = sun_azimuth < 180 %}
                {% set is_afternoon = sun_azimuth >= 180 %}
                {# Aplica offset start na manhÃ£, offset end na tarde #}
                {% set start_offset_deg = (sun_offset_start | int / 60) * 5 %}
                {% set end_offset_deg = (sun_offset_end | int / 60) * 5 %}
                {% if is_morning %}
                  {{ elevation >= start_offset_deg }}
                {% else %}
                  {{ elevation >= end_offset_deg }}
                {% endif %}
              {% endif %}
          - condition: template
            value_template: "{{ manual_override_off }}"
          - condition: template
            value_template: "{{ filtration_ok }}"
          - condition: template
            value_template: "{{ source_used != 'none' }}"
      # Trigger noturno sempre passa (verificamos no action)
      - condition: trigger
        id: night_check
      # ğŸ†• Trigger bi-horÃ¡rio noturno sempre passa
      - condition: trigger
        id: night_tariff_start
      # ğŸ†• Trigger periÃ³dico noturno sempre passa
      - condition: trigger
        id: night_periodic

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ACTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

action:
  # ğŸ†• DEBUG: Log when automation runs
  - if:
      - condition: template
        value_template: "{{ enable_debug_logs }}"
    then:
      - service: system_log.write
        data:
          message: "ğŸŠ Blueprint EXECUTOU [trigger={{ trigger.id|default('unknown') }}]: source={{ source_used }}, house={{ house_w|round(0) }}W, pv={{ pv_w|round(0) }}W, pump={{ pump_is_on }}, filtr_ok={{ filtration_ok }}, manual_off={{ manual_override_off }}, weather_mult={{ weather_multiplier }}Ã—"
          level: info
          logger: blueprints.piscina_solar
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ†• FILTRAGEM NOTURNA BI-HORÃRIO (22:00-08:00)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - if:
      - condition: or
        conditions:
          - condition: trigger
            id: night_tariff_start
          - condition: trigger
            id: night_periodic
    then:
      - if:
          - condition: template
            value_template: "{{ should_run_night and not pump_is_on }}"
        then:
          - service: switch.turn_on
            target:
              entity_id: !input pump_switch
              
          - if:
              - condition: template
                value_template: "{{ enable_debug_logs }}"
            then:
              - service: system_log.write
                data:
                  message: "ğŸŒ™ Bomba LIGADA [BI-HORÃRIO]: restam={{ filtration_remaining_minutes|round(0) }}min, tarifa=vazio"
                  level: info
                  logger: blueprints.piscina_solar
                  
      # Desligar quando filtragem completa durante a noite
      - if:
          - condition: template
            value_template: "{{ is_night_tariff and pump_is_on and filtration_remaining_minutes <= 0 }}"
        then:
          - service: switch.turn_off
            target:
              entity_id: !input pump_switch
              
          - if:
              - condition: template
                value_template: "{{ enable_debug_logs }}"
            then:
              - service: system_log.write
                data:
                  message: "ğŸŒ™ Bomba DESLIGADA [BI-HORÃRIO]: filtragem completa!"
                  level: info
                  logger: blueprints.piscina_solar
      
      - stop: "AÃ§Ã£o noturna processada"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VERIFICAÃ‡ÃƒO BACKUP NOTURNO (20:30)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - if:
      - condition: trigger
        id: night_check
    then:
      - if:
          - condition: template
            value_template: "{{ night_backup_needed and night_backup_notify }}"
        then:
          - service: "{{ night_backup_notify }}"
            data:
              title: "ğŸŒ™ Filtragem Noturna Recomendada"
              message: >-
                Filtragem solar insuficiente hoje ({{ filtration_done_kwh|round(1) }} de {{ filtration_target_kwh|round(1) }} kWh).
                Fonte: {{ filtration_source }}
                PrevisÃ£o amanhÃ£: {{ forecast_tomorrow_kwh|round(0) }} kWh (fraco).
                
                Considere agendar filtragem noturna para compensar.
                
                DÃ©fice: {{ filtration_needed_kwh|round(1) }} kWh
                Tempo necessÃ¡rio: {{ (filtration_needed_kwh / (pump_nominal_power/1000))|round(1) }} horas
          - if:
              - condition: template
                value_template: "{{ enable_debug_logs }}"
            then:
              - service: system_log.write
                data:
                  message: "ğŸŒ™ Backup noturno: dÃ©fice={{ filtration_needed_kwh|round(1) }}kWh, amanhÃ£={{ forecast_tomorrow_kwh|round(0) }}kWh"
                  level: warning
                  logger: blueprints.piscina_solar
      - stop: "Night check completed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # LOG DE DIAGNÃ“STICO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - if:
      - condition: template
        value_template: "{{ enable_debug_logs }}"
    then:
      - service: system_log.write
        data:
          message: >-
            ğŸŠ Piscina Solar v2: mode={{ operation_mode }}, 
            source={{ source_used }}, 
            export={{ export_available|round(0) }}W, 
            import_pred={{ import_predicted|round(0) }}W, 
            limit={{ final_import_limit|round(0) }}W, 
            pump={{ 'ON' if pump_is_on else 'OFF' }}, 
            should={{ 'ON' if should_turn_on else 'OFF' }},
            forecast={{ forecast_kwh|round(1) }}kWh,
            available={{ available_for_pool_kwh|round(1) }}kWh,
            house_now={{ house_power_now|round(0) }}W,
            house_avg7d={{ house_power_avg_7d|round(0) }}W,
            house_est={{ house_consumption_estimate }}kWh,
            hours_left={{ hours_until_sunset }},
            drop_1h={{ power_drop_expected }}%
          level: info
          logger: blueprints.piscina_solar
          
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DECISÃƒO: LIGAR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - if:
      - condition: template
        value_template: "{{ should_turn_on and not pump_is_on }}"
    then:
      - if:
          - condition: template
            value_template: "{{ enable_debug_logs }}"
        then:
          - service: system_log.write
            data:
              message: "ğŸŠâ³ Aguardando delay_on={{ effective_delay_on }}s (base={{ delay_on }}s Ã— mode Ã— weather={{ weather_multiplier }}Ã—)"
              level: info
              logger: blueprints.piscina_solar
      
      - delay:
          seconds: "{{ effective_delay_on }}"
          
      - if:
          - condition: template
            value_template: >-
              {% set imp_pred = import_predicted %}
              {% set lim = final_import_limit - effective_start_margin %}
              {{ imp_pred <= lim }}
        then:
          - service: switch.turn_on
            target:
              entity_id: !input pump_switch
              
          - if:
              - condition: template
                value_template: "{{ enable_debug_logs }}"
            then:
              - service: system_log.write
                data:
                  message: "ğŸŠ Bomba LIGADA [{{ operation_mode }}]: import={{ import_predicted|round(0) }}W, limit={{ final_import_limit|round(0) }}W"
                  level: info
                  logger: blueprints.piscina_solar
                  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DECISÃƒO: DESLIGAR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - if:
      - condition: template
        value_template: "{{ not should_turn_on and pump_is_on }}"
    then:
      - if:
          - condition: template
            value_template: >-
              {% set entity = states[pump_switch] %}
              {% if entity %}
                {% set last_on_time = entity.last_changed if entity.state == 'on' else none %}
                {% if last_on_time %}
                  {% set minutes_on = (now() - last_on_time).total_seconds() / 60 %}
                  {{ minutes_on >= min_on_time }}
                {% else %}
                  {{ true }}
                {% endif %}
              {% else %}
                {{ true }}
              {% endif %}
        then:
          - if:
              - condition: template
                value_template: "{{ enable_debug_logs }}"
            then:
              - service: system_log.write
                data:
                  message: "ğŸŠâ³ Aguardando delay_off={{ effective_delay_off }}s (base={{ delay_off }}s Ã— drop_factor Ã— weather={{ weather_multiplier }}Ã—)"
                  level: info
                  logger: blueprints.piscina_solar
          
          - delay:
              seconds: "{{ effective_delay_off }}"
              
          # ğŸ†• Re-verificar apÃ³s delay se ainda deve desligar
          - if:
              - condition: template
                value_template: >-
                  {% set imp_curr = import_current %}
                  {% set lim = final_import_limit %}
                  {{ imp_curr > lim }}
            then:
              - service: switch.turn_off
                target:
                  entity_id: !input pump_switch
                  
              - if:
                  - condition: template
                    value_template: "{{ enable_debug_logs }}"
                then:
                  - service: system_log.write
                    data:
                      message: "ğŸŠ Bomba DESLIGADA [{{ operation_mode }}]: import={{ import_current|round(0) }}W > limit={{ final_import_limit|round(0) }}W"
                      level: info
                      logger: blueprints.piscina_solar
            else:
              # ğŸ†• Log quando NÃƒO desliga apÃ³s re-check
              - if:
                  - condition: template
                    value_template: "{{ enable_debug_logs }}"
                then:
                  - service: system_log.write
                    data:
                      message: "ğŸŠ Bomba MANTIDA [{{ operation_mode }}]: condiÃ§Ãµes melhoraram apÃ³s delay_off, import={{ import_current|round(0) }}W â‰¤ limit={{ final_import_limit|round(0) }}W"
                      level: info
                      logger: blueprints.piscina_solar
        else:
          # ğŸ†• Log quando min_on_time ainda nÃ£o atingido
          - if:
              - condition: template
                value_template: "{{ enable_debug_logs }}"
            then:
              - service: system_log.write
                data:
                  message: >-
                    ğŸŠ Bomba NÃƒO PODE DESLIGAR [{{ operation_mode }}]: min_on_time={{ min_on_time }}min nÃ£o atingido
                    {% set entity = states[pump_switch] %}
                    {% if entity and entity.state == 'on' %}
                      {% set minutes_on = ((now() - entity.last_changed).total_seconds() / 60)|round(1) %}
                      , ligada hÃ¡ {{ minutes_on }}min
                    {% endif %}
                  level: info
                  logger: blueprints.piscina_solar

mode: single
max_exceeded: silent
