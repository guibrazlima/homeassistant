# ================================================================
# PORT√ïES - BOT√ïES DE CONTROLO
# ================================================================
# Descri√ß√£o: Automa√ß√µes para controlar o port√£o atrav√©s de bot√µes
#            espalhados pela casa (Shelly, Sala, Quarto, etc.)
# Categoria: Port√µes e Portarias
# Total: 7 automa√ß√µes
# √öltima atualiza√ß√£o: 2025-11-11
# ================================================================

# ----------------------------------------------------------------
# 1. BOT√ÉO SHELLY - ABRIR PORT√ÉO
# ----------------------------------------------------------------
- id: portao_botao_shelly_abrir
  alias: üö™ Port√£o - Bot√£o Shelly Abrir
  description: |
    Abre o port√£o principal quando o bot√£o Shelly √© pressionado.
    
    Funcionamento:
    - Detecta press√£o √∫nica no bot√£o Shelly
    - Aciona o rel√© do motor do port√£o
    - Envia notifica√ß√£o para telem√≥vel
    - Regista evento no hist√≥rico
    
    Seguran√ßa:
    - Timeout de 30 segundos
    - Previne ativa√ß√µes m√∫ltiplas simult√¢neas
    - Verifica se sistema est√° operacional
    
    Dispositivos:
    - Trigger: binary_sensor.botao_shelly_portao
    - Action: switch.portao_motor
  
  mode: single  # Previne execu√ß√µes m√∫ltiplas
  max_exceeded: warning  # Alerta se tentar executar novamente
  
  trigger:
    - platform: state
      entity_id: binary_sensor.botao_shelly_portao
      to: 'on'
      from: 'off'
  
  condition:
    # Sistema operacional
    - condition: state
      entity_id: binary_sensor.sistema_operacional
      state: 'on'
    
    # Hor√°rio permitido (6h-23h)
    - condition: time
      after: '06:00:00'
      before: '23:00:00'
    
    # Port√£o n√£o est√° em movimento
    - condition: template
      value_template: "{{ states('sensor.portao_estado') not in ['opening', 'closing'] }}"
  
  action:
    # Log in√≠cio
    - service: logbook.log
      data:
        name: "Port√£o Principal"
        message: "Abertura iniciada via bot√£o Shelly"
        entity_id: switch.portao_motor
    
    # Acionar motor
    - service: switch.turn_on
      target:
        entity_id: switch.portao_motor
      data:
        duration: 30  # Timeout de seguran√ßa
    
    # Notifica√ß√£o
    - service: notify.mobile_app
      data:
        title: "üö™ Port√£o"
        message: "Port√£o a abrir (Bot√£o Shelly)"
        data:
          tag: portao_movimento
          group: seguranca
          notification_icon: mdi:gate
          channel: Port√µes
          importance: default
    
    # Aguardar conclus√£o
    - wait_for_trigger:
        - platform: state
          entity_id: binary_sensor.portao_aberto
          to: 'on'
      timeout:
        seconds: 35
      continue_on_timeout: true
    
    # Verificar se abriu com sucesso
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ wait.trigger is none }}"
          sequence:
            - service: notify.mobile_app
              data:
                title: "‚ö†Ô∏è Erro Port√£o"
                message: "Port√£o n√£o abriu completamente (timeout)"
                data:
                  tag: portao_erro
                  group: alertas
                  importance: high

# ----------------------------------------------------------------
# 2. BOT√ÉO SALA - ABRIR PORT√ÉO
# ----------------------------------------------------------------
- id: portao_botao_sala_abrir
  alias: üö™ Port√£o - Bot√£o Sala Abrir
  description: |
    Abre o port√£o atrav√©s do bot√£o da sala.
    Similar ao bot√£o Shelly mas com trigger diferente.
  
  mode: single
  max_exceeded: warning
  
  trigger:
    - platform: state
      entity_id: binary_sensor.botao_sala_portao
      to: 'on'
  
  condition:
    - condition: state
      entity_id: binary_sensor.sistema_operacional
      state: 'on'
    - condition: time
      after: '06:00:00'
      before: '23:00:00'
  
  action:
    - service: logbook.log
      data:
        name: "Port√£o Principal"
        message: "Abertura via bot√£o Sala"
    
    - service: switch.turn_on
      target:
        entity_id: switch.portao_motor
      data:
        duration: 30
    
    - service: notify.mobile_app
      data:
        title: "üö™ Port√£o"
        message: "Port√£o a abrir (Sala)"

# ================================================================
# FIM DO FICHEIRO - EXEMPLO
# ================================================================
# Este √© apenas um EXEMPLO de como ficar√° um ficheiro reorganizado.
# Mostra as boas pr√°ticas aplicadas:
# ‚úÖ IDs descritivos
# ‚úÖ Descri√ß√µes completas
# ‚úÖ Coment√°rios organizados
# ‚úÖ Mode e max_exceeded
# ‚úÖ Condi√ß√µes de seguran√ßa
# ‚úÖ Tratamento de erros
# ‚úÖ Notifica√ß√µes estruturadas
# ================================================================
