# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SENSOR DE AJUSTE CLIMÃTICO (v2 - com detecÃ§Ã£o de instabilidade)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Ajusta delays da blueprint combinando:
#   1. CondiÃ§Ã£o meteorolÃ³gica (sensor.realtime_condition)
#   2. Instabilidade solar real (sensor.solar_stability_indicator)
#
# O multiplicador final Ã© o MAIOR entre meteo e instabilidade,
# garantindo proteÃ§Ã£o contra cycling em dias de nuvens intermitentes.
#
# Multiplicadores METEO (base):
#   â˜€ï¸ sunny/clear ........... 0.8Ã— (solar estÃ¡vel)
#   ğŸŒ¤ partlycloudy .......... 1.0Ã— (normal)
#   â˜ï¸ cloudy ................. 1.5Ã— (conservador)
#   ğŸŒ§ rainy/pouring ......... 2.0Ã— (muito conservador)
#
# Multiplicadores INSTABILIDADE (variaÃ§Ã£o FV):
#   < 10% variaÃ§Ã£o ........... 1.0Ã— (estÃ¡vel)
#   10-25% variaÃ§Ã£o .......... 1.5Ã— (ligeira instabilidade)
#   25-40% variaÃ§Ã£o .......... 2.0Ã— (instÃ¡vel)
#   40-60% variaÃ§Ã£o .......... 2.5Ã— (muito instÃ¡vel)
#   > 60% variaÃ§Ã£o ........... 3.0Ã— (extremamente instÃ¡vel)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- platform: template
  sensors:
    piscina_weather_delay_multiplier:
      friendly_name: "Multiplicador Delay Meteorologia"
      unique_id: piscina_weather_delay_multiplier
      unit_of_measurement: "Ã—"
      icon_template: >
        {% set var_pct = states('sensor.solar_stability_indicator') | float(0) %}
        {% set condition = states('sensor.realtime_condition') %}
        {% if var_pct > 40 %}
          mdi:weather-lightning
        {% elif var_pct > 25 %}
          mdi:weather-partly-snowy-rainy
        {% elif condition in ['sunny', 'clear'] %}
          mdi:weather-sunny
        {% elif condition in ['partlycloudy', 'cloudy'] %}
          mdi:weather-cloudy
        {% elif condition in ['rainy', 'pouring'] %}
          mdi:weather-rainy
        {% else %}
          mdi:weather-partly-cloudy
        {% endif %}
      value_template: >
        {% if is_state('input_boolean.piscina_use_weather_forecast', 'off') %}
          1.0
        {% else %}
          {# --- Multiplicador METEO (condiÃ§Ã£o do tempo) --- #}
          {% set condition = states('sensor.realtime_condition') %}
          {% if condition in ['sunny', 'clear'] %}
            {% set meteo_mult = 0.8 %}
          {% elif condition in ['partlycloudy'] %}
            {% set meteo_mult = 1.0 %}
          {% elif condition in ['cloudy'] %}
            {% set meteo_mult = 1.5 %}
          {% elif condition in ['rainy', 'pouring'] %}
            {% set meteo_mult = 2.0 %}
          {% else %}
            {% set meteo_mult = 1.0 %}
          {% endif %}
          {# --- Multiplicador INSTABILIDADE (variaÃ§Ã£o FV real) --- #}
          {% set var_pct = states('sensor.solar_stability_indicator') | float(0) %}
          {% if var_pct < 10 %}
            {% set inst_mult = 1.0 %}
          {% elif var_pct < 25 %}
            {% set inst_mult = 1.5 %}
          {% elif var_pct < 40 %}
            {% set inst_mult = 2.0 %}
          {% elif var_pct < 60 %}
            {% set inst_mult = 2.5 %}
          {% else %}
            {% set inst_mult = 3.0 %}
          {% endif %}
          {# --- Resultado final: o MAIOR dos dois --- #}
          {{ [meteo_mult, inst_mult] | max }}
        {% endif %}
      attribute_templates:
        weather_condition: "{{ states('sensor.realtime_condition') }}"
        solar_variation_pct: "{{ states('sensor.solar_stability_indicator') | float(0) | round(1) }}"
        meteo_multiplier: >
          {% set condition = states('sensor.realtime_condition') %}
          {% if condition in ['sunny', 'clear'] %}
            0.8
          {% elif condition in ['partlycloudy'] %}
            1.0
          {% elif condition in ['cloudy'] %}
            1.5
          {% elif condition in ['rainy', 'pouring'] %}
            2.0
          {% else %}
            1.0
          {% endif %}
        instability_multiplier: >
          {% set var_pct = states('sensor.solar_stability_indicator') | float(0) %}
          {% if var_pct < 10 %}
            1.0
          {% elif var_pct < 25 %}
            1.5
          {% elif var_pct < 40 %}
            2.0
          {% elif var_pct < 60 %}
            2.5
          {% else %}
            3.0
          {% endif %}
        adjustment_enabled: "{{ is_state('input_boolean.piscina_use_weather_forecast', 'on') }}"
        recommendation: >
          {% set condition = states('sensor.realtime_condition') %}
          {% set var_pct = states('sensor.solar_stability_indicator') | float(0) %}
          {% set mult = states('sensor.piscina_weather_delay_multiplier') | float(1.0) %}
          {% if is_state('input_boolean.piscina_use_weather_forecast', 'off') %}
            âšª Ajuste desativado
          {% elif var_pct >= 60 %}
            ğŸ”´ Extremamente instÃ¡vel (FV Â±{{ var_pct | round(0) }}%) - delays Ã—{{ mult }}
          {% elif var_pct >= 40 %}
            ğŸ”´ Muito instÃ¡vel (FV Â±{{ var_pct | round(0) }}%) - delays Ã—{{ mult }}
          {% elif var_pct >= 25 %}
            âš ï¸ InstÃ¡vel (FV Â±{{ var_pct | round(0) }}%) - delays Ã—{{ mult }}
          {% elif condition in ['rainy', 'pouring'] %}
            ğŸŒ§ Chuva - delays Ã—{{ mult }}
          {% elif condition in ['cloudy'] %}
            â˜ï¸ Nublado - delays Ã—{{ mult }}
          {% elif condition in ['sunny', 'clear'] %}
            â˜€ï¸ Solar estÃ¡vel - delays Ã—{{ mult }}
          {% else %}
            âœ… Normal - delays Ã—{{ mult }}
          {% endif %}
