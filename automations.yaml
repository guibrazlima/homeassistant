- id: piscina_llmvision_sal_baixo
  alias: "\U0001F3CA\U0001F3FB Piscina - Sal baixo (LLM Vision, amostragem+debounce)"
  description: Recolhe até 3 amostras rápidas (1.2s) do painel do clorador CTX com
    LLM Vision. Se alguma amostra der 'on', ativa o estado RAW. Em seguida aplica
    debounce para só desligar o estado final após N leituras 'off' consecutivas.
  triggers:
  - seconds: /30
    trigger: time_pattern
  - entity_id: switch.piscina_cloro_permitir_producao
    to: 'on'
    for: 00:00:30
    trigger: state
  conditions:
  - condition: state
    entity_id: switch.piscina_cloro_permitir_producao
    state: 'on'
  actions:
  - variables:
      provider_id: 01K5S60RJSW6MFMB543KEDHE23
      camera_entity: camera.cave_hd_stream
  - repeat:
      sequence:
      - continue_on_error: true
        data:
          provider: '{{ provider_id }}'
          model: gpt-4o-mini
          sensor_entity: input_boolean.piscina_sal_baixo_raw
          image_entity:
          - '{{ camera_entity }}'
          target_width: 1280
          include_filename: false
          max_tokens: 3
          message: 'Observa APENAS o painel frontal do clorador CTX Go Salt. Foca
            a luz/LED de SAL BAIXO (canto superior direito do painel). Se a luz estiver
            acesa OU a piscar em qualquer intensidade, responde: on Caso contrário,
            responde: off Responde apenas com ''on'' ou ''off'' — sem mais texto.'
        response_variable: response
        action: llmvision.data_analyzer
      - delay: '00:00:01.2'
      until:
      - or:
        - condition: state
          entity_id: input_boolean.piscina_sal_baixo_raw
          state: 'on'
        - condition: template
          value_template: '{{ repeat.index >= 3 }}'
  - choose:
    - conditions:
      - condition: state
        entity_id: input_boolean.piscina_sal_baixo_raw
        state: 'on'
      sequence:
      - target:
          entity_id: input_boolean.piscina_sal_baixo
        action: input_boolean.turn_on
      - target:
          entity_id: input_number.piscina_sal_baixo_off_streak
        data:
          value: 0
        action: input_number.set_value
    - conditions:
      - condition: state
        entity_id: input_boolean.piscina_sal_baixo_raw
        state: 'off'
      sequence:
      - target:
          entity_id: input_number.piscina_sal_baixo_off_streak
        action: input_number.increment
      - condition: template
        value_template: "{{ states('input_number.piscina_sal_baixo_off_streak')|int(0)\n
          \  >= states('input_number.piscina_sal_baixo_off_debounce')|int(3) }}"
      - target:
          entity_id: input_boolean.piscina_sal_baixo
        action: input_boolean.turn_off
      - target:
          entity_id: input_number.piscina_sal_baixo_off_streak
        data:
          value: 0
        action: input_number.set_value
  mode: restart
- id: piscina_cloro_tpo_seconds
  alias: "\U0001F3CA\U0001F3FB Piscina - Cloração TPO por Cobertura (segundos)"
  trigger:
  - platform: time_pattern
    seconds: /30
  variables:
    janela_min: '{{ states(''input_number.piscina_cloro_janela_min'') | int(10) }}'
    janela_s: '{{ janela_min * 60 }}'
    pct_aberta: '{{ states(''input_number.piscina_pct_cobertura_aberta'') | float(100)
      }}'
    pct_fechada: '{{ states(''input_number.piscina_pct_cobertura_fechada'') | float(30)
      }}'
    pct: "{{ pct_fechada if is_state('input_boolean.piscina_cobertura_fechada','on')\n
      \  else pct_aberta }}"
    on_s: '{{ (pct/100 * janela_s) | int }}'
    ciclo_s: '{{ (now().timestamp() | int) % janela_s }}'
  condition:
  - condition: state
    entity_id: input_boolean.piscina_cloro_tpo_enable
    state: 'on'
  - condition: state
    entity_id: switch.bomba_piscina_switch_0
    state: 'on'
  action:
  - choose:
    - conditions: '{{ pct >= 99 }}'
      sequence:
      - service: switch.turn_on
        target:
          entity_id: switch.piscina_cloro_permitir_producao
    - conditions: '{{ pct <= 1 }}'
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.piscina_cloro_permitir_producao
    - conditions: '{{ ciclo_s < on_s }}'
      sequence:
      - service: switch.turn_on
        target:
          entity_id: switch.piscina_cloro_permitir_producao
    - conditions: []
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.piscina_cloro_permitir_producao
  mode: single
- id: piscina_cloro_tpo_failsafe
  alias: "\U0001F3CA\U0001F3FB Piscina - Cloração TPO (failsafe OFF)"
  trigger:
  - platform: state
    entity_id: switch.bomba_piscina_switch_0
  - platform: state
    entity_id: input_boolean.piscina_cloro_tpo_enable
  - platform: state
    entity_id: input_boolean.piscina_cobertura_fechada
  action:
  - choose:
    - conditions:
      - condition: or
        conditions:
        - condition: state
          entity_id: switch.bomba_piscina_switch_0
          state: 'off'
        - condition: state
          entity_id: input_boolean.piscina_cloro_tpo_enable
          state: 'off'
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.piscina_cloro_permitir_producao
  mode: restart
- id: piscina_llmvision_cobertura
  alias: "\U0001F3CA\U0001F3FB Piscina - Estado da cobertura (LLM Vision)"
  description: ''
  triggers:
  - entity_id: switch.bomba_piscina_switch_0
    to: 'on'
    for: 00:05:00
    trigger: state
  - minutes: /30
    trigger: time_pattern
  conditions:
  - condition: state
    entity_id: switch.bomba_piscina_switch_0
    state: 'on'
  actions:
  - continue_on_error: true
    response_variable: llmresp
    data:
      provider: 01K5S60RJSW6MFMB543KEDHE23
      model: gpt-4o-mini
      message: 'TAREFA: Classificar a imagem de uma piscina com cobertura branca.

        CRITÉRIO: - "true" se a cobertura cobre toda a água (ripas/linhas e reflexos
        contam como fechada). - "false" se se vê água descoberta ~10% ou uma abertura
        evidente.

        CONTEXTO: - Estado anterior: {{ ''true'' if is_state(''input_boolean.piscina_cobertura_fechada'',''on'')
        else ''false'' }} - Se a imagem for ambígua, responde com o Estado anterior.

        RESPOSTA: Responde EXACTAMENTE: true ou false (minúsculas), sem mais texto.

        '
      sensor_entity: input_boolean.piscina_cobertura_fechada
      image_entity:
      - camera.eira_piscina_hd_stream
      max_tokens: 1
      target_width: 960
      include_filename: false
    action: llmvision.data_analyzer
  mode: restart
- id: piscina_cobertura_quando_bomba_para
  alias: "\U0001F3CA\U0001F3FB Piscina — Verificar cobertura ao parar da bomba"
  description: ''
  triggers:
  - entity_id: switch.bomba_piscina_switch_0
    to: 'off'
    for: 00:15:00
    trigger: state
  - event: sunset
    trigger: sun
  actions:
  - continue_on_error: true
    response_variable: llmresp
    data:
      provider: 01K5S60RJSW6MFMB543KEDHE23
      model: gpt-4o-mini
      message: 'TAREFA: Classificar a imagem de uma piscina com cobertura branca.

        CRITÉRIO: - "true" se a cobertura cobre toda a água (ripas/linhas e reflexos
        contam como fechada). - "false" se se vê água descoberta ~10% ou uma abertura
        evidente.

        CONTEXTO: - Estado anterior: {{ ''true'' if is_state(''input_boolean.piscina_cobertura_fechada'',''on'')
        else ''false'' }} - Se a imagem for ambígua, responde com o Estado anterior.

        RESPOSTA: Responde EXACTAMENTE: true ou false (minúsculas), sem mais texto.

        '
      sensor_entity: input_boolean.piscina_cobertura_fechada
      image_entity:
      - camera.eira_piscina_hd_stream
      max_tokens: 1
      target_width: 960
      include_filename: false
    action: llmvision.data_analyzer
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ llmresp.response_text | default('''') | lower() | trim
          == ''false'' }}

          '
      sequence:
      - data:
          message: "\U0001F6A8 A cobertura da piscina está ABERTA!\n"
        action: telegram_bot.send_message
  mode: restart
- id: piscina_ph_ocr
  alias: "\U0001F3CA\U0001F3FB Piscina - pH (bomba ON; hora a hora)"
  description: ''
  triggers:
  - entity_id: switch.bomba_piscina_switch_0
    to: 'on'
    for: 00:05:00
    trigger: state
  actions:
  - continue_on_error: true
    data:
      provider: '{{ provider }}'
      model: '{{ model }}'
      message: '{{ ph_prompt }}'
      sensor_entity: input_number.ph_piscina_raw
      image_entity:
      - '{{ camera_entity }}'
      max_tokens: 5
      target_width: 1280
      include_filename: false
      temperature: 0
    response_variable: resp_ph_now
    action: llmvision.data_analyzer
  - choose:
    - conditions:
      - condition: template
        value_template: "{{ (states('input_number.ph_piscina_raw')|float(-1)) >= 6\n
          \  and (states('input_number.ph_piscina_raw')|float(-1)) <= 9 }}\n"
      sequence:
      - target:
          entity_id: input_number.ph_piscina
        data:
          value: '{{ states(''input_number.ph_piscina_raw'')|float }}'
        action: input_number.set_value
    default: []
  - repeat:
      while:
      - condition: state
        entity_id: switch.bomba_piscina_switch_0
        state: 'on'
      sequence:
      - delay: 01:00:00
      - condition: state
        entity_id: switch.bomba_piscina_switch_0
        state: 'on'
      - continue_on_error: true
        data:
          provider: '{{ provider }}'
          model: '{{ model }}'
          message: '{{ ph_prompt }}'
          sensor_entity: input_number.ph_piscina_raw
          image_entity:
          - '{{ camera_entity }}'
          max_tokens: 5
          target_width: 1280
          include_filename: false
          temperature: 0
        response_variable: resp_ph_loop
        action: llmvision.data_analyzer
      - choose:
        - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ph_piscina_raw')|float(-1))
              >= 6\n   and (states('input_number.ph_piscina_raw')|float(-1)) <= 9
              }}\n"
          sequence:
          - target:
              entity_id: input_number.ph_piscina
            data:
              value: '{{ states(''input_number.ph_piscina_raw'')|float }}'
            action: input_number.set_value
  mode: restart
  variables:
    camera_entity: camera.cave_hd_stream
    provider: 01K5S60RJSW6MFMB543KEDHE23
    model: gpt-4o-mini
    ph_prompt: 'TAREFA: Ler o valor de pH no visor da bomba (dígitos 7-seg). REGRAS:
      - Devolve apenas um número com PONTO e 1 decimal (ex.: 7.3). - Se não vires
      o ponto mas leres dois dígitos (ex.: 73), interpreta como 7.3. RESPOSTA: apenas
      o número.'
- id: piscina_ph_backup_on_change
  alias: "\U0001F3CA\U0001F3FB Piscina - pH (guardar backups ao mudar)"
  description: ''
  triggers:
  - entity_id:
    - input_number.ph_piscina
    - input_number.ph_piscina_raw
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''input_number.ph_piscina'' }}'
      sequence:
      - variables:
          v: '{{ states(''input_number.ph_piscina'') }}'
      - condition: template
        value_template: '{{ v not in [''unknown'',''unavailable'',''none''] and (v|float(0))
          != 0 }}'
      - action: input_text.set_value
        target:
          entity_id: input_text.ph_piscina_backup
        data:
          value: '{{ ''%.2f''|format(v|float) }}'
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''input_number.ph_piscina_raw'' }}'
      sequence:
      - variables:
          r: '{{ states(''input_number.ph_piscina_raw'') }}'
      - condition: template
        value_template: '{{ r not in [''unknown'',''unavailable'',''none''] }}'
      - action: input_text.set_value
        target:
          entity_id: input_text.ph_piscina_raw_backup
        data:
          value: '{{ r }}'
  mode: queued
- id: piscina_ph_restore_on_start
  alias: "\U0001F3CA\U0001F3FB Piscina - pH (restaurar no arranque)"
  description: ''
  triggers:
  - event: start
    trigger: homeassistant
  actions:
  - delay: 00:00:15
  - variables:
      ph_state: '{{ states(''input_number.ph_piscina'') }}'
      ph_backup: '{{ states(''input_text.ph_piscina_backup'') }}'
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ ph_state in [''unknown'',''unavailable'',''none'',''0'',''0.0'']
          or (ph_state|float(0) == 0) }}

          '
      sequence:
      - condition: template
        value_template: '{{ ph_backup not in ['''',''unknown'',''unavailable'',''none'']
          }}'
      - target:
          entity_id: input_number.ph_piscina
        data:
          value: '{{ ph_backup|float }}'
        action: input_number.set_value
  - variables:
      ph_raw_state: '{{ states(''input_number.ph_piscina_raw'') }}'
      ph_raw_backup: '{{ states(''input_text.ph_piscina_raw_backup'') }}'
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ ph_raw_state in [''unknown'',''unavailable'',''none'',''0'',''0.0'']
          or (ph_raw_state|float(0) == 0) }}

          '
      sequence:
      - condition: template
        value_template: '{{ ph_raw_backup not in ['''',''unknown'',''unavailable'',''none'']
          }}'
      - target:
          entity_id: input_number.ph_piscina_raw
        data:
          value: '{{ ph_raw_backup|float }}'
        action: input_number.set_value
  mode: single
- id: bomba_piscina_noite
  alias: "\U0001F3CA\U0001F3FB Piscina - Bomba Piscina Noite"
  description: 'Liga a bomba da piscina à noite para compensar filtragem insuficiente
    durante o dia (prioridade solar). Ajusta duração por estação. Só liga se faltar
    mais de 1 hora de filtragem.

    '
  triggers:
  - trigger: time
    at: 00:00:00
    id: meia_noite
  - trigger: time
    at: input_datetime.horario_piscina_noite
    id: horario_dinamico
    enabled: false
  conditions:
  - alias: Ainda não correu hoje
    condition: template
    value_template: '{{ not ja_correu_hoje }}'
  - alias: Falta mais de 1 hora de filtragem
    condition: template
    value_template: '{{ tempo_compensar > 3600 }}'
  - alias: Dia nublado OU filtragem hoje muito baixa
    condition: or
    conditions:
    - condition: template
      value_template: '{{ cobertura_nuvens > 35 }}'
    - condition: template
      value_template: '{{ filtragem_hoje <= 3600 }}'
  actions:
  - alias: Registar início da filtragem noturna
    action: system_log.write
    data:
      message: 'Bomba Piscina Noite iniciada: Trigger={{ trigger.id }}, Filtragem
        ontem={{ (filtragem_ontem / 3600) | round(2) }}h, Threshold={{ threshold_ativo
        }}min ({{ ''verão/primavera'' if e_verao_primavera else ''outono/inverno''
        }}), Tempo a compensar={{ (tempo_compensar / 60) | round(0) }}min, Nuvens={{
        cobertura_nuvens }}%

        '
      level: info
      logger: automations.piscina
  - alias: Notificar início
    action: persistent_notification.create
    data:
      title: "\U0001F3CA Bomba Piscina Noite"
      message: 'A iniciar filtragem noturna. Duração prevista: {{ (tempo_compensar
        / 60) | round(0) }} minutos. Motivo: Filtragem ontem ({{ (filtragem_ontem
        / 3600) | round(1) }}h) < mínimo ({{ threshold_ativo / 60 }}h)

        '
      notification_id: bomba_piscina_noite
  - alias: Ligar bomba com retry
    repeat:
      while:
      - condition: state
        entity_id: switch.bomba_piscina_switch_0
        state: 'off'
      - condition: template
        value_template: '{{ repeat.index <= 20 }}'
      sequence:
      - action: switch.turn_on
        target:
          entity_id: switch.bomba_piscina_switch_0
      - delay:
          seconds: 10
      - if:
        - condition: state
          entity_id: switch.bomba_piscina_switch_0
          state: 'off'
        then:
        - action: system_log.write
          data:
            message: 'Bomba Piscina: Tentativa {{ repeat.index }} falhou, a tentar
              novamente...'
            level: warning
            logger: automations.piscina
  - alias: Verificar se bomba ligou
    if:
    - condition: state
      entity_id: switch.bomba_piscina_switch_0
      state: 'off'
    then:
    - action: persistent_notification.create
      data:
        title: ⚠️ Bomba Piscina - ERRO
        message: Não foi possível ligar a bomba após 10 tentativas!
        notification_id: bomba_piscina_erro
    - stop: Bomba não ligou após 10 tentativas
  - alias: Aguardar tempo de filtragem
    delay:
      seconds: '{{ tempo_compensar }}'
  - alias: Desligar bomba
    action: switch.turn_off
    target:
      entity_id: switch.bomba_piscina_switch_0
  - alias: Registar fim da filtragem noturna
    action: system_log.write
    data:
      message: 'Bomba Piscina Noite concluída: {{ (tempo_compensar / 60) | round(0)
        }} minutos de filtragem'
      level: info
      logger: automations.piscina
  - action: persistent_notification.dismiss
    data:
      notification_id: bomba_piscina_noite
  variables:
    filtragem_ontem: '{{ state_attr(''sensor.filtragem_piscina_historico_s'', ''today-1'')
      | int(0) }}

      '
    filtragem_hoje: '{{ states(''sensor.filtragem_piscina_historico_s'') | int(0)
      }}

      '
    threshold_verao: '{{ states(''input_number.pool_pump_duration_lower_threshold'')
      | int(240) }}

      '
    threshold_inverno: '{{ states(''input_number.pool_pump_duration_inverno'') | int(120)
      }}

      '
    cobertura_nuvens: '{{ states(''sensor.media_de_cobertura_de_nuvens_10_00_18_00'')
      | float(100) }}

      '
    e_verao_primavera: '{{ states(''sensor.season'') in [''summer'', ''spring''] }}

      '
    threshold_ativo: '{{ threshold_verao if e_verao_primavera else threshold_inverno
      }}

      '
    threshold_segundos: '{{ threshold_ativo * 60 }}

      '
    tempo_compensar: '{{ [threshold_segundos - filtragem_ontem, 0] | max }}

      '
    ultima_execucao: '{{ state_attr(''automation.bomba_piscina_noite'', ''last_triggered'')
      }}

      '
    ja_correu_hoje: '{{ ultima_execucao is not none and ultima_execucao.date() ==
      now().date() }}

      '
  mode: single
  max_exceeded: warning
- id: ligardesligar_automacao_piscina
  alias: "\U0001F3CA\U0001F3FB Piscina - Ligar/Desligar Automação Piscina"
  description: Liga e desliga a Wallbox
  triggers:
  - minutes: /5
    trigger: time_pattern
  conditions: []
  actions:
  - if:
    - condition:
      - condition: sun
        after: sunrise
        before: sunset
      - condition: numeric_state
        entity_id: sensor.duracao_filtragem_piscina_diario_em_segundos
        above: 10800
      - condition: state
        entity_id: device_tracker.i4_edrive40
        state: home
      - condition: state
        entity_id: binary_sensor.i4_edrive40_connection_status
        state: 'on'
      - condition: numeric_state
        entity_id: sensor.i4_edrive40_remaining_battery_percent
        below: 100
    then:
    - data:
        stop_actions: true
      target:
        entity_id: automation.bomba_piscina_dia
      action: automation.turn_off
    - metadata: {}
      data: {}
      target:
        entity_id:
        - switch.bomba_piscina_switch_0
      action: switch.turn_off
    - metadata: {}
      data: {}
      target:
        entity_id: switch.wallbox_charging_enabled
      action: switch.turn_on
    else:
    - if:
      - condition: time
        after: 09:00:00
        before: '18:00:00'
      then:
      - data: {}
        target:
          entity_id: automation.bomba_piscina_dia
        action: automation.turn_on
      - metadata: {}
        data: {}
        target:
          entity_id: switch.wallbox_charging_enabled
        enabled: false
        action: switch.turn_off
      - metadata: {}
        data:
          skip_condition: true
        target:
          entity_id: automation.bomba_piscina_dia
        action: automation.trigger
      else:
      - data:
          stop_actions: true
        target:
          entity_id: automation.bomba_piscina_dia
        action: automation.turn_off
      - target:
          entity_id:
          - switch.wallbox_charging_enabled
        data: {}
        enabled: false
        action: switch.turn_on
  mode: single
  max_exceeded: warning
- id: variable_piscina_timer
  alias: "\U0001F3CA\U0001F3FB Piscina - Variable Piscina timer"
  description: Automação do Home Assistant.
  triggers:
  - at: 00:00:00
    trigger: time
  conditions: []
  actions:
  - metadata: {}
    data:
      replace_attributes: false
      value: '{{ states(''sensor.duracao_filtragem_piscina_diario_em_segundos'') |
        int(0) }}'
      attributes:
        today-1: '{{ states(''sensor.filtragem_piscina_historico_s'') | int(0) }}'
        today-2: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-1'')
          | int(0) }}'
        today-3: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-2'')
          | int(0) }}'
        today-4: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-3'')
          | int(0) }}'
        today-5: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-4'')
          | int(0) }}'
        today-6: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-5'')
          | int(0) }}'
        today-7: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-6'')
          | int(0) }}'
        today-8: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-7'')
          | int(0) }}'
        today-9: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-8'')
          | int(0) }}'
        today-10: '{{ state_attr(''sensor.filtragem_piscina_historico_s'',''today-9'')
          | int(0) }}'
    target:
      entity_id: sensor.filtragem_piscina_historico_s
    action: variable.update_sensor
  mode: single
  max_exceeded: warning
- id: bomba_piscina_dia
  alias: "[DESATIVADO] \U0001F3CA\U0001F3FB Piscina - Bomba Piscina Dia (PV Excess)"
  description: Controlo inteligente da bomba durante o dia baseado em excedente solar
    fotovoltaico usando blueprint PVExcessControl. Liga quando há excedente suficiente,
    desliga quando importa da rede.
  use_blueprint:
    path: PVExcessControl/pv_excess_control.yaml
    input:
      automation_id: automation.bomba_piscina_dia
      grid_voltage: 230
      pv_power: sensor.emoncms_solar
      export_power: sensor.emoncms_export_power_positive
      load_power: sensor.emoncms_use
      actual_power: sensor.bomba_piscina_switch_0_power
      power_toggle_margin: 10
      appliance_switch: switch.bomba_piscina_switch_0
      inverter_limit: 0
  mode: single
  max_exceeded: warning
- id: automacao_bomba_piscina
  alias: "[DESATIVADO] \U0001F3CA\U0001F3FB Piscina - Automação Bomba Piscina"
  description: Automação ativada por valor numérico de ['sensor.potencia_emonpi_import_export_media_5_minutos'],
    valor numérico de ['sensor.potencia_emonpi_import_export_media_5_minutos'].
  triggers:
  - entity_id:
    - sensor.potencia_emonpi_import_export_media_5_minutos
    below: -750
    id: 'ON'
    trigger: numeric_state
  - entity_id:
    - sensor.potencia_emonpi_import_export_media_5_minutos
    id: 'OFF'
    above: 750
    trigger: numeric_state
  conditions:
  - condition: sun
    after: sunrise
    before: sunset
  actions:
  - if:
    - condition: trigger
      id:
      - 'ON'
    then:
    - type: turn_on
      device_id: 1cb87651e79e117ef2610fc7e5c6a170
      entity_id: d1b3ca4d6a019622064ef94336bbd650
      domain: switch
    - type: turn_on
      device_id: d752f893fd0bb44490ec4bfcb83c333f
      entity_id: ae742d0d2f0dc5dea53a674346911926
      domain: switch
  - if:
    - condition: trigger
      id:
      - 'OFF'
    then:
    - type: turn_off
      device_id: 1cb87651e79e117ef2610fc7e5c6a170
      entity_id: d1b3ca4d6a019622064ef94336bbd650
      domain: switch
    - type: turn_off
      device_id: d752f893fd0bb44490ec4bfcb83c333f
      entity_id: ae742d0d2f0dc5dea53a674346911926
      domain: switch
  mode: single
  max_exceeded: warning
- id: bomba_piscina_botao
  alias: "\U0001F3CA\U0001F3FB Piscina - Bomba piscina botão"
  description: Automação do Home Assistant.
  triggers:
  - device_id: e6ae30b2d7855ae2d2b83b4497674bfb
    domain: bthome
    type: button
    subtype: press
    trigger: device
  conditions: []
  actions:
  - type: toggle
    device_id: d752f893fd0bb44490ec4bfcb83c333f
    entity_id: ae742d0d2f0dc5dea53a674346911926
    domain: switch
  mode: single
  max_exceeded: warning
- id: openai_daily_piscina
  alias: "\U0001F3CA\U0001F3FB Piscina - OpenAI Daily: Piscina"
  description: Automação do Home Assistant.
  triggers:
  - at: '20:30:00'
    trigger: time
  conditions: []
  actions:
  - data:
      agent_id: conversation.chatgpt
      text: Para esta tarefa, es um consultor de piscinas e queres garantir sempre
        que a piscina está limpa e pronta a usar. Mostra quando vai ser iniciada a
        filtragem da noite. Calcula se a horas de filtragem são suficientes, usa os
        dados que são enviados.  Podes e deves usar um tom humorista. Podes usar emojis.
        Responde em portugues de portugal sem gerúndio.  \_ Current time {{now()}}
        tempo que a bomba da piscina esteve a trabalhar em {{states('sensor.duracao_filtragem_piscina_diario')}}
        tempo que o aquecimento da piscina esteve a funcionar {{states('sensor.duracao_aquecimento_piscina_diario')}}  temperatura
        da piscina {{states('sensor.bomba_piscina_temperature')}}  tempo que falta
        filtrar a piscina {{states('sensor.pool_pump_remaining_time')}}  horario que
        vai ser iniciada a filtragem de noite {{states('sensor.bomba_piscina_noite_horario')}}   Quantidade
        maxima em minutos que a piscina filtra por dia, tranforma em horas {{states('input_number.pool_pump_duration_lower_threshold')}}  Energia
        gasta pela bomba da piscina {{states('sensor.energia_emonpi_piscina_use_total_kwhd')}}
        A bomba da piscina tem uma potencia de 1,5 CV. o volume da piscina é de 66
        metros cubicos.  calcula se a tempo de filtragem foi suficiente.
      language: pt-pt
    enabled: true
    response_variable: agent
    action: conversation.process
  - metadata: {}
    data:
      title: Piscina
      message: '{{agent.response.speech.plain.speech}}'
    action: telegram_bot.send_message
  mode: single
  max_exceeded: warning
- id: piscina_-_arranque_com_excedente_fv
  alias: "[DESATIVADO] \U0001F3CA\U0001F3FB Piscina - Arranque com excedente FV"
  description: Automação do Home Assistant.
  triggers:
  - entity_id: binary_sensor.piscina_excedente_fv_bomba
    to: 'on'
    for: 00:02:00
    trigger: state
  conditions:
  - condition: numeric_state
    entity_id: input_number.piscina_filtracao_min_restantes
    above: 0
  - condition: sun
    after: sunrise
    after_offset: 00:15:00
    before: sunset
    before_offset: -00:15:00
  actions:
  - target:
      entity_id:
      - switch.bomba_piscina
      - switch.bomba_piscina_switch_0
    action: switch.turn_on
    data: {}
  mode: single
  max_exceeded: warning
- id: piscina_-_manual_terminou_desligar_e_sair_do_overr
  alias: "\U0001F3CA\U0001F3FB Piscina - Manual terminou (desligar e sair do override)"
  description: Automação do Home Assistant.
  triggers:
  - event_type: timer.finished
    event_data:
      entity_id: timer.piscina_manual
    trigger: event
  conditions: []
  actions:
  - target:
      entity_id:
      - switch.bomba_piscina_switch_0
    action: switch.turn_off
    data: {}
  - target:
      entity_id: input_boolean.piscina_override_manual
    action: input_boolean.turn_off
    data: {}
  mode: single
  max_exceeded: warning
- id: piscina_-_watchdog_arranque_fv_2min_v2
  alias: "[DESATIVADO] \U0001F3CA\U0001F3FB Piscina - Watchdog arranque FV (*/2min)
    v2"
  description: Automação do Home Assistant.
  triggers:
  - minutes: /2
    trigger: time_pattern
  conditions:
  - condition: state
    entity_id: input_boolean.piscina_override_manual
    state: 'off'
  - condition: state
    state: 'off'
    entity_id: switch.bomba_piscina_switch_0
  - condition: numeric_state
    entity_id: input_number.piscina_filtracao_min_restantes
    above: 0
  - condition: state
    entity_id: binary_sensor.piscina_excedente_fv_bomba
    state: 'on'
  - condition: sun
    after: sunrise
    after_offset: 00:15:00
    before: sunset
    before_offset: -00:15:00
  actions:
  - target:
      entity_id: switch.bomba_piscina_switch_0
    action: switch.turn_on
    data: {}
  mode: single
  max_exceeded: warning
- id: actualizar_horario_bomba_piscina_noite
  alias: "\U0001F3CA\U0001F3FB Piscina - Actualizar Horario Bomba Piscina Noite"
  description: Automação do Home Assistant.
  triggers:
  - trigger: time_pattern
    minutes: /30
    hours: /1
  - trigger: state
    entity_id:
    - sensor.bomba_piscina_noite_horario
  conditions:
  - condition: time
    after: '13:00:00'
    before: '21:00:00'
  actions:
  - action: input_datetime.set_datetime
    metadata: {}
    data:
      datetime: "{% set horario = states('sensor.bomba_piscina_noite_horario') %}\n{%
        if horario not in ['unknown', 'unavailable', '', None] %}\n  {{ as_datetime(horario).astimezone().isoformat()
        }}\n{% else %}\n  {{ (now() + timedelta(days=1)).replace(hour=2, minute=0,
        second=0, microsecond=0).isoformat() }}\n{% endif %}"
    target:
      entity_id: input_datetime.horario_piscina_noite
  mode: single
  max_exceeded: warning
- id: atualizar_temperatura_piscina_filtrado_com_bomba_d
  alias: "\U0001F3CA\U0001F3FB Piscina - Atualizar Temperatura Piscina filtrado com
    bomba de aquecimento ligada"
  description: Automação do Home Assistant.
  triggers:
  - minutes: /5
    trigger: time_pattern
  conditions:
  - condition: state
    entity_id: switch.aquecimento_piscina_channel_1
    state: 'on'
    for:
      hours: 0
      minutes: 10
      seconds: 0
  - condition: template
    value_template: '{{ states(''sensor.bomba_piscina_temperature'') not in [''unavailable'',
      ''unknown''] }}'
  actions:
  - target:
      entity_id:
      - input_number.temperatura_piscina_filtrado
    data:
      value: '{{ states(''sensor.bomba_piscina_temperature'') | float(2) }}'
    action: input_number.set_value
  mode: single
  max_exceeded: warning
- id: piscina_estado_da_cobertura_llm_vision
  alias: "\U0001F3CA\U0001F3FB Piscina — Estado da cobertura (LLM Vision)"
  description: Automação do Home Assistant.
  triggers:
  - entity_id: switch.bomba_piscina_switch_0
    to: 'on'
    for: 00:05:00
    trigger: state
  - minutes: /30
    trigger: time_pattern
  conditions:
  - condition: state
    entity_id: switch.bomba_piscina_switch_0
    state: 'on'
    enabled: true
  actions:
  - response_variable: llmresp
    data:
      provider: 01K5S60RJSW6MFMB543KEDHE23
      model: gpt-4o-mini
      message: 'Observa esta imagem da piscina e responde apenas com um valor booleano
        para atualizar o sensor alvo: "true" se a COBERTURA estiver FECHADA. "false"
        se a COBERTURA estiver ABERTA. Regras: - Considera fechada apenas se a cobertura
        visivelmente cobre totalmente a lâmina de água. - Se a cobertura estiver a
        meio (a mover) ou houver dúvida, responde "false" (trata como aberta). - Não
        expliques. Não uses outras palavras.'
      sensor_entity: input_boolean.piscina_cobertura_fechada
      image_entity:
      - camera.eira_piscina_hd_stream
      max_tokens: 24
      target_width: 768
      include_filename: false
    action: llmvision.data_analyzer
  mode: restart
- id: callback_to_open_gate_from_action
  alias: "[\U0001F3E1] Callback to open gate from action"
  description: Automação ativada por evento mobile_app_notification_action.
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: ABRIR_PORTAO
  condition: []
  action:
  - service: cover.open_cover
    data: {}
    target:
      entity_id:
      - cover.gate
  mode: restart
- id: garage_light_on_when_gate_openscloses
  alias: "[\U0001F4A1\U0001F3E1] Garage light on when gate opens/closes"
  description: Automação ativada por mudança de estado em ['cover.gate'], mudança
    de estado em ['cover.gate'].
  trigger:
  - platform: state
    entity_id:
    - cover.gate
    from: closed
    to: open
    for:
      hours: 0
      minutes: 0
      seconds: 2
  - platform: state
    entity_id:
    - cover.gate
    from: open
    to: closed
    for:
      hours: 0
      minutes: 0
      seconds: 2
  condition:
  - condition: state
    entity_id: sun.sun
    state: below_horizon
  action:
  - if:
    - condition: state
      entity_id: cover.gate
      state: open
    then:
    - service: light.turn_on
      metadata: {}
      data: {}
      target:
        entity_id: light.exterior
  - if:
    - condition: state
      entity_id: cover.gate
      state: closed
      for:
        hours: 0
        minutes: 5
        seconds: 0
    then:
    - service: light.turn_off
      metadata: {}
      data: {}
      target:
        entity_id: light.exterior
  mode: single
  max_exceeded: warning
- id: envia_notificacao_para_abrir_o_portao_quando_chega
  alias: "[\U0001F4E3\U0001F3E1] Envia notificação para abrir o portão quando chega
    a casa"
  description: Automação ativada por valor numérico de ['sensor.home_glima_distance'],
    valor numérico de ['sensor.home_cmouta_distance'].
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.home_glima_distance
    below: 50
    id: glima1
  - platform: numeric_state
    entity_id:
    - sensor.home_cmouta_distance
    below: 50
    id: cmouta1
  condition: []
  action:
  - if:
    - condition: trigger
      id:
      - glima1
    then:
    - service: notify.mobile_app_glphone
      metadata: {}
      data:
        message: Queres abrir o portão de casa?
        title: "\U0001F3E1 \U0001F511 Bem-Vindo a casa Guilherme!"
        data:
          tag: open-home-gate
          action:
          - action: ABRIR_PORTAO
            title: Sim
            authenticationRequired: true
            activationMode: background
            icon: sfsymbols:door.garage.closed
    - delay:
        hours: 0
        minutes: 10
        seconds: 0
        milliseconds: 0
    - service: notify.mobile_app_glphone
      metadata: {}
      data:
        data:
          tag: open-home-gate
        message: clear_notification
  - if:
    - condition: trigger
      id:
      - cmouta1
    then:
    - service: notify.mobile_app_iphone_de_cristina_3
      metadata: {}
      data:
        message: Queres abrir o portão de casa?
        title: "\U0001F3E1 \U0001F511 Bem-Vinda a casa Cristina!"
        data:
          tag: open-home-gate
          action:
          - action: ABRIR_PORTAO
            title: Sim
            authenticationRequired: true
            activationMode: background
            icon: sfsymbols:door.garage.closed
    - delay:
        hours: 0
        minutes: 10
        seconds: 0
        milliseconds: 0
    - service: notify.mobile_app_iphone_de_cristina_3
      metadata: {}
      data:
        message: clear_notification
        data:
          tag: open-home-gate
  mode: single
  max_exceeded: warning
- id: status_portao
  alias: Status Portão
  description: Status do portão de casa, para resolver o flapping do sensor e o switch
    do shelly ter temporizador de 1 segundo.
  triggers:
  - entity_id:
    - switch.portao_shelly
    from:
    - 'off'
    to:
    - 'on'
    trigger: state
  conditions: []
  actions:
  - target:
      entity_id: input_boolean.portao_status
    data: {}
    action: input_boolean.turn_on
  - delay:
      hours: 0
      minutes: 0
      seconds: 50
      milliseconds: 0
  - target:
      entity_id: input_boolean.portao_status
    data: {}
    action: input_boolean.turn_off
  mode: single
  max_exceeded: warning
- id: botao_sala_portao
  alias: "\U0001F3E1Botão Sala Portão"
  description: Automação do Home Assistant.
  triggers:
  - device_id: d686deeba13232cfa6ab008fa8c80dc0
    domain: bthome
    type: button_2
    subtype: press
    trigger: device
  conditions: []
  actions:
  - type: turn_on
    device_id: 28d7cd7392efa97cb35b8bed17917b04
    entity_id: 90c40c35d39adfb3a7dbf7b57bd7dd66
    domain: switch
  mode: single
  max_exceeded: warning
- id: botao_shelly_abrir_portao
  alias: "[\U0001F3E1] Botão shelly Abrir Portão"
  description: Automação do Home Assistant.
  triggers:
  - device_id: f3ec058f8ec36d128a8eaf0dd7286320
    domain: bthome
    type: button
    subtype: press
    trigger: device
  conditions: []
  actions:
  - action: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - switch.portao_shelly
  mode: single
  max_exceeded: warning
- id: portao_botao_shelly_abrir
  alias: "\U0001F6AA Portão - Botão Shelly Abrir"
  description: 'Abre o portão principal quando o botão Shelly é pressionado.

    Dispositivos: binary_sensor.botao_shelly_portao → switch.portao_motor

    '
  mode: single
  max_exceeded: warning
  trigger:
  - platform: state
    entity_id: binary_sensor.botao_shelly_portao
    to: 'on'
    from: 'off'
  condition:
  - condition: time
    after: 06:00:00
    before: '23:00:00'
  action:
  - service: cover.open_cover
    target:
      entity_id: cover.gate
  - service: notify.mobile_app
    data:
      title: "\U0001F6AA Portão"
      message: Portão a abrir (Botão Shelly)
- id: portao_botao_sala_abrir
  alias: "\U0001F6AA Portão - Botão Sala Abrir"
  description: Abre o portão através do botão da sala
  mode: single
  max_exceeded: warning
  trigger:
  - platform: state
    entity_id: binary_sensor.botao_sala_portao
    to: 'on'
  condition:
  - condition: time
    after: 06:00:00
    before: '23:00:00'
  action:
  - service: cover.open_cover
    target:
      entity_id: cover.gate
  - service: notify.mobile_app
    data:
      title: "\U0001F6AA Portão"
      message: Portão a abrir (Sala)
- id: callback_notification_to_open_garage
  alias: "[\U0001F4E3\U0001F4F2] Callback notification to open garage"
  description: Automação ativada por evento ios.action_fired, evento ios.action_fired.
  trigger:
  - platform: event
    event_type: ios.action_fired
    event_data:
      actionID: 06BE95EF-F583-440C-9BED-C5FEB7684C15
    context:
      user_id:
      - fc76053283b948f39e0979158ba02875
    alias: gblima
    id: gblima2
  - platform: event
    event_type: ios.action_fired
    event_data:
      actionID: EA13513A-5C16-44C1-B9ED-8AEC747DC1D0
    context:
      user_id:
      - 7df539210ca3465e9ca91c3e2f1bd7e0
    alias: cmouta
    id: cmouta2
  condition: []
  action:
  - service: cover.open_cover
    data: {}
    target:
      entity_id:
      - cover.gate
  - delay:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  - alias: gblima notificações
    if:
    - condition:
      - condition: trigger
        id:
        - gblima2
      - condition: state
        entity_id: cover.gate
        state: closed
      - condition: state
        entity_id: input_boolean.gblima_present
        state: 'off'
    then:
    - service: notify.mobile_app_glphone
      metadata: {}
      data:
        message: "O portão está fechado.✅\U0001F512"
        title: "\U0001F697 Ate Logo! \U0001F642"
        data:
          tag: open-home-gate
    - delay:
        hours: 0
        minutes: 5
        seconds: 0
        milliseconds: 0
    - service: notify.mobile_app_glphone
      metadata: {}
      data:
        message: clear_notification
        data:
          tag: open-home-gate
    else:
    - if:
      - condition:
        - condition: trigger
          id:
          - gblima2
        - condition: state
          entity_id: input_boolean.gblima_present
          state: 'off'
      then:
      - service: notify.mobile_app_glphone
        metadata: {}
        data:
          message: "⚠️O portão não fechou!!!⚠️\U0001F513"
          data:
            push:
              interruption-level: critical
          title: '------------'
  - alias: cmouta notificações
    if:
    - condition:
      - condition: trigger
        id:
        - cmouta2
      - condition: state
        entity_id: cover.gate
        state: closed
      - condition: state
        entity_id: input_boolean.cmouta_present
        state: 'off'
    then:
    - service: notify.mobile_app_iphone_de_cristina_3
      data:
        data:
          tag: open-home-gate
        message: "O portão está fechado.✅\U0001F512"
        title: "\U0001F697 Ate Logo! \U0001F642"
    - delay:
        hours: 0
        minutes: 5
        seconds: 0
        milliseconds: 0
    - service: notify.mobile_app_iphone_de_cristina_3
      metadata: {}
      data:
        message: clear_notification
        data:
          tag: open-home-gate
    else:
    - if:
      - condition:
        - condition: trigger
          id:
          - cmouta2
        - condition: state
          entity_id: input_boolean.cmouta_present
          state: 'off'
      then:
      - service: notify.mobile_app_iphone_de_cristina_3
        data:
          data:
            push:
              interruption-level: critical
          message: "⚠️O portão não fechou!!!⚠️\U0001F513"
          title: '------------'
  mode: single
  max_exceeded: warning
- id: automatic_backups
  alias: Automatic Backups
  description: Automação ativada por horário (01:00:00). Usa serviço nativo backup.create
    do Home Assistant.
  trigger:
  - id: daily
    platform: time
    at: 01:00:00
  - id: hourly
    enabled: true
    platform: time_pattern
    hours: /12
  condition: []
  action:
  - if:
    - condition: trigger
      id: daily
    then:
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ enable_yearly }}'
        - condition: template
          value_template: '{{ now().day == 1 and now().month == 1 }}'
        sequence:
        - variables:
            backup_type: yearly
            keep_days: 365
        - variables:
            name: "{{ backup_type | title }}Backup: {{\n  now().strftime(\n    \"%A,
              \"\n    ~ iif(backup_type == \"hourly\", \"%-I:%M %p, \", \"\")\n    ~
              \"%B %-d, %Y\"\n  )\n}}\n{# HourlyBackup: Monday, 3:04 PM, January 2,
              2006 #}\n{# DailyBackup: Monday, January 2, 2006 #}\n"
            backup_action:
            - service: backup.create
              data:
                name: '{{ name }}'
        - if:
          - condition: template
            value_template: '{{ not use_action_hourly }}'
          - condition: template
            value_template: '{{ backup_action | length > 0 }}'
          then:
          - service: backup.create
            data:
              name: '{{ name }}'
          else:
          - alias: Creating a full backup (default action)
            service: backup.create
            data:
              name: '{{ name }}'
      - conditions:
        - condition: template
          value_template: '{{ enable_monthly }}'
        - condition: template
          value_template: '{{ now().day == 1 }}'
        sequence:
        - variables:
            backup_type: monthly
            keep_days: 90
        - variables:
            name: "{{ backup_type | title }}Backup: {{\n  now().strftime(\n    \"%A,
              \"\n    ~ iif(backup_type == \"hourly\", \"%-I:%M %p, \", \"\")\n    ~
              \"%B %-d, %Y\"\n  )\n}}\n{# HourlyBackup: Monday, 3:04 PM, January 2,
              2006 #}\n{# DailyBackup: Monday, January 2, 2006 #}\n"
            backup_action:
            - service: backup.create
              data:
                name: '{{ name }}'
        - if:
          - condition: template
            value_template: '{{ not use_action_hourly }}'
          - condition: template
            value_template: '{{ backup_action | length > 0 }}'
          then:
          - service: backup.create
            data:
              name: '{{ name }}'
          else:
          - alias: Creating a full backup (default action)
            service: backup.create
            data:
              name: '{{ name }}'
      - conditions:
        - condition: template
          value_template: '{{ enable_weekly }}'
        - condition: template
          value_template: '{{ now().weekday() == 0 }}'
        sequence:
        - variables:
            backup_type: weekly
            keep_days: 30
        - variables:
            name: "{{ backup_type | title }}Backup: {{\n  now().strftime(\n    \"%A,
              \"\n    ~ iif(backup_type == \"hourly\", \"%-I:%M %p, \", \"\")\n    ~
              \"%B %-d, %Y\"\n  )\n}}\n{# HourlyBackup: Monday, 3:04 PM, January 2,
              2006 #}\n{# DailyBackup: Monday, January 2, 2006 #}\n"
            backup_action:
            - service: backup.create
              data:
                name: '{{ name }}'
        - if:
          - condition: template
            value_template: '{{ not use_action_hourly }}'
          - condition: template
            value_template: '{{ backup_action | length > 0 }}'
          then:
          - service: backup.create
            data:
              name: '{{ name }}'
          else:
          - alias: Creating a full backup (default action)
            service: backup.create
            data:
              name: '{{ name }}'
      - conditions:
        - condition: template
          value_template: '{{ enable_daily }}'
        sequence:
        - variables:
            backup_type: daily
            keep_days: 7
        - variables:
            name: "{{ backup_type | title }}Backup: {{\n  now().strftime(\n    \"%A,
              \"\n    ~ iif(backup_type == \"hourly\", \"%-I:%M %p, \", \"\")\n    ~
              \"%B %-d, %Y\"\n  )\n}}\n{# HourlyBackup: Monday, 3:04 PM, January 2,
              2006 #}\n{# DailyBackup: Monday, January 2, 2006 #}\n"
            backup_action:
            - service: backup.create
              data:
                name: '{{ name }}'
        - if:
          - condition: template
            value_template: '{{ not use_action_hourly }}'
          - condition: template
            value_template: '{{ backup_action | length > 0 }}'
          then:
          - service: backup.create
            data:
              name: '{{ name }}'
          else:
          - alias: Creating a full backup (default action)
            service: backup.create
            data:
              name: '{{ name }}'
    else:
    - variables:
        backup_type: hourly
        keep_days: 1
    - variables:
        name: "{{ backup_type | title }}Backup: {{\n  now().strftime(\n    \"%A, \"\n
          \   ~ iif(backup_type == \"hourly\", \"%-I:%M %p, \", \"\")\n    ~ \"%B
          %-d, %Y\"\n  )\n}}\n{# HourlyBackup: Monday, 3:04 PM, January 2, 2006 #}\n{#
          DailyBackup: Monday, January 2, 2006 #}\n"
        backup_action:
        - service: backup.create
          data:
            name: '{{ name }}'
    - if:
      - condition: template
        value_template: '{{ backup_action | length > 0 }}'
      then:
      - service: backup.create
        data:
          name: '{{ name }}'
      else:
      - alias: Creating a partial backup (default action)
        service: backup.create
        data:
          name: '{{ name }}'
  mode: single
  variables:
    password: ''
    enable_hourly: true
    enable_daily: true
    enable_weekly: true
    enable_monthly: false
    enable_yearly: false
    use_action_hourly: true
  max_exceeded: warning
- id: luz_exterior_auto
  alias: "\U0001F4A1Luz Exterior Auto"
  description: Automação do Home Assistant.
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.shelly_b_0114_window
      light_switch:
        entity_id: light.exterior
      time_delay: 10
      include_sun: sun_enabled
      night_lights_conditions: []
  mode: single
  max_exceeded: warning
- id: notify_when_garage_door_was_left_open_for_too_long
  alias: "[\U0001F4E3\U0001F3E1] Notify when garage door was left open for too long"
  description: Automação do Home Assistant.
  triggers:
  - entity_id:
    - cover.gate
    to: open
    for:
      hours: 0
      minutes: 5
      seconds: 0
    from: closed
    trigger: state
  conditions: []
  actions:
  - repeat:
      sequence:
      - metadata: {}
        data:
          filename: /config/www/camera_snapshots/mysnap_portao.jpg
        action: camera.snapshot
        target:
          entity_id: camera.portao_hd_stream
      - metadata: {}
        data:
          message: Está aberto a mais de 5 minutos. Fechar?
          title: "\U0001F699\U0001F6A8 Portão de casa aberto!\U0001F6A8"
        action: telegram_bot.send_message
      - metadata: {}
        data:
          authentication: digest
          file: /config/www/camera_snapshots/mysnap_portao.jpg
        action: telegram_bot.send_photo
      - data:
          title: "\U0001F699 Portão de casa aberto!"
          message: Está aberto a mais de 5 minutos. Fechar?
        action: notify.notify
        enabled: true
      - delay:
          hours: 0
          minutes: 5
          seconds: 0
          milliseconds: 0
      while:
      - condition: state
        entity_id: cover.gate
        state: open
  - metadata: {}
    data:
      filename: /config/www/camera_snapshots/mysnap_portao.jpg
    action: camera.snapshot
    target:
      entity_id: camera.portao_hd_stream
  - metadata: {}
    data:
      message: O portão está fechado.
      title: "\U0001F699✅Portão de casa fechado.✅"
    action: telegram_bot.send_message
  - metadata: {}
    data:
      authentication: digest
      file: /config/www/camera_snapshots/mysnap_portao.jpg
    action: telegram_bot.send_photo
  - data:
      title: "\U0001F699✅Portão de casa fechado.✅"
      message: O portão está fechado.
    action: notify.notify
    enabled: true
  mode: single
  max_exceeded: warning
- id: cascata
  alias: "\U0001F3CA\U0001F3FB Piscina - Cascata"
  description: Inicia ou para a Cascata na piscina com 1 click no botão shelly
  triggers:
  - device_id: 50eb20ac53472c3cc1b1da733634d1c8
    domain: bthome
    type: button
    subtype: press
    trigger: device
  conditions: []
  actions:
  - type: toggle
    device_id: ed7ccde197e708b2a6b6cd25ef2e60c5
    entity_id: 44b25a719c3fa50cbbd4ebd6e57fcdb9
    domain: switch
    enabled: true
  mode: single
  max_exceeded: warning
- id: hidrojet
  alias: "\U0001F3CA\U0001F3FB Piscina - Hidrojet"
  description: Automação do Home Assistant.
  triggers:
  - device_id: 50eb20ac53472c3cc1b1da733634d1c8
    domain: bthome
    type: button
    subtype: double_press
    trigger: device
  conditions: []
  actions:
  - if:
    - condition: device
      type: is_off
      device_id: 8be4eb1cd22d4bd03d7c70c99e84930b
      entity_id: a282d1ef3a0591beb9ddf1392c8e3e42
      domain: switch
    then:
    - type: turn_off
      device_id: d752f893fd0bb44490ec4bfcb83c333f
      entity_id: ae742d0d2f0dc5dea53a674346911926
      domain: switch
    - data:
        stop_actions: true
      target:
        entity_id: automation.bomba_piscina_dia
      action: automation.turn_off
    - delay:
        hours: 0
        minutes: 0
        seconds: 5
        milliseconds: 0
    - type: turn_on
      device_id: 8be4eb1cd22d4bd03d7c70c99e84930b
      entity_id: a282d1ef3a0591beb9ddf1392c8e3e42
      domain: switch
    - repeat:
        sequence:
        - delay:
            hours: 0
            minutes: 0
            seconds: 30
            milliseconds: 0
        while:
        - condition: device
          type: is_on
          device_id: 8be4eb1cd22d4bd03d7c70c99e84930b
          entity_id: a282d1ef3a0591beb9ddf1392c8e3e42
          domain: switch
    - data: {}
      target:
        entity_id: automation.bomba_piscina_dia
      action: automation.turn_on
    else:
    - type: turn_off
      device_id: 8be4eb1cd22d4bd03d7c70c99e84930b
      entity_id: a282d1ef3a0591beb9ddf1392c8e3e42
      domain: switch
    - data: {}
      target:
        entity_id: automation.bomba_piscina_dia
      action: automation.turn_on
  mode: restart
- id: change_charge_completion_time
  alias: "\U0001F50B\U0001F697⚡Change charge completion time"
  description: Automação ativada por mudança de estado em ['sensor.ev_smart_charging_charging'].
  trigger:
  - platform: state
    entity_id:
    - sensor.ev_smart_charging_charging
    attribute: raw_two_days
  condition: []
  action:
  - if:
    - condition: time
      after: 00:00:00
      before: 00:00:00
      weekday:
      - sat
      - fri
    then:
    - service: select.select_option
      metadata: {}
      data:
        option: None
      target:
        entity_id: select.ev_smart_charging_charge_completion_time
    - service: switch.turn_off
      metadata: {}
      data: {}
      target:
        entity_id: switch.ev_smart_charging_continuous_charging_preferred
    else:
    - service: select.select_option
      metadata: {}
      data:
        option: 08:00
      target:
        entity_id: select.ev_smart_charging_charge_completion_time
    - service: switch.turn_on
      metadata: {}
      data: {}
      target:
        entity_id: switch.ev_smart_charging_continuous_charging_preferred
  mode: single
  max_exceeded: warning
- id: sala_baixar_estores_sunset
  alias: "\U0001F6CB️ Sala: Baixar Estores Sunset"
  description: Baixar os estores quando o sol se põe
  trigger:
  - platform: sun
    event: sunset
    offset: -00:15:00
  condition: []
  action:
  - if:
    - condition: state
      entity_id: group.alguem_em_casa
      state: home
    then:
    - service: cover.close_cover
      metadata: {}
      data: {}
      target:
        entity_id:
        - cover.estore_3_estore_3
    - service: light.turn_on
      metadata: {}
      data: {}
      target:
        entity_id: light.candeeiros_sala_inferior
    - delay:
        hours: 0
        minutes: 0
        seconds: 5
        milliseconds: 0
    - service: cover.close_cover
      metadata: {}
      data: {}
      target:
        entity_id: cover.estore_2_estore_2
    else:
    - service: cover.close_cover
      metadata: {}
      data: {}
      target:
        entity_id:
        - cover.estore_3_estore_3
    - delay:
        hours: 0
        minutes: 0
        seconds: 5
        milliseconds: 0
    - service: cover.close_cover
      metadata: {}
      data: {}
      target:
        entity_id: cover.estore_2_estore_2
  mode: single
  max_exceeded: warning
- id: sala_subir_estores_manha
  alias: "\U0001F6CB️ Sala: Subir estores manhã"
  description: Subir os estores quando as 07:45
  trigger:
  - at: 07:45:00
    trigger: time
  conditions: []
  action:
  - service: cover.open_cover
    metadata: {}
    data: {}
    target:
      entity_id: cover.estores
  mode: single
  max_exceeded: warning
- id: luz_corredor_auto
  alias: "\U0001F4A1Luz Corredor auto"
  description: Automação do Home Assistant.
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      motion_trigger:
      - binary_sensor.bthome_sensor_9179_motion
      - binary_sensor.corredor_superior_corredor_superior_motion_alarm
      light_switch:
        entity_id:
        - light.shellyplus2pm_c82e180d5f10_switch_1
      include_sun: sun_enabled
      ambient_light_sensor: sensor.shelly_b_0114_illuminance
      include_ambient: ambient_enabled
  mode: single
  max_exceeded: warning
- id: update_coopernico_prices
  alias: Update Coopernico Prices
  description: Automação do Home Assistant.
  trigger:
  - platform: time_pattern
    minutes: /5
  condition: []
  action:
  - service: homeassistant.update_entity
    data: {}
    target:
      entity_id: sensor.coopernico_prices
  - service: homeassistant.update_entity
    data: {}
    target:
      entity_id: sensor.coopernico_injection
  mode: single
  max_exceeded: warning
- id: luz_escadas_superior_auto
  alias: "\U0001F4A1Luz Escadas Superior Auto"
  description: Automação do Home Assistant.
  use_blueprint:
    path: Blackshome/sensor-light.yaml
    input:
      light_switch:
        entity_id: light.luzes_sala_superior_channel_1
      motion_trigger:
      - binary_sensor.motion_sensor_z_wave_plus_motion_sensor_z_wave_plus_motion_alarm
      include_sun: sun_enabled
      include_ambient: ambient_disabled
      ambient_light_sensor: sensor.motion_sensor_z_wave_plus_motion_sensor_z_wave_plus_luminance
      ambient_light_options: ambient_light_option_enabled
  mode: single
  max_exceeded: warning
- id: ups_-_notification
  alias: "\U0001F50BUPS - Notification"
  description: Automação do Home Assistant.
  trigger:
  - entity_id:
    - sensor.mclima_ups_informacao_do_estado
    - sensor.net_ups_informacao_do_estado
    id: battery
    trigger: state
    for:
      hours: 0
      minutes: 1
      seconds: 0
    to: OB DISCHRG
  - entity_id:
    - sensor.mclima_ups_informacao_do_estado
    - sensor.net_ups_informacao_do_estado
    to: OL CHRG
    id: online
    trigger: state
  - entity_id:
    - sensor.mclima_ups_informacao_do_estado
    - sensor.net_ups_informacao_do_estado
    id: replace_battery
    trigger: state
    for:
      hours: 0
      minutes: 5
      seconds: 0
    to: ALARM OL RB
  - entity_id:
    - sensor.mclima_ups_informacao_do_estado
    - sensor.net_ups_informacao_do_estado
    id: replace_battery
    trigger: state
    for:
      hours: 0
      minutes: 5
      seconds: 0
    to: ALARM OL CHRH RB
  conditions: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: battery
      sequence:
      - service: notify.mobile_app_glphone
        data:
          message: "A UPS está em modo de bateria!!! \U0001F50B"
          title: "\U0001F6A8Energia"
          data:
            push:
              interruption-level: time-sensitive
              sound:
                name: default
                critical: 1
                volume: 1
    - conditions:
      - condition: trigger
        id: online
      sequence:
      - service: notify.mobile_app_glphone
        data:
          message: "A UPS já está online.\U0001F50B⚡"
          title: ✅Energia
    - conditions:
      - condition: trigger
        id:
        - replace_battery
      sequence:
      - service: notify.mobile_app_glphone
        data:
          title: ❗Trocar baterias na UPS.❗
          message: As baterias da UPS têm de ser substituías.
  mode: single
  max_exceeded: warning
- id: bomba_de_calor_power_mqtt_publish
  alias: ♨️ Bomba de Calor Power MQTT Publish
  description: Automação do Home Assistant.
  trigger:
  - platform: time_pattern
    seconds: /10
    enabled: true
  conditions: []
  action:
  - service: mqtt.publish
    metadata: {}
    data:
      evaluate_payload: false
      qos: '2'
      topic: homeassistant/sensor/heating
      payload: '"{{ states(''sensor.hpsu_can_heating_emoncms'') }}"'
  - service: mqtt.publish
    metadata: {}
    data:
      qos: '2'
      topic: homeassistant/sensor/dhw
      payload: '"{{ states(''sensor.hpsu_can_dhw_emoncms'') }}"'
  - service: mqtt.publish
    metadata: {}
    data:
      evaluate_payload: false
      qos: '2'
      topic: homeassistant/sensor/t_outside
      payload: '"{{ states(''sensor.hpsu_can_outside_temperature'') }}"'
  - service: mqtt.publish
    metadata: {}
    data:
      evaluate_payload: false
      qos: '2'
      topic: homeassistant/sensor/target_room_temp
      payload: '"{{ states(''sensor.hspu_can_target_room_emoncms'') }}"'
  - service: mqtt.publish
    metadata: {}
    data:
      evaluate_payload: false
      qos: '2'
      topic: homeassistant/sensor/bomba_de_calor_flow_rate
      payload: '"{{ states(''sensor.hpsu_can_flow_rate'') }}"'
  - service: mqtt.publish
    metadata: {}
    data:
      evaluate_payload: false
      qos: '2'
      topic: homeassistant/sensor/thermal_power
      payload: '"{{ states(''sensor.hpsu_can_thermal_power_2'') }}"'
  - service: mqtt.publish
    metadata: {}
    data:
      evaluate_payload: false
      qos: '2'
      topic: homeassistant/sensor/flow_temperature_tv
      payload: '"{{ states(''sensor.hpsu_can_flow_temperature_tv'') }}"'
  - service: mqtt.publish
    metadata: {}
    data:
      evaluate_payload: false
      qos: '2'
      topic: homeassistant/sensor/flow_return_temperature_heating
      payload: '"{{ states(''sensor.hpsu_can_return_temperature_heating'') }}"'
  mode: single
  max_exceeded: warning
- id: mqtt_publish
  alias: MQTT  Publish
  description: Automação ativada por mudança de estado em ['sensor.bmw_x1_charging_w_2'],
    mudança de estado em ['sensor.bmw_i4_charging_w'].
  trigger:
  - platform: state
    entity_id:
    - sensor.bmw_x1_charging_w_2
    id: '1'
  - platform: state
    entity_id:
    - sensor.bmw_i4_charging_w
    id: '2'
  conditions: []
  action:
  - if:
    - condition: trigger
      id:
      - '1'
    then:
    - service: mqtt.publish
      metadata: {}
      data:
        evaluate_payload: false
        qos: '2'
        topic: homeassistant/sensor/ev/bmwx1_charging_w
        payload: '"{{ states(''sensor.bmw_x1_charging_w_2'') | float(0) | round(0)
          }}"'
  - if:
    - condition: trigger
      id:
      - '2'
    then:
    - service: mqtt.publish
      metadata: {}
      data:
        evaluate_payload: false
        qos: '2'
        topic: homeassistant/sensor/ev/bmwi4_charging_w
        payload: '"{{ states(''sensor.bmw_i4_charging_w'') | float(0) | round(0) }}"'
  mode: single
  max_exceeded: warning
- id: openai_daily_environmental_notification
  alias: 'OpenAI Daily: Environmental Notification'
  description: Automação do Home Assistant.
  trigger:
  - at: 08:05:00
    trigger: time
  - at: '12:40:00'
    trigger: time
  - at: '18:30:00'
    trigger: time
  conditions: []
  action:
  - alias: 'Call a service ''Weather: Get Forecast'''
    action: weather.get_forecasts
    target:
      entity_id: weather.forecast_home
    data:
      type: daily
    response_variable: daily_forecast
  - data:
      agent_id: conversation.chatgpt
      text: '"Para esta tarefa, es um consultor meteorológico e es responsavel por
        garantir a qualidade do ar no interior da casa. Please provide your thoughts
        on our indoor air quality as it relates to the weather outside and our current
        heating / cooling system settings.  Podes e deves usar um tom humorista. Podes
        usar emojis. Responde em portugues de portugal sem gerúndio.  \_ Current time
        {{now()}} Current thermostat setting {{states(''select.hpsu_can_target_room_1_temperature'')}}
        Current Home temperature {{states(''sensor.emoncms_home_temperature'')}} °C
        Current Home average temperature is {{states(''sensor.casa_temperatura_media'')}}
        °C Current Home average humidity is {{states(''sensor.casa_humidade_media_relativa'')}}
        % Exterior Weather Data Temperature is {{ states(''sensor.bthome_sensor_6a2b_temperature'')
        }} °C Exterior Feels like temperature is {{ states(''sensor.home_temperatura_aparente'')
        }} °C Exterior Weather Data Humidity is {{ states(''sensor.bthome_sensor_6a2b_humidity'')
        }} % Current Rain Intensity {{ states(''sensor.home_precipitacao'') }} mm/h
        Forecasted Conditions for Today {{states(''sensor.home_condicao_dia_0'')}}
        Forecasted High Tempterature for Today {{states(''sensor.home_temperatura_max_realfeel_dia_0'')}}
        °C Forecasted Low Temperature for Today {{states(''sensor.home_temperatura_min_realfeel_dia_0'')}}
        °C'
      language: pt-pt
    enabled: true
    response_variable: agent
    action: conversation.process
  - service: telegram_bot.send_message
    metadata: {}
    data:
      title: Qualidade do Ar em Casa
      message: '{{agent.response.speech.plain.speech}}'
  mode: single
  max_exceeded: warning
- id: candeeiros_ligardesligar
  alias: "\U0001F4A1Candeeiros Ligar/Desligar"
  description: Automação do Home Assistant.
  trigger:
  - device_id: e8a6c706997d87b98183e26e7598ae8b
    domain: shelly
    type: single
    subtype: button
    trigger: device
  - device_id: d686deeba13232cfa6ab008fa8c80dc0
    domain: bthome
    type: button_1
    subtype: press
    trigger: device
  conditions: []
  action:
  - service: light.toggle
    metadata: {}
    data: {}
    target:
      entity_id: light.candeeiros_sala_inferior
  mode: single
  max_exceeded: warning
- id: desligar_tudo_sala
  alias: 'Desligar tudo Sala '
  description: Automação do Home Assistant.
  trigger:
  - device_id: e8a6c706997d87b98183e26e7598ae8b
    domain: shelly
    type: long
    subtype: button
    trigger: device
  - device_id: d686deeba13232cfa6ab008fa8c80dc0
    domain: bthome
    type: button_1
    subtype: long_press
    trigger: device
  conditions: []
  action:
  - service: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - light.sala_inferior
  - service: media_player.turn_off
    metadata: {}
    data: {}
    target:
      device_id: a5dd3a6582b27b004323486771a64137
  - service: light.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: light.shellyplus2pm_c82e180d5f10_switch_1
  - delay:
      hours: 0
      minutes: 1
      seconds: 0
      milliseconds: 0
  - service: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: light.shellyplus2pm_c82e180d5f10_switch_1
  mode: single
  max_exceeded: warning
- id: heat_pump_error
  alias: ♨️ Heat Pump Error
  description: Automação ativada por mudança de estado em ['sensor.hpsu_can_error_code'],
    mudança de estado em ['sensor.hpsu_can_error_code'].
  trigger:
  - platform: state
    entity_id:
    - sensor.hpsu_can_error_code
    from: No Error
    id: Error
  - platform: state
    entity_id:
    - sensor.hpsu_can_error_code
    id: ok
    to: No Error
  conditions: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Error
      sequence:
      - service: telegram_bot.send_message
        metadata: {}
        data:
          message: 'A bomba de calor está em Erro.

            *ERROR:* {{states(''sensor.hpsu_can_error_code'') }}

            '
          title: ❌ Error Bomba de Calor ❌
    - conditions:
      - condition: trigger
        id:
        - ok
      sequence:
      - service: telegram_bot.send_message
        metadata: {}
        data:
          message: 'A bomba de calor está em {{states(''sensor.hpsu_can_error_code'')
            }}

            '
          title: ✅ OK Bomba de Calor ✅
  mode: single
  max_exceeded: warning
- id: hot_water_production_best_price
  alias: ♨️ Hot Water Production Best price
  description: Automação do Home Assistant.
  trigger:
  - at: sensor.aquecimento_agua_noite
    trigger: time
  condition:
  - type: is_temperature
    condition: device
    device_id: dbbed3fc0849f129296b804033d10b74
    entity_id: 869298e5bb3f09e40bb45c5ab1d10091
    domain: sensor
    below: 45
  action:
  - device_id: dbbed3fc0849f129296b804033d10b74
    domain: select
    entity_id: aa534d8176126b2ad55749fb0cc47992
    type: select_option
    option: 'On'
  mode: single
  max_exceeded: warning
- id: botao_sala_estore1
  alias: "\U0001FA9FBotão Sala Estore1 "
  description: Automação do Home Assistant.
  trigger:
  - device_id: e8a6c706997d87b98183e26e7598ae8b
    domain: shelly
    type: double
    subtype: button
    trigger: device
  conditions: []
  action:
  - service: cover.toggle
    metadata: {}
    data: {}
    target:
      entity_id: cover.estore1_cover_0
  mode: single
  max_exceeded: warning
- id: atualizar_ph_filtrado_com_bomba_ligada
  alias: "\U0001F3CA\U0001F3FB Piscina - Atualizar pH filtrado com bomba ligada"
  description: Automação do Home Assistant.
  triggers:
  - entity_id:
    - switch.bomba_piscina_switch_0
    to: 'on'
    trigger: state
    id: bomba
    from: 'off'
  - entity_id: sensor.ph_corrigido
    trigger: state
    enabled: true
  - minutes: /5
    trigger: time_pattern
  conditions:
  - condition: state
    entity_id: switch.bomba_piscina_switch_0
    state: 'on'
    for:
      hours: 0
      minutes: 10
      seconds: 0
  - condition: template
    value_template: '{{ states(''sensor.ph_corrigido'') not in [''unavailable'', ''unknown'']
      }}'
  actions:
  - target:
      entity_id:
      - input_number.ph_sensor_filtrado
    data:
      value: '{{ states(''sensor.ph_sensor'') | float(2) }}'
    action: input_number.set_value
  - target:
      entity_id: input_number.ph_filtrado
    data:
      value: '{{ states(''sensor.ph_corrigido'') | float(2) }}'
    action: input_number.set_value
  mode: single
  max_exceeded: warning
- id: atualiza_media_de_nuvens_nas_proximas_8h
  alias: ☁️Atualiza média de nuvens nas próximas 8h
  description: Automação do Home Assistant.
  trigger:
  - hours: /1
    trigger: time_pattern
  action:
  - target:
      entity_id: weather.forecast
    data:
      type: hourly
    response_variable: forecast
    action: weather.get_forecasts
  - variables:
      clouds: "{{ forecast['weather.forecast']['forecast'][:8]\n   | map(attribute='cloud_coverage')\n
        \  | reject('none')\n   | list }}\n"
      avg_clouds: "{% if clouds | length > 0 %}\n  {{ (clouds | map('float') | sum
        / clouds | length)\n     | round(1) }}\n{% else %}\n  0\n{% endif %}\n"
  - data:
      entity_id: input_number.average_cloud_cover
      value: '{{ avg_clouds }}'
    action: input_number.set_value
  mode: single
  max_exceeded: warning
- id: atualiza_media_de_nuvens_entre_as_1000_e_as_1800
  alias: ☁️Atualiza média de nuvens entre as 10:00 e as 18:00
  description: Automação do Home Assistant.
  trigger:
  - hours: /1
    trigger: time_pattern
  conditions: []
  action:
  - if:
    - condition: time
      after: 00:00:00
      before: '19:00:00'
    then:
    - target:
        entity_id: weather.forecast
      data:
        type: hourly
      response_variable: forecast
      action: weather.get_forecasts
    - variables:
        entries: '{{ forecast[''weather.forecast''][''forecast''] }}

          '
        start: '{{ utcnow().replace(hour=10, minute=0, second=0, microsecond=0).isoformat(sep=''T'')
          }}

          '
        end: '{{ utcnow().replace(hour=18, minute=0, second=0, microsecond=0).isoformat(sep=''T'')
          }}

          '
        clouds: "{{ entries\n   | selectattr('datetime', '>=', start)\n   | selectattr('datetime',
          '<=', end)\n   | map(attribute='cloud_coverage')\n   | reject('none')\n
          \  | list }}\n"
        avg_clouds: "{% if clouds | length > 0 %}\n  {{ (clouds | map('float') | sum
          / clouds | length) | round(1) }}\n{% else %}\n  0\n{% endif %}\n"
    - data:
        entity_id: input_number.average_cloud_cover_piscina
        value: '{{ avg_clouds }}'
      action: input_number.set_value
    else:
    - target:
        entity_id: weather.forecast
      data:
        type: hourly
      response_variable: forecast
      action: weather.get_forecasts
    - variables:
        entries: '{{ forecast[''weather.forecast''][''forecast''] }}

          '
        start: '{{ (utcnow() + timedelta(days=1)).replace(hour=10, minute=0, second=0,
          microsecond=0).isoformat(sep=''T'') }}

          '
        end: '{{ (utcnow() + timedelta(days=1)).replace(hour=18, minute=0, second=0,
          microsecond=0).isoformat(sep=''T'') }}

          '
        clouds: "{{ entries\n   | selectattr('datetime', '>=', start)\n   | selectattr('datetime',
          '<=', end)\n   | map(attribute='cloud_coverage')\n   | reject('none')\n
          \  | list }}\n"
        avg_clouds: "{% if clouds | length > 0 %}\n  {{ (clouds | map('float') | sum
          / clouds | length) | round(1) }}\n{% else %}\n  0\n{% endif %}\n"
    - data:
        entity_id: input_number.average_cloud_cover_piscina
        value: '{{ avg_clouds }}'
      action: input_number.set_value
  mode: single
  max_exceeded: warning
- id: bomba_peristaltica
  alias: "\U0001F3CA\U0001F3FB Piscina - Bomba Peristaltica"
  description: Automação ativada por mudança de estado em ['switch.bomba_piscina_switch_0'].
  triggers:
  - entity_id:
    - switch.bomba_piscina_switch_0
    trigger: state
  - minutes: /5
    trigger: time_pattern
  conditions:
  - condition: device
    type: is_on
    device_id: d752f893fd0bb44490ec4bfcb83c333f
    entity_id: ae742d0d2f0dc5dea53a674346911926
    domain: switch
  actions:
  - if:
    - condition: device
      type: is_on
      device_id: d752f893fd0bb44490ec4bfcb83c333f
      entity_id: ae742d0d2f0dc5dea53a674346911926
      domain: switch
    - condition: numeric_state
      entity_id: sensor.ph_corrigido_filtrado
      above: 7.5
      enabled: false
    then:
    - metadata: {}
      data: {}
      target:
        entity_id:
        - switch.bomba_peristaltica_switch_0
      action: switch.turn_on
    else:
    - metadata: {}
      data: {}
      target:
        entity_id:
        - switch.bomba_peristaltica_switch_0
      action: switch.turn_off
  mode: single
  max_exceeded: warning
- id: abrir_estore_1
  alias: "\U0001FA9FAbrir Estore 1"
  description: Automação do Home Assistant.
  trigger:
  - device_id: d686deeba13232cfa6ab008fa8c80dc0
    domain: bthome
    type: button_3
    subtype: press
    trigger: device
  conditions: []
  action:
  - if:
    - condition: device
      device_id: cfd18037256cb019fa29781e93e644d7
      domain: cover
      entity_id: 8749320a26b0fe2753d119e46c5cba27
      type: is_opening
    then:
    - service: cover.stop_cover
      metadata: {}
      data: {}
      target:
        entity_id: cover.estore1_cover_0
    else:
    - service: cover.open_cover
      metadata: {}
      data: {}
      target:
        entity_id: cover.estore1_cover_0
  mode: single
  max_exceeded: warning
- id: fechar_estore_1
  alias: "\U0001FA9FFechar Estore 1"
  description: Automação do Home Assistant.
  trigger:
  - device_id: d686deeba13232cfa6ab008fa8c80dc0
    domain: bthome
    type: button_4
    subtype: press
    trigger: device
  conditions: []
  action:
  - if:
    - condition: device
      device_id: cfd18037256cb019fa29781e93e644d7
      domain: cover
      entity_id: 8749320a26b0fe2753d119e46c5cba27
      type: is_closing
    then:
    - service: cover.stop_cover
      metadata: {}
      data: {}
      target:
        entity_id: cover.estore1_cover_0
    else:
    - service: cover.close_cover
      metadata: {}
      data: {}
      target:
        entity_id: cover.estore1_cover_0
  mode: single
  max_exceeded: warning
- id: '1770157306813'
  alias: "\U0001F3CA Piscina - Controlo Solar Inteligente v4 (PT)"
  description: ''
  use_blueprint:
    path: piscina_solar/piscina_solar_control_v4.yaml
    input:
      pump_switch: switch.bomba_piscina_switch_0
      pump_actual_power: sensor.bomba_piscina_switch_0_power
      net_power_5min: sensor.import_export_5min_smooth
      pv_power_5min: sensor.solar_power_5min_smooth
      net_power: sensor.emoncms_import_export
      export_power: sensor.emoncms_import_export
      export_power_5min: sensor.energy_export_average_5_minutes
      house_power_no_pump: sensor.bomba_piscina_switch_0_power
      pv_power: sensor.emoncms_solar
      use_dynamic_filtration_time: true
      dynamic_filtration_hours_sensor: sensor.piscina_tempo_de_filtracao_recomendado
      filtration_energy_today: sensor.emoncms_192_168_1_250_piscina_bomba_kwhd
      filtration_remaining: sensor.pool_pump_remaining_time
      forecast_tomorrow: sensor.solcast_pv_forecast_forecast_tomorrow
      delay_multiplier_sensor: sensor.piscina_weather_delay_multiplier
      override_manual: input_boolean.piscina_override_manual
      house_power_no_pump_5min: sensor.house_power_5min_smooth
      night_session_lock: input_boolean.piscina_night_session_done
      enable_debug_logs: true
      ignore_filtration_limit: true
      enable_night_auto: true
      dry_run_mode: true
      import_limit_strategy: break_even
- id: '1770406940770'
  alias: "\U0001F50B Alerta Semanal - Baterias Baixas"
  description: Envia notificação via Telegram todas as segundas-feiras às 09:00 com
    lista de dispositivos com bateria abaixo de 20%. Criado via MCP para manutenção
    proativa.
  triggers:
  - platform: time
    at: 09:00:00
  conditions:
  - condition: time
    weekday:
    - mon
  - condition: template
    value_template: '{{ states.sensor | selectattr(''attributes.device_class'', ''eq'',
      ''battery'') | selectattr(''state'', ''is_number'') | map(attribute=''state'')
      | map(''float'') | select(''lt'', 20) | list | count > 0 }}'
  actions:
  - data:
      title: "\U0001F50B Baterias Baixas Detectadas"
      message: "{% set low_batteries = states.sensor | selectattr('attributes.device_class',
        'eq', 'battery') | selectattr('state', 'is_number') | map(attribute='entity_id')
        | select('match', '^sensor\\\\..*') | list %}\n{% set batteries = namespace(items=[])
        %}\n{% for entity in low_batteries %}\n  {% set battery_level = states(entity)
        | float(0) %}\n  {% if battery_level < 20 and battery_level > 0 %}\n    {%
        set device_name = state_attr(entity, 'friendly_name') | replace(' Battery',
        '') | replace(' Bateria', '') | replace(' battery', '') %}\n    {% set batteries.items
        = batteries.items + [(device_name, battery_level)] %}\n  {% endif %}\n{% endfor
        %}\n{% if batteries.items | length > 0 %}\nDispositivos com bateria baixa:\n{%
        for name, level in batteries.items | sort(attribute='1') %}\n• {{ name }}:
        {{ level }}%\n{% endfor %}\n\nTotal: {{ batteries.items | length }} dispositivo(s)\n{%
        else %}\nNenhum dispositivo com bateria baixa.\n{% endif %}"
    action: telegram_bot.send_message
  mode: single
- id: '1770770094517'
  alias: "\U0001F3CA Piscina - Controlo Solar Inteligente v5 (PT)"
  description: ''
  use_blueprint:
    path: piscina_solar/piscina_solar_control_v5.yaml
    input:
      pump_switch: switch.bomba_piscina_switch_0
      use_coopernico_optimization: true
      coopernico_price_sensor: sensor.coopernico_base_bi_horario_ciclo_diario_all_prices
      net_power_5min: sensor.import_export_5min_smooth
      house_power_no_pump_5min: sensor.house_power_5min_smooth
      pv_power_5min: sensor.solar_power_5min_smooth
      export_power_5min: sensor.export_power_5min_smooth
      net_power: sensor.emoncms_import_export
      pv_power: sensor.emoncms_solar
      export_power: sensor.emoncms_export_power_positive
      dynamic_filtration_hours_sensor: sensor.piscina_tempo_de_filtracao_recomendado
      filtration_energy_today: sensor.energia_bomba_piscina_hoje
      override_manual: input_boolean.piscina_override_manual
      enable_debug_logs: true
      dry_run_mode: true
      enable_night_auto: true
      house_power_no_pump: sensor.emoncms_192_168_1_250_use_no_pool_pump
- id: '1770771945821'
  alias: "\U0001F3CA Piscina - Controlo Solar Inteligente v6 HÍBRIDO (PT)"
  description: 'Modo híbrido: Solar DIA + Coopernico NOITE. Combina v4+v5 numa automação
    completa.'
  use_blueprint:
    path: piscina_solar/piscina_solar_control_v6.yaml
    input:
      pump_switch: switch.bomba_piscina_switch_0
      pump_nominal_power: 1380
      hybrid_mode_enabled: true
      use_coopernico_optimization: true
      coopernico_price_sensor: sensor.coopernico_base_bi_horario_ciclo_diario_all_prices
      cheapest_window_helper: input_datetime.piscina_hora_agendada_mais_barata
      coopernico_end_helper: input_datetime.piscina_fim_janela_coopernico
      night_session_active_helper: input_boolean.piscina_sessao_noturna_ativa
      calculation_info_helper: input_text.piscina_ultima_janela_calculada
      calculation_time: '19:00:00'
      net_power_5min: sensor.import_export_5min_smooth
      house_power_no_pump_5min: sensor.house_power_5min_smooth
      pv_power_5min: sensor.solar_power_5min_smooth
      export_power_5min: sensor.export_power_5min_smooth
      net_power: sensor.emoncms_import_export
      house_power_no_pump: sensor.emoncms_192_168_1_250_use_no_pool_pump
      pv_power: sensor.emoncms_solar
      export_power: sensor.emoncms_export_power_positive
      use_dynamic_filtration_time: true
      dynamic_filtration_hours_sensor: sensor.piscina_tempo_de_filtracao_recomendado
      filtration_energy_today: sensor.energia_bomba_piscina_hoje
      filtration_hours_today_sensor: sensor.piscina_horas_on_08_08
      ignore_filtration_limit: true
      min_night_deficit_kwh: 2
      enable_night_auto: true
      night_start_time: '22:00:00'
      night_end_time: 08:00:00
      use_economic_optimization: true
      price_peak: 0.1537
      price_offpeak: 0.0929
      import_limit: 700
      start_margin: 100
      import_limit_strategy: maior
      delay_on: 60
      delay_off: 90
      min_on_time: 10
      min_off_time: 5
      sun_offset_start: 30
      sun_offset_end: -30
      override_manual: input_boolean.piscina_override_manual
      enable_debug_logs: true
      dry_run_mode: false
      pump_actual_power: sensor.bomba_piscina_switch_0_power
      filtration_remaining: sensor.pool_pump_remaining_time
      delay_multiplier_sensor: sensor.piscina_weather_delay_multiplier
